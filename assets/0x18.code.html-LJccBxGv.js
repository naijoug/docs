import{_ as p}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as c,o as i,c as l,a as t,b as n,e as s,d as e,f as o}from"./app-HKAFCGrh.js";const u={},d=n("h2",{id:"reference",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#reference","aria-hidden":"true"},"#"),s(" reference")],-1),r=n("a",{href:"%E2%9C%85"},null,-1),k={href:"https://zhuanlan.zhihu.com/p/98432137",target:"_blank",rel:"noopener noreferrer"},v=n("a",{href:""},null,-1),m={href:"https://kingcos.me/posts/2019/nsobject_in_ios",target:"_blank",rel:"noopener noreferrer"},b=n("a",{href:"%E2%9C%85"},null,-1),h={href:"https://juejin.cn/post/6844903728311435271",target:"_blank",rel:"noopener noreferrer"},g=o("<blockquote><p>作者首先运行了代码，发现尽然神奇输出了，于是开始进一步研究 👉🏻 首先根据 <code>runtime</code> 源码分析确定了 <code>cls</code> 是就是指向类对象的一个指针 👉🏻 进一步研究一个类的内存布局，根据字段大小，类根据类指针偏移内存进行获取值 👉🏻 而 <code>cls</code> 在函数类是分配在栈上，栈上地址是从高往低分布，先入栈的地址大。 👉🏻 根据 <code>viewDidLoad</code> 调用时的栈数据会先将 <code>self</code>(刚好 <code>name</code> 属性是一个 <code>NSString</code> 类型，大小为 8 字节) 压入栈，所以会打印出 <code>ViewController</code> 类名。</p></blockquote>",1),f=n("a",{href:"%E2%9C%85"},"💯",-1),w={href:"https://blog.sunnyxx.com/2014/11/06/runtime-nuts",target:"_blank",rel:"noopener noreferrer"},y=n("a",{href:""},null,-1),q={href:"https://juejin.cn/post/6844903569322164232",target:"_blank",rel:"noopener noreferrer"},x=n("a",{href:"%E2%9C%85"},null,-1),_={href:"https://nemocdz.github.io/post/%E4%BB%8E%E4%B8%80%E9%81%93%E7%BD%91%E6%98%93%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B5%85%E8%B0%88-objective-c-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/",target:"_blank",rel:"noopener noreferrer"},j=n("blockquote",null,[n("p",null,[s("作者通过调试代码，通过崩溃堆栈发现了是 "),n("code",null,"objc_release"),s("，确认了是内存地址多次释放造成的。 👉🏻 进而进一步研究 "),n("code",null,"runtime"),s(" 源码中的 "),n("code",null,"objc_storeStrong"),s(" 对强引用类型的数据的存储 👉🏻 根据里面的存储逻辑，发现了多线程并发中的可能存在重复多次释放旧值的情况。 👉🏻 最后作者进一步研究怎么解决这个崩溃，一共给出四种解决方案。")])],-1),S=o(`<hr><h2 id="objective-c" tabindex="-1"><a class="header-anchor" href="#objective-c" aria-hidden="true">#</a> Objective-C</h2><h3 id="❓0x01-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0x01-下面代码输出结果" aria-hidden="true">#</a> ❓0x01 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@property</span> <span class="token punctuation">(</span>atomic<span class="token punctuation">)</span> NSInteger i<span class="token punctuation">;</span>
<span class="token comment">// 多线程中</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>属性 <code>i</code> 并不能保证以线程安全的方式递增。<code>atomic</code> 只能保证属性的 <code>getter</code> 和 <code>setter</code> 方法在被调用时不会被其他线程打断，并不能保证像 <code>self.i++</code> 这样的复合操作是线程安全的。</p><p><code>self.i++</code> 实际上包含了三个操作：</p><ul><li>获取 <code>i</code> 的值</li><li>将获取到的值加一</li><li>将新值赋值给 <code>i</code></li></ul><p>这三个操作是分开进行的，并不是原子操作，所以多个线程可能同时在获取和设置 <code>i</code> 的值，这会导致数据的混乱。</p></details><h3 id="❓0x02-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0x02-下面代码输出结果" aria-hidden="true">#</a> ❓0x02 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> Animal
<span class="token keyword">@end</span>
<span class="token keyword">@interface</span> Dog <span class="token punctuation">:</span> Animal
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Dog
    <span class="token operator">-</span> <span class="token punctuation">(</span>instancetype<span class="token punctuation">)</span>init <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">super</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">self</span> class<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%@&quot;</span><span class="token punctuation">,</span> <span class="token function">NSStringFromClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">super</span> class<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">@end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Dog 
Dog
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>super</code> 并不会改变消息的接收者，所以当调用 <code>[super class]</code> 时，虽然是从父类开始查找 <code>class</code> 方法，但是方法的接收者依然是 <code>self</code> 本身，其类别自然是当前类本身。这也是为什么调用 <code>[super class]</code> 时还会返回 <code>Dog</code> 类的原因。</p></blockquote></details><h3 id="❓0x03-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0x03-下面代码输出结果" aria-hidden="true">#</a> ❓0x03 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> <span class="token function">NSObject</span> <span class="token punctuation">(</span>Test<span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> <span class="token function">NSObject</span> <span class="token punctuation">(</span>Test<span class="token punctuation">)</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testing...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">@end</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>NSObject test<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>NSObject new<span class="token punctuation">]</span> test<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Test
Test
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>Objective-C</code> 对象模型中，所有类的元类(<code>meta-class</code>)形成了一个单向链表，链表的末端是根类（如<code>NSObject</code>）的元类，<code>NSObject</code> 的元类的方法列表中包含了其所有子类的类方法。因此，当一个子类的类方法在其自身的元类中找不到实现时，会在这条单向链表中继续寻找，最终会找到根元类 <code>NSObject</code> 的方法列表，所以 <code>[NSObject test]</code>会调用到定义在分类中的实例方法。</p></details><h3 id="❓0x04-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0x04-下面代码输出结果" aria-hidden="true">#</a> ❓0x04 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> Test <span class="token punctuation">:</span> NSObject
 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test<span class="token punctuation">;</span>
 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test<span class="token punctuation">;</span>
 <span class="token keyword">@end</span>

 <span class="token keyword">@implementation</span> Test
 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;testing...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">@end</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">[</span>Test new<span class="token punctuation">]</span> test<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>Test test<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><blockquote><p>输出一个 “testing...” 之后崩溃。</p></blockquote><p>一个类方法在它们自己的类中没有找到，<code>Objective-C</code> 运行时将尝试在它的超类中查找。但是自定义的类 <code>Test</code>（子类）并不包含元类方法 <code>+test</code>，并且它的超类 <code>NSObject</code> 也没有这个方法，因此 <code>[Test test];</code> 将引发 <code>unrecognized selector sent to class</code> 异常，导致程序崩溃。</p></details><h3 id="❓0x05-下面代码能正常运行吗-如果能-输出是什么" tabindex="-1"><a class="header-anchor" href="#❓0x05-下面代码能正常运行吗-如果能-输出是什么" aria-hidden="true">#</a> ❓0x05 - 下面代码能正常运行吗(如果能，输出是什么)</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> Person <span class="token punctuation">:</span> NSObject 
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span>copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span> 
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Person
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>speak <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;My name is: %@&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> ViewController
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    id cls <span class="token operator">=</span> <span class="token punctuation">[</span>Person class<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token operator">&amp;</span>cls<span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span>__bridge id<span class="token punctuation">)</span>obj speak<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">@end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><blockquote><p>这段代码可以正常运行，其输出将是 <code>My name is:&lt;ViewController: 0x......&gt;</code>。</p></blockquote><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token comment">// 1&gt; 使用 id 指针 cls 获取 Person 类</span>
id cls <span class="token operator">=</span> <span class="token punctuation">[</span>Person class<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 2&gt; 使用 obj 获取指向 cls 的指针，指向的是一个 Person 类的对象(不是实例对象)</span>
<span class="token keyword">void</span> <span class="token operator">*</span>obj <span class="token operator">=</span> <span class="token operator">&amp;</span>cls<span class="token punctuation">;</span>
<span class="token comment">// 3&gt; </span>
<span class="token punctuation">[</span><span class="token punctuation">(</span>__bridge id<span class="token punctuation">)</span>obj speak<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>id cls = [Person class];</code> 这行代码是获取 <code>Person</code> 类。然后 <code>void *obj = &amp;cls;</code> 这行代码是获取了指向 <code>cls</code> 的指针，所以 <code>obj</code> 指向的是一个 <code>Person</code> 类的对象，而不是 <code>Person</code> 类的实例。然后 <code>[(__bridge id)obj speak];</code> 这行代码就是发送一个消息给 <code>obj</code>，所以最终调用的是 <code>Person</code> 类的 <code>speak</code> 方法。</li></ul><p>注意：并没有给 <code>name</code> 属性赋值，所以当打印 <code>name</code> 属性的时候，它的值是 <code>nil</code>，也就是 <code>(null)</code>。</p></details><h3 id="❓0x06-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0x06-下面代码输出结果" aria-hidden="true">#</a> ❓0x06 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> Father <span class="token punctuation">:</span> NSObject
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Father
<span class="token keyword">@end</span>

<span class="token keyword">@interface</span> Son <span class="token punctuation">:</span> Father
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Son
<span class="token keyword">@end</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">@</span>autoreleasepool <span class="token punctuation">{</span>
        Son <span class="token operator">*</span>son <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Son alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Father <span class="token operator">*</span>father <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>Father alloc<span class="token punctuation">]</span> init<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Son isKindOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span>father class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>son isKindOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span>Father class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Son isMemberOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span>father class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>son isMemberOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span>Father class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0
1
0
0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="❓0x07-计算内存大小" tabindex="-1"><a class="header-anchor" href="#❓0x07-计算内存大小" aria-hidden="true">#</a> ❓0x07 - 计算内存大小</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@interface</span> Person <span class="token punctuation">:</span> NSObject
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> <span class="token keyword">int</span> height<span class="token punctuation">;</span>
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Person
<span class="token keyword">@end</span>

<span class="token keyword">@interface</span> Student <span class="token punctuation">:</span> Person
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>school<span class="token punctuation">;</span>
<span class="token keyword">@end</span>
<span class="token keyword">@implementation</span> Student
<span class="token keyword">@end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>分别计算 <code>NSObject</code>、<code>Person</code>、<code>Student</code> 对象占用内存大小</p></blockquote><details class="hint-container details"><summary>💡</summary><ul><li><code>NSObject</code> 对象: 占用 16 字节 (<code>isa</code> 指针 8 字节 + 内存对齐(8 字节))</li><li><code>Person</code> 对象: 占用 16 字节 (<code>isa</code> 指针 8 字节 + <code>int</code>(4 字节) + <code>int</code>(4 字节))</li><li><code>Student</code> 对象: 占用 32 字节 (<code>isa</code> 指针 8 字节 + <code>int</code>(4 字节) + <code>int</code>(4 字节) + <code>NSString</code>(8 字节) + 内存对齐(8 字节))</li></ul></details><hr><h2 id="c" tabindex="-1"><a class="header-anchor" href="#c" aria-hidden="true">#</a> C</h2><h3 id="❓0xc01-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xc01-下面代码输出结果" aria-hidden="true">#</a> ❓0xc01 - 下面代码输出结果</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d, %d&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：<code>2, 5</code></p><ul><li><p><code>*(a + 1)</code>: 数组 <code>a</code>中当前索引往右挪一位对应的元素，也就是 <code>a[1]</code>，所以该输出值为 <code>2</code>。</p></li><li><p><code>*(ptr - 1)</code>: <code>ptr</code> 是 <code>(&amp;a + 1)</code> 的赋值结果，这里 <code>&amp;a</code> 是整个数组（由5个整数构成）的地址，所以 <code>&amp;a + 1</code> 会跨过整个 <code>a</code> 数组，指向 <code>a</code> 数组后面的内存地址。<code>ptr-1</code> 会指向 <code>a</code> 数组的最后一个元素 <code>a[4]</code> 也就是对应了值 <code>5</code> 。所以 <code>*(ptr-1)</code> 输出的是 <code>5</code>。</p></li></ul></details><hr><h2 id="swift" tabindex="-1"><a class="header-anchor" href="#swift" aria-hidden="true">#</a> Swift</h2><h3 id="❓0xs01-下面代码输出是什么" tabindex="-1"><a class="header-anchor" href="#❓0xs01-下面代码输出是什么" aria-hidden="true">#</a> ❓0xs01 - 下面代码输出是什么</h3><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token attribute atrule">@propertyWrapper</span>
<span class="token keyword">struct</span> <span class="token class-name">Wrapper</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> wrappedValue<span class="token punctuation">:</span> <span class="token class-name">T</span>

	<span class="token keyword">var</span> projectedValue<span class="token punctuation">:</span> <span class="token class-name">Wrapper</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">self</span> <span class="token punctuation">}</span>

	<span class="token keyword">func</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Foo&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">HasWrapper</span> <span class="token punctuation">{</span>
	<span class="token attribute atrule">@Wrapper</span> <span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">0</span>
    
	<span class="token keyword">func</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token function">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// wrappedValue</span>
	    <span class="token function">print</span><span class="token punctuation">(</span>_x<span class="token punctuation">)</span> <span class="token comment">// wrapper type itself</span>
	    <span class="token function">print</span><span class="token punctuation">(</span>$x<span class="token punctuation">)</span> <span class="token comment">// projectedValue</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0
Wrapper(wrappedValue: 0)
Wrapper(wrappedValue: 0)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>x</code> 是通过 <code>@Wrapper</code> 修饰符被包装的属性。 当直接访问 <code>x</code> 时，将获取 <code>wrappedValue</code> 的实际值。</li><li><code>_x</code> 则访问到 <code>Wrapper</code> 的实例本身。</li><li><code>$x</code> 用于访问 <code>projectedValue</code>，返回的是 <code>Wrapper</code> 的实例(由于 <code>Wrapper</code> 结构体没有定义 <code>CustomStringConvertible</code> 协议，因此它会使用默认的描述符，也就是其内部存储的字符串描述。)。</li></ul></details><hr><h2 id="多线程" tabindex="-1"><a class="header-anchor" href="#多线程" aria-hidden="true">#</a> 多线程</h2><h3 id="❓0xt01-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xt01-下面代码输出结果" aria-hidden="true">#</a> ❓0xt01 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code>dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BOOL isEqual <span class="token operator">=</span> <span class="token punctuation">[</span>queue isKindOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span>NSObject class<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;isEqual = %d&quot;</span><span class="token punctuation">,</span> isEqual<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：<code>isEqual = 1</code>。</p><p>虽然 <code>Objective-C </code>的 <code>GCD</code> 队列是基于 <code>C</code> 语言的 <code>dispatch_queue_t</code> 类型实现的，但它仍然是 <code>NSObject</code> 的子类。尽管 <code>GCD</code> 的 <code>API</code> 都是用纯 <code>C</code> 来实现的，但实际上 <code>GCD</code> 对象在 <code>Objective-C</code> 的运行时环境中是被当作 <code>Objective-C</code> 对象来处理的。所以这里的 <code>queue</code> 是可以被当作 <code>NSObject</code> 的实例来处理的，<code>[queue isKindOfClass:[NSObject class]]</code> 的结果是 <code>YES</code>，即 <code>isEqual=1</code>。</p></details><h3 id="❓0xt02-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xt02-下面代码输出结果" aria-hidden="true">#</a> ❓0xt02 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_sync</span><span class="token punctuation">(</span><span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><ul><li><p>如果这段代码在<strong>主线程</strong>中执行，那么会导致死锁。</p><blockquote><p>因为 <code>dispatch_sync</code> 函数是一个同步执行的函数，它会阻塞当前线程，并等待 <code>dispatch_sync</code> 内部的任务执行完成后再继续执行。然而此处的 <code>dispatch_sync</code> 内部任务被派发到了主队列，所以这个任务需要在主线程上执行。但是主线程此时被上述的 <code>dispatch_sync</code> 阻塞了，所以 <code>dispatch_sync</code> 内部的任务无法执行。这就造成了死锁，上述代码会在输出 &quot;1&quot; 后停止。</p></blockquote></li><li><p>如果这段代码在一个<strong>非主线程</strong>执行，那么它会先阻塞该线程，再在主线程上同步执行任务，输出 &quot;2&quot;，然后取消阻塞，接着输出 &quot;3&quot;，所以结果是 &quot;1&quot;，&quot;2&quot;，&quot;3&quot;。</p></li></ul></details><blockquote><p>❓改为 <code>global queue</code> 呢</p></blockquote><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_sync</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>这段代码无论在主线程还是在子线程中执行，最终的输出结果都是 &quot;1&quot;, &quot;2&quot;, &quot;3&quot;。</p><p>首先输出 &quot;1&quot;，然后 <code>dispatch_sync</code> 会将 <code>block</code> 中的任务同步地添加到全局队列，并阻塞当前线程直到 <code>block</code> 中的任务执行完毕。由于这里使用的是全局队列，这个队列是并发队列，且和当前线程（无论主线程或子线程）不是同一个队列，所以不会造成死锁。<code>block</code> 中的任务执行后，输出 &quot;2&quot;，然后 <code>dispatch_sync</code> 返回，当前线程继续执行，输出 &quot;3&quot;。所以最终的输出结果就是 &quot;1&quot;, &quot;2&quot;, &quot;3&quot;。</p></details><h3 id="❓0xt03-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xt03-下面代码输出结果" aria-hidden="true">#</a> ❓0xt03 - 下面代码输出结果</h3><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span>sync <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;1&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>这段代码会造成主线程的死锁。</p><p>函数<code>test()</code> 是在主线程中被调用的，然后在 <code>test()</code> 函数中，又使用了<code>DispatchQueue.main.sync</code>尝试再次在主线程中执行一段任务。</p><p>由于 <code>sync</code> 是同步执行，也就是说 <code>sync</code>后面的任务会立刻执行，执行完后才会继续执行后面的代码。但是 <code>sync</code> 后面的代码块又是在主线程中执行的，这个时候主线程已经被前面的 <code>test()</code> 函数占用，所以<code>sync</code>后面的代码块就会等待主线程空闲，但是主线程在等待 <code>sync</code> 后的代码块执行完毕，导致互相等待，产生死锁。</p></details><h3 id="❓0xt04-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xt04-下面代码输出结果" aria-hidden="true">#</a> ❓0xt04 - 下面代码输出结果</h3><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token keyword">func</span> <span class="token function-definition function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;1&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;thread&quot;</span></span><span class="token punctuation">)</span>
    queue<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;2&quot;</span></span><span class="token punctuation">)</span>
        <span class="token class-name">DispatchQueue</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span>sync <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;3&quot;</span></span><span class="token punctuation">)</span>
            queue<span class="token punctuation">.</span>sync <span class="token punctuation">{</span>
                <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;4&quot;</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;5&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;6&quot;</span></span><span class="token punctuation">)</span>
    queue<span class="token punctuation">.</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;7&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;8&quot;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>1
6
8
2
3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>这段代码首先在主线程中调用 <code>print(&quot;1&quot;)</code>，接着创建一个自定义的并发队列 <code>queue</code>。</li><li>然后在 <code>queue</code> 中异步执行一个 block，但执行这个 block 并不会阻塞当前线程（即主线程）。所以，<code>print(&quot;1&quot;)</code>，<code>print(&quot;6&quot;)</code> 和 <code>print(&quot;8&quot;)</code> 几乎是立即执行的，只是因为 CPU 的调度问题，可能存在轻微的延迟。</li><li>之后，回到 <code>queue</code> 中异步执行的那个 block。在这个 block 的执行过程中，会首先执行 <code>print(&quot;2&quot;)</code>。接着，在主线程中同步执行一个 block 会打印 <code>print(&quot;3&quot;)</code>。这个 block 的执行会阻塞 <code>queue</code>，直到这个 block 执行完毕。 在这个 block 中，又在 <code>queue</code> 中执行了一个 block，但是由于这是同步执行的，所以要等待这个 block 执行完毕后才能继续执行主线程的 block。但是，这个 block 并不会被执行，因为是在 <code>queue</code> 中同步执行的，<code>queue</code> 在这个时候还在等待主线程中的 block 执行完毕。这就产生了死锁。</li><li>最后，<code>queue</code> 中的另一个 block 并不会被执行，因为在执行这个 block 的时候，<code>queue</code> 已经被上面的死锁阻塞了。</li></ul></details><h3 id="❓0xt05-下面代码输出结果" tabindex="-1"><a class="header-anchor" href="#❓0xt05-下面代码输出结果" aria-hidden="true">#</a> ❓0xt05 - 下面代码输出结果</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> withObject<span class="token punctuation">:</span>nil afterDelay<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>test <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><blockquote><p>打印顺序 : 1, 4, 2, 3</p></blockquote><p>&quot;1&quot;和&quot;4&quot;是普通的直接执行代码，因此会按照顺序输出。</p><p>&quot;2&quot;和&quot;3&quot;位于异步并发队列中，会在新线程中执行，所以会在&quot;1&quot;和&quot;4&quot;之后开始执行。</p><p>&quot;5&quot;不会输出。原因是<code>[self performSelector:@selector(test) withObject:nil afterDelay:10];</code>这一行代码被放在异步并发队列中，并且是在子线程中执行，但是这种执行方式是依赖 <code>RunLoop</code> 的，而新创建的线程默认是没有启动 <code>RunLoop</code> 的，所以<code>performSelector:afterDelay:</code>方法会失效。</p></details><blockquote><p>❓如果想要使 &quot;5&quot; 能够打印，应该怎么处理</p></blockquote><details class="hint-container details"><summary>💡</summary><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token comment">// 方案一 : 放入主线程 RunLoop</span>
<span class="token punctuation">[</span><span class="token keyword">self</span> performSelectorOnMainThread<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> withObject<span class="token punctuation">:</span>nil waitUntilDone<span class="token punctuation">:</span>NO<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
<span class="token comment">// 方案二 : 在子线程中手动启动 RunLoop</span>
NSRunLoop <span class="token operator">*</span>runLoop <span class="token operator">=</span> <span class="token punctuation">[</span>NSRunLoop currentRunLoop<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token keyword">self</span> performSelector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> withObject<span class="token punctuation">:</span>nil afterDelay<span class="token punctuation">:</span><span class="token number">5.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>runLoop run<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="❓0xt06-下面代码会发生什么" tabindex="-1"><a class="header-anchor" href="#❓0xt06-下面代码会发生什么" aria-hidden="true">#</a> ❓0xt06 - 下面代码会发生什么</h3><div class="language-objc line-numbers-mode" data-ext="objc"><pre class="language-objc"><code><span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> NSString <span class="token operator">*</span>target<span class="token punctuation">;</span>
<span class="token comment">//....</span>

dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_queue_create</span><span class="token punctuation">(</span><span class="token string">&quot;parallel&quot;</span><span class="token punctuation">,</span> DISPATCH_QUEUE_CONCURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">dispatch_async</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
     	<span class="token keyword">self</span><span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@&quot;ksddkjalkjd%d&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>💡</summary><p>这段代码会崩溃。</p><p>在一个并发队列 (&quot;parallel&quot;) 上异步地多次执行一个 <code>block</code>。每次 <code>block</code> 执行时,会把 <code>self.target</code> 的值设置为一个新的字符串。因为这是在并发队列上执行的，所以这些设置 <code>self.target</code> 的操作可能同时执行。</p><p>这会引起线程安全的问题——数据竞争 (data race)。由于 <code>setter</code> 本质上是读取+写入两个操作，如果多个线程同时进行这两个操作，可能会造成数据不一致。这就是所谓的线程安全问题。</p><p>同时，不确定的并发操作可能会导致内存暴涨。<code>dispatch_async</code> 的 <code>block</code>，会被<code>dispatch_retain</code>，然后被存储起来等待执行。如果并行队列中 <code>block</code> 剧增，未执行的 <code>block</code> 可能会积压，导致大量内存消耗。</p></details><hr><h2 id="uikit" tabindex="-1"><a class="header-anchor" href="#uikit" aria-hidden="true">#</a> UIKit</h2><h3 id="❓寻找最近的公共-view" tabindex="-1"><a class="header-anchor" href="#❓寻找最近的公共-view" aria-hidden="true">#</a> ❓寻找最近的公共 <code>View</code></h3><details class="hint-container details"><summary>💡</summary><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token comment">// 寻找两个子视图最近的公共父视图</span>
<span class="token keyword">func</span> <span class="token function-definition function">findNearestCommonAncestor</span><span class="token punctuation">(</span>view1<span class="token punctuation">:</span> <span class="token class-name">UIView</span><span class="token punctuation">,</span> view2<span class="token punctuation">:</span> <span class="token class-name">UIView</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">UIView</span><span class="token operator">?</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> currentView<span class="token punctuation">:</span> <span class="token class-name">UIView</span><span class="token operator">?</span> <span class="token operator">=</span> view1
    <span class="token keyword">while</span> <span class="token keyword">let</span> view <span class="token operator">=</span> currentView <span class="token punctuation">{</span> <span class="token comment">// 递归视图的父视图</span>
        <span class="token comment">// 判断 view2 是否为当前遍历父视图的后代视图，如果是就是公共父视图</span>
        <span class="token keyword">if</span> view2<span class="token punctuation">.</span><span class="token function">isDescendant</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> view
        <span class="token punctuation">}</span>
        currentView <span class="token operator">=</span> view<span class="token punctuation">.</span>superview
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token nil constant">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="❓打印一个-view-的所有子-view-要求分层打印" tabindex="-1"><a class="header-anchor" href="#❓打印一个-view-的所有子-view-要求分层打印" aria-hidden="true">#</a> ❓打印一个 <code>View</code> 的所有子 <code>View</code>，要求分层打印</h3><details class="hint-container details"><summary>💡</summary><blockquote><p>树的层序遍历问题</p></blockquote><div class="language-swift line-numbers-mode" data-ext="swift"><pre class="language-swift"><code><span class="token comment">// 队列(Queue)来实现树的层次遍历</span>
<span class="token keyword">func</span> <span class="token function-definition function">printSubviewsInLevelOrder</span><span class="token punctuation">(</span><span class="token keyword">for</span> view<span class="token punctuation">:</span> <span class="token class-name">UIView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">UIView</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    queue<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">!</span>queue<span class="token punctuation">.</span>isEmpty <span class="token punctuation">{</span>
        <span class="token keyword">var</span> count <span class="token operator">=</span> queue<span class="token punctuation">.</span>count <span class="token comment">// 当前层数量</span>
        <span class="token keyword">var</span> levelViews <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token class-name">UIView</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当前层视图</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> levelView <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            levelViews<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>levelView<span class="token punctuation">)</span>
            count <span class="token operator">-=</span> <span class="token number">1</span>
            <span class="token comment">// 将当前层视图子视图继续加入队列</span>
            <span class="token keyword">for</span> subview <span class="token keyword">in</span> levelView<span class="token punctuation">.</span>subviews <span class="token punctuation">{</span>
                queue<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>subview<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">print</span><span class="token punctuation">(</span>levelViews<span class="token punctuation">)</span> <span class="token comment">// 打印当前层视图   </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details>`,65);function N(O,C){const a=c("ExternalLinkIcon");return i(),l("div",null,[t(" more "),d,t(" NSObject & 内存布局 "),n("ul",null,[n("li",null,[r,n("a",k,[s("2019-12-20 关于 NSObject 对象的内存布局，看我就够了！"),e(a)])]),n("li",null,[v,n("a",m,[s("2019-03-13 iOS 中的 NSObject"),e(a)])])]),t(" runtime "),n("ul",null,[n("li",null,[b,n("a",h,[s("2018-11-30 一道值得思考的 iOS 面试题"),e(a)]),g]),n("li",null,[f,n("a",w,[s("2014-11-06 神经病院 objc runtime 入院考试"),e(a)])])]),t(" 多线程 "),n("ul",null,[n("li",null,[y,n("a",q,[s("2018-03-03 5 道 iOS 多线程“面试题”"),e(a)])]),n("li",null,[x,n("a",_,[s("2017-08-25 从一道网易面试题浅谈 Objective-C 线程安全"),e(a)]),j])]),S])}const E=p(u,[["render",N],["__file","0x18.code.html.vue"]]);export{E as default};
