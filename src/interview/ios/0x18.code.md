---
title: ä»£ç é¢˜
icon: hashtag

index: true

---

<!-- more -->

------

## Objective-C

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
@property (atomic) NSInteger i;
// çº¿ç¨‹ä¸­
for (int i = 0; i < 10000; i++) {
    self.i++;
}
```

::: details ğŸ’¡

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå±æ€§ `i` å¹¶ä¸èƒ½ä¿è¯ä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼é€’å¢ã€‚è™½ç„¶ `atomic` å±æ€§ç¡®å®æä¾›äº†ä¸€å®šçš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œä½†æ˜¯å®ƒçš„æ“ä½œå¹¶ä¸æ˜¯å®Œå…¨åŸå­æ€§çš„ï¼ˆatomicï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œ `atomic` åªèƒ½ä¿è¯å±æ€§çš„ `getter` å’Œ `setter` æ–¹æ³•åœ¨è¢«è°ƒç”¨æ—¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œå¹¶ä¸èƒ½ä¿è¯åƒ `self.i++` è¿™æ ·çš„å¤åˆæ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

`self.i++` å®é™…ä¸ŠåŒ…å«äº†ä¸‰ä¸ªæ“ä½œï¼šè·å– `i` çš„å€¼ï¼Œå°†è·å–åˆ°çš„å€¼åŠ ä¸€ï¼Œç„¶åå°†æ–°å€¼èµ‹å€¼ç»™ `i`ã€‚è¿™ä¸‰ä¸ªæ“ä½œæ˜¯åˆ†å¼€è¿›è¡Œçš„ï¼Œå¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶åœ¨è·å–å’Œè®¾ç½® `i` çš„å€¼ï¼Œè¿™ä¼šå¯¼è‡´æ•°æ®çš„æ··ä¹±ã€‚

æ‰€ä»¥è¿™æ®µä»£ç çš„ç»“æœæ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå®ƒå°†å–å†³äºçº¿ç¨‹è°ƒåº¦å’Œè¿è¡Œæ—¶çš„å…·ä½“æƒ…å†µã€‚å¦‚æœä½ å¸Œæœ›åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ›´æ–°å…±äº«å˜é‡ï¼Œé‚£ä¹ˆä½ éœ€è¦ä½¿ç”¨é”æˆ–è€…å…¶ä»–åŒæ­¥æœºåˆ¶æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

:::


### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
@interface NSObject (Test)
+ (void)test;
- (void)test;
@end

@implementation NSObject (Test)
- (void)test {
    NSLog(@"Test");
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        [NSObject test];
        [[NSObject new] test];
    }
    return 0;
}
```

::: details ğŸ’¡

> åœ¨ `Objective-C` å¯¹è±¡æ¨¡å‹ä¸­ï¼Œæ‰€æœ‰ç±»çš„å…ƒç±»(`meta-class`)å½¢æˆäº†ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œé“¾è¡¨çš„æœ«ç«¯æ˜¯æ ¹ç±»ï¼ˆå¦‚`NSObject`ï¼‰çš„å…ƒç±»ï¼Œ`NSObject` çš„å…ƒç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­åŒ…å«äº†å…¶æ‰€æœ‰å­ç±»çš„ç±»æ–¹æ³•ã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ªå­ç±»çš„ç±»æ–¹æ³•åœ¨å…¶è‡ªèº«çš„å…ƒç±»ä¸­æ‰¾ä¸åˆ°å®ç°æ—¶ï¼Œä¼šåœ¨è¿™æ¡å•å‘é“¾è¡¨ä¸­ç»§ç»­å¯»æ‰¾ï¼Œæœ€ç»ˆä¼šæ‰¾åˆ°æ ¹å…ƒç±» `NSObject` çš„æ–¹æ³•åˆ—è¡¨ï¼Œæ‰€ä»¥ `[NSObject test]`ä¼šè°ƒç”¨åˆ°å®šä¹‰åœ¨åˆ†ç±»ä¸­çš„å®ä¾‹æ–¹æ³•ã€‚

è¾“å‡ºä¸ºï¼š

```
Test
Test
```

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
@interface DogTest : NSObject
 + (void)test;
 - (void)test;
 @end

 @implementation DogTest
 - (void)test {
    NSLog(@"TEST");
 }
 @end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        [[DogTest new] test];
        [DogTest test];
    }
    return 0;
}
```

::: details ğŸ’¡

è¾“å‡ºä¸€ä¸ª â€œTESTâ€ ä¹‹åå´©æºƒã€‚

  ä¸€ä¸ªç±»æ–¹æ³•åœ¨å®ƒä»¬è‡ªå·±çš„ç±»ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œ`Objective-C` è¿è¡Œæ—¶å°†å°è¯•åœ¨å®ƒçš„è¶…ç±»ä¸­æŸ¥æ‰¾ã€‚ä½†æ˜¯è‡ªå®šä¹‰çš„ç±» `DogTest`ï¼ˆå­ç±»ï¼‰å¹¶ä¸åŒ…å«å…ƒç±»æ–¹æ³• `+test`ï¼Œå¹¶ä¸”å®ƒçš„è¶…ç±» `NSObject` ä¹Ÿæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œå› æ­¤ `[DogTest test];` å°†å¼•å‘ `unrecognized selector sent to class` å¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
@interface Animal
@end
@interface Dog : Animal
@end
@implementation Dog
    - (instancetype)init {
        self = [super init];
        if (self) {
            NSLog(@"%@", NSStringFromClass([self class]));
            NSLog(@"%@", NSStringFromClass([super class]));
        }
        return self;
    }
@end
```
  
::: details ğŸ’¡
  
  è¾“å‡ºï¼š 
  
        Dog 
        Dog
  
  `super` å¹¶ä¸ä¼šæ”¹å˜æ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œæ‰€ä»¥å½“è°ƒç”¨ `[super class]` æ—¶ï¼Œè™½ç„¶æ˜¯ä»çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾ `class` æ–¹æ³•ï¼Œä½†æ˜¯æ–¹æ³•çš„æ¥æ”¶è€…ä¾ç„¶æ˜¯ `self` æœ¬èº«ï¼Œå…¶ç±»åˆ«è‡ªç„¶æ˜¯å½“å‰ç±»æœ¬èº«ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè°ƒç”¨ `[super class]` æ—¶è¿˜ä¼šè¿”å› `Dog` ç±»çš„åŸå› ã€‚

:::

### â“ä¸‹é¢ä»£ç èƒ½æ­£å¸¸è¿è¡Œå—(å¦‚æœèƒ½ï¼Œè¾“å‡ºæ˜¯ä»€ä¹ˆ)

```objc
@interface Person : NSObject 
@property(nonatomic,copy) NSString *name; 
@end
@implementation Person
- (void)speak {
    NSLog(@"My name is:%@",self.name); 
}
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    id cls = [Person class];
    void *obj = &cls;
    [(__bridge id)obj speak];
}
@end
```

::: details ğŸ’¡

è¿™æ®µä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå…¶è¾“å‡ºå°†æ˜¯ `My name is:(null)`ã€‚

åœ¨è¿™æ®µä»£ç ä¸­ `id cls = [Person class];`è¿™è¡Œä»£ç æ˜¯è·å– `Person` ç±»ã€‚ç„¶å `void *obj = &cls;` è¿™è¡Œä»£ç æ˜¯è·å–äº†æŒ‡å‘ `cls` çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ `obj` æŒ‡å‘çš„æ˜¯ä¸€ä¸ª `Person` ç±»çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ `Person` ç±»çš„å®ä¾‹ã€‚ç„¶å `[(__bridge id)obj speak];` è¿™è¡Œä»£ç å°±æ˜¯å‘é€ä¸€ä¸ªæ¶ˆæ¯ç»™ `obj`ï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨çš„æ˜¯ `Person` ç±»çš„ `speak` æ–¹æ³•ã€‚

æ³¨æ„ï¼šå¹¶æ²¡æœ‰ç»™ `name` å±æ€§èµ‹å€¼ï¼Œæ‰€ä»¥å½“æ‰“å° `name` å±æ€§çš„æ—¶å€™ï¼Œå®ƒçš„å€¼æ˜¯ `nil`ï¼Œä¹Ÿå°±æ˜¯ `(null)`ã€‚

:::


------

## Swift

#### â“ä¸‹é¢ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ

```swift
@propertyWrapper
struct Wrapper<T> {
	var wrappedValue: T

	var projectedValue: Wrapper<T> { return self }

	func foo() { print("Foo") }
}
struct HasWrapper {
	@Wrapper var x = 0
    
	func foo() {
	    print(x) // `wrappedValue`
	    print(_x) // wrapper type itself
	    print($x) // `projectedValue`
	}
}
```

::: details ğŸ’¡

  - `x` æ˜¯é€šè¿‡ `@Wrapper` ä¿®é¥°ç¬¦è¢«åŒ…è£…çš„å±æ€§ã€‚ å½“ç›´æ¥è®¿é—® `x` æ—¶ï¼Œå°†è·å– `wrappedValue` çš„å®é™…å€¼ã€‚
  - `_x` åˆ™è®¿é—®åˆ° `Wrapper` çš„å®ä¾‹æœ¬èº«ã€‚
  - `$x` ç”¨äºè®¿é—® `projectedValue`ï¼Œè¿”å›çš„æ˜¯ `Wrapper` çš„å®ä¾‹(ç”±äº `Wrapper` ç»“æ„ä½“æ²¡æœ‰å®šä¹‰ `CustomStringConvertible` åè®®ï¼Œå› æ­¤å®ƒä¼šä½¿ç”¨é»˜è®¤çš„æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯å…¶å†…éƒ¨å­˜å‚¨çš„å­—ç¬¦ä¸²æè¿°ã€‚)ã€‚

```swift
print(x)    // 0
print(_x)   // Wrapper(wrappedValue: 0)
print($x)   // Wrapper(wrappedValue: 0)
```

:::

------

## UIKit

### â“å¯»æ‰¾æœ€è¿‘çš„å…¬å…± `View`

::: details ğŸ’¡

```swift
// å¯»æ‰¾ä¸¤ä¸ªå­è§†å›¾æœ€è¿‘çš„å…¬å…±çˆ¶è§†å›¾
func findNearestCommonAncestor(view1: UIView, view2: UIView) -> UIView? {
    var currentView: UIView? = view1
    while let view = currentView { // é€’å½’è§†å›¾çš„çˆ¶è§†å›¾
        // åˆ¤æ–­ view2 æ˜¯å¦ä¸ºå½“å‰éå†çˆ¶è§†å›¾çš„åä»£è§†å›¾ï¼Œå¦‚æœæ˜¯å°±æ˜¯å…¬å…±çˆ¶è§†å›¾
        if view2.isDescendant(of: view) { 
            return view
        }
        currentView = view.superview
    }
    return nil
}
```

:::

### â“æ‰“å°ä¸€ä¸ª `View` çš„æ‰€æœ‰å­ `View`ï¼Œè¦æ±‚åˆ†å±‚æ‰“å°

::: details ğŸ’¡

> æ ‘çš„å±‚åºéå†é—®é¢˜

```swift
// é˜Ÿåˆ—(Queue)æ¥å®ç°æ ‘çš„å±‚æ¬¡éå†
func printSubviewsInLevelOrder(for view: UIView) {
    var queue = [UIView]()
    queue.append(view)
    while !queue.isEmpty {
        var count = queue.count // å½“å‰å±‚æ•°é‡
        var levelViews = [UIView]() // å½“å‰å±‚è§†å›¾
        while (count > 0) {
            let levelView = queue.removeFirst()
            levelViews.append(levelView)
            count -= 1
            // å°†å½“å‰å±‚è§†å›¾å­è§†å›¾ç»§ç»­åŠ å…¥é˜Ÿåˆ—
            for subview in levelView.subviews {
                queue.append(subview)
            }
        }
        print(levelViews) // æ‰“å°å½“å‰å±‚è§†å›¾   
    }
}
```

:::

------

## å¤šçº¿ç¨‹

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
NSLog(@"1");
dispatch_sync(dispatch_get_main_queue(), ^{
    NSLog(@"2");
});
NSLog(@"3");
```

::: details ğŸ’¡

  - å¦‚æœè¿™æ®µä»£ç åœ¨**ä¸»çº¿ç¨‹**ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ­»é”ã€‚
    > å› ä¸º `dispatch_sync` å‡½æ•°æ˜¯ä¸€ä¸ªåŒæ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œå®ƒä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶ç­‰å¾… `dispatch_sync` å†…éƒ¨çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†ç»§ç»­æ‰§è¡Œã€‚ç„¶è€Œæ­¤å¤„çš„ `dispatch_sync` å†…éƒ¨ä»»åŠ¡è¢«æ´¾å‘åˆ°äº†ä¸»é˜Ÿåˆ—ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ä½†æ˜¯ä¸»çº¿ç¨‹æ­¤æ—¶è¢«ä¸Šè¿°çš„ `dispatch_sync` é˜»å¡äº†ï¼Œæ‰€ä»¥ `dispatch_sync` å†…éƒ¨çš„ä»»åŠ¡æ— æ³•æ‰§è¡Œã€‚è¿™å°±é€ æˆäº†æ­»é”ï¼Œä¸Šè¿°ä»£ç ä¼šåœ¨è¾“å‡º "1" ååœæ­¢ã€‚

  - å¦‚æœè¿™æ®µä»£ç åœ¨ä¸€ä¸ª**éä¸»çº¿ç¨‹**æ‰§è¡Œï¼Œé‚£ä¹ˆå®ƒä¼šå…ˆé˜»å¡è¯¥çº¿ç¨‹ï¼Œå†åœ¨ä¸»çº¿ç¨‹ä¸ŠåŒæ­¥æ‰§è¡Œä»»åŠ¡ï¼Œè¾“å‡º "2"ï¼Œç„¶åå–æ¶ˆé˜»å¡ï¼Œæ¥ç€è¾“å‡º "3"ï¼Œæ‰€ä»¥ç»“æœæ˜¯ "1"ï¼Œ"2"ï¼Œ"3"ã€‚

:::

> â“æ”¹ä¸º `global queue` å‘¢

```objc
NSLog(@"1");
dispatch_sync(dispatch_get_global_queue(), ^{
    NSLog(@"2");
});
NSLog(@"3");
```

::: details ğŸ’¡

è¿™æ®µä»£ç æ— è®ºåœ¨ä¸»çº¿ç¨‹è¿˜æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæœ€ç»ˆçš„è¾“å‡ºç»“æœéƒ½æ˜¯ "1", "2", "3"ã€‚

  é¦–å…ˆè¾“å‡º "1"ï¼Œç„¶å `dispatch_sync` ä¼šå°† `block` ä¸­çš„ä»»åŠ¡åŒæ­¥åœ°æ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ° `block` ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ç”±äºè¿™é‡Œä½¿ç”¨çš„æ˜¯å…¨å±€é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œä¸”å’Œå½“å‰çº¿ç¨‹ï¼ˆæ— è®ºä¸»çº¿ç¨‹æˆ–å­çº¿ç¨‹ï¼‰ä¸æ˜¯åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”ã€‚`block` ä¸­çš„ä»»åŠ¡æ‰§è¡Œåï¼Œè¾“å‡º "2"ï¼Œç„¶å `dispatch_sync` è¿”å›ï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œè¾“å‡º "3"ã€‚æ‰€ä»¥æœ€ç»ˆçš„è¾“å‡ºç»“æœå°±æ˜¯ "1", "2", "3"ã€‚

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
dispatch_queue_t queue = dispatch_get_main_queue();
BOOL isEqual = [queue isKindOfClass:[NSObject class]];
NSLog(@"isEqual=%d", isEqual);
```

::: details ğŸ’¡

è¾“å‡ºç»“æœæ˜¯ `isEqual=1`ã€‚

  è™½ç„¶ `Objective-C `çš„ `GCD` é˜Ÿåˆ—æ˜¯åŸºäº `C` è¯­è¨€çš„ `dispatch_queue_t` ç±»å‹å®ç°çš„ï¼Œä½†å®ƒä»ç„¶æ˜¯ `NSObject` çš„å­ç±»ã€‚å°½ç®¡ `GCD` çš„ `API` éƒ½æ˜¯ç”¨çº¯ `C` æ¥å®ç°çš„ï¼Œä½†å®é™…ä¸Š `GCD` å¯¹è±¡åœ¨ `Objective-C` çš„è¿è¡Œæ—¶ç¯å¢ƒä¸­æ˜¯è¢«å½“ä½œ `Objective-C` å¯¹è±¡æ¥å¤„ç†çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„ `queue` æ˜¯å¯ä»¥è¢«å½“ä½œ `NSObject` çš„å®ä¾‹æ¥å¤„ç†çš„ï¼Œæ‰€ä»¥ `[queue isKindOfClass:[NSObject class]]` çš„ç»“æœæ˜¯ `YES`ï¼Œå³ `isEqual=1`ã€‚

  ç„¶è€Œï¼Œä¸èƒ½ç›´æ¥å¯¹ `dispatch_queue_t` ç±»å‹çš„å¯¹è±¡å‘é€ `Objective-C` æ¶ˆæ¯ï¼Œä¾‹å¦‚ `respondsToSelector:`ã€`performSelector:` ç­‰ï¼Œè¿™æ ·åšå¯èƒ½ä¼šå¼•å‘å¼‚å¸¸æˆ–è€…å´©æºƒã€‚å› ä¸º `dispatch_queue_t` ä»¥åŠå…¶ä»–çš„ `GCD` å¯¹è±¡ç±»å‹å¹¶æ²¡æœ‰å®ç°è¿™äº›æ–¹æ³•ã€‚

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```swift
func test() {
    DispatchQueue.main.sync {
        print("1")
    }
}
test()
```

::: details ğŸ’¡

è¿™æ®µä»£ç ä¼šé€ æˆä¸»çº¿ç¨‹çš„æ­»é”ã€‚

å‡½æ•°`test()` æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¢«è°ƒç”¨çš„ï¼Œç„¶ååœ¨ `test()` å‡½æ•°ä¸­ï¼Œåˆä½¿ç”¨äº†`DispatchQueue.main.sync`å°è¯•å†æ¬¡åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä¸€æ®µä»»åŠ¡ã€‚

ç”±äº `sync` æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ `sync`åé¢çš„ä»»åŠ¡ä¼šç«‹åˆ»æ‰§è¡Œï¼Œæ‰§è¡Œå®Œåæ‰ä¼šç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚ä½†æ˜¯ `sync` åé¢çš„ä»£ç å—åˆæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¿™ä¸ªæ—¶å€™ä¸»çº¿ç¨‹å·²ç»è¢«å‰é¢çš„ `test()` å‡½æ•°å ç”¨ï¼Œæ‰€ä»¥`sync`åé¢çš„ä»£ç å—å°±ä¼šç­‰å¾…ä¸»çº¿ç¨‹ç©ºé—²ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹åœ¨ç­‰å¾… `sync` åçš„ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œå¯¼è‡´äº’ç›¸ç­‰å¾…ï¼Œäº§ç”Ÿæ­»é”ã€‚+

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```swift
func test() {
    print("1")
    let queue = DispatchQueue.init(label: "thread")
    queue.async {
        print("2")
        DispatchQueue.main.sync {
            print("3")
            queue.sync {
                print("4")
            }
        }
        print("5")
    }
    print("6")
    queue.async {
        print("7")
    }
    print("8")
}
test()
```

::: details ğŸ’¡

æ ¹æ®è¿™æ®µä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Œä»£ç ä¸­æ‰“å°çš„æ¶ˆæ¯çš„é¡ºåºåº”è¯¥æ˜¯ï¼š

```
1
6
8
2
3
5
7
```

ä¸‹é¢æ˜¯è¿™æ®µä»£ç çš„ä¸€äº›è§£é‡Šï¼š

- è¿™æ®µä»£ç é¦–å…ˆåœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ `print("1")`ï¼Œæ¥ç€åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ— `queue`ã€‚
- ç„¶ååœ¨ `queue` ä¸­å¼‚æ­¥æ‰§è¡Œä¸€ä¸ª blockï¼Œä½†æ‰§è¡Œè¿™ä¸ª block å¹¶ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼ˆå³ä¸»çº¿ç¨‹ï¼‰ã€‚æ‰€ä»¥ï¼Œ`print("1")`ï¼Œ`print("6")` å’Œ `print("8")` å‡ ä¹æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œåªæ˜¯å› ä¸º CPU çš„è°ƒåº¦é—®é¢˜ï¼Œå¯èƒ½å­˜åœ¨è½»å¾®çš„å»¶è¿Ÿã€‚
- ä¹‹åï¼Œå›åˆ° `queue` ä¸­å¼‚æ­¥æ‰§è¡Œçš„é‚£ä¸ª blockã€‚åœ¨è¿™ä¸ª block çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šé¦–å…ˆæ‰§è¡Œ `print("2")`ã€‚æ¥ç€ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œä¸€ä¸ª blockã€‚è¿™ä¸ª block çš„æ‰§è¡Œä¼šé˜»å¡ `queue`ï¼Œç›´åˆ°è¿™ä¸ª block æ‰§è¡Œå®Œæ¯•ã€‚ åœ¨è¿™ä¸ª block ä¸­ï¼Œåˆåœ¨ `queue` ä¸­æ‰§è¡Œäº†ä¸€ä¸ª blockï¼Œä½†æ˜¯ç”±äºè¿™æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¦ç­‰å¾…è¿™ä¸ª block æ‰§è¡Œå®Œæ¯•åæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸»çº¿ç¨‹çš„ blockã€‚ä½†æ˜¯ï¼Œè¿™ä¸ª block å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºä»–æ˜¯åœ¨ `queue` ä¸­åŒæ­¥æ‰§è¡Œçš„ï¼Œ`queue` åœ¨è¿™ä¸ªæ—¶å€™è¿˜åœ¨ç­‰å¾…ä¸»çº¿ç¨‹ä¸­çš„ block æ‰§è¡Œå®Œæ¯•ã€‚è¿™å°±äº§ç”Ÿäº†æ­»é”ã€‚
- æœ€åï¼Œ`queue` ä¸­çš„å¦ä¸€ä¸ª block å¹¶ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› ä¸ºåœ¨æ‰§è¡Œè¿™ä¸ª block çš„æ—¶å€™ï¼Œ`queue` å·²ç»è¢«ä¸Šé¢çš„æ­»é”é˜»å¡äº†ã€‚

å› æ­¤ï¼Œè¿™æ®µä»£ç çš„å®é™…è¾“å‡ºåº”è¯¥åªæœ‰ `print("1")`ï¼Œ `print("6")` å’Œ `print("8")`çš„è¾“å‡ºï¼Œå¹¶ä¸”ç¨‹åºä¼šåœ¨ `queue.sync { print("4") }` è¿™è¡Œäº§ç”Ÿæ­»é”ã€‚

æ³¨æ„ï¼šSwift ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹ç›¸å…³è”çš„ DispatchQueueï¼ˆåˆ†æ´¾é˜Ÿåˆ—ï¼‰ï¼Œè¿™ä¸ª DispatchQueue ç”¨æ¥ç®¡ç†å’Œè°ƒåº¦è¿™ä¸ªçº¿ç¨‹ä¸Šçš„ä»»åŠ¡ã€‚`DispatchQueue.main.sync` è¡¨ç¤ºå°†ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°ä¸»çº¿ç¨‹ç›¸å…³è”çš„ DispatchQueue ä¸­ï¼Œå¹¶ç«‹å³ç­‰å¾…è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚`queue.async` è¡¨ç¤ºå°†ä¸€ä¸ªä»»åŠ¡å¼‚æ­¥åœ°æ·»åŠ åˆ° `queue` ä¸­ï¼Œè¿™ä¸ªä»»åŠ¡ä¼šåœ¨ `queue` æœ‰ç©ºé—²çš„æ—¶å€™æ‰§è¡Œï¼Œå¹¶ä¸”æ·»åŠ ä»»åŠ¡åçš„ä»£ç ä¸ä¼šç­‰å¾…è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•å°±ä¼šç»§ç»­æ‰§è¡Œã€‚

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
NSLog(@"1");
dispatch_async(dispatch_get_global_queue(0, 0), ^{
    NSLog(@"2");
    [self performSelector:@selector(test) withObject:nil afterDelay:10];
    NSLog(@"3");
});
NSLog(@"4");
- (void)test {
    NSLog(@"5");
}
```

::: details ğŸ’¡

  > æ‰“å°é¡ºåº : 1, 4, 2, 3

  "1"å’Œ"4"æ˜¯æ™®é€šçš„ç›´æ¥æ‰§è¡Œä»£ç ï¼Œå› æ­¤ä¼šæŒ‰ç…§é¡ºåºè¾“å‡ºã€‚
  
  "2"å’Œ"3"ä½äºå¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œä¼šåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šåœ¨"1"å’Œ"4"ä¹‹åå¼€å§‹æ‰§è¡Œã€‚

  "5"ä¸ä¼šè¾“å‡ºã€‚åŸå› æ˜¯`[self performSelector:@selector(test) withObject:nil afterDelay:10];`è¿™ä¸€è¡Œä»£ç è¢«æ”¾åœ¨å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼æ˜¯ä¾èµ– `RunLoop` çš„ï¼Œè€Œæ–°åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨ `RunLoop` çš„ï¼Œæ‰€ä»¥`performSelector:afterDelay:`æ–¹æ³•ä¼šå¤±æ•ˆã€‚

:::

> â“å¦‚æœæƒ³è¦ä½¿ "5" èƒ½å¤Ÿæ‰“å°ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†

::: details ğŸ’¡   
 
```objc
// æ–¹æ¡ˆä¸€ : æ”¾å…¥ä¸»çº¿ç¨‹ RunLoop
[self performSelectorOnMainThread:@selector(test) withObject:nil waitUntilDone:NO];
    
// æ–¹æ¡ˆäºŒ : åœ¨å­çº¿ç¨‹ä¸­æ‰‹åŠ¨å¯åŠ¨ RunLoop
NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
[self performSelector:@selector(test) withObject:nil afterDelay:5.0];
[runLoop run];
```

:::

### â“ä¸‹é¢ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆ

```objc
@property (nonatomic, strong) NSString *target;
//....

dispatch_queue_t queue = dispatch_queue_create("parallel", DISPATCH_QUEUE_CONCURRENT);
for (int i = 0; i < 1000000 ; i++) {
	dispatch_async(queue, ^{
     	self.target = [NSString stringWithFormat:@"ksddkjalkjd%d",i];
	});
}
```

::: details ğŸ’¡

è¿™æ®µä»£ç åœ¨ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ— ("parallel") ä¸Šå¼‚æ­¥åœ°å¤šæ¬¡æ‰§è¡Œä¸€ä¸ª BLOCKã€‚æ¯æ¬¡ BLOCK æ‰§è¡Œæ—¶,ä¼šæŠŠ self.target çš„å€¼è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚å› ä¸ºè¿™æ˜¯åœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šæ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™äº›è®¾ç½® self.target çš„æ“ä½œå¯èƒ½åŒæ—¶æ‰§è¡Œã€‚

è¿™ä¼šå¼•èµ·çº¿ç¨‹å®‰å…¨çš„é—®é¢˜â€”â€”æ•°æ®ç«äº‰ (data race)ã€‚ç”±äº setter æœ¬è´¨ä¸Šæ˜¯è¯»å–+å†™å…¥ä¸¤ä¸ªæ“ä½œï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œè¿™ä¸¤ä¸ªæ“ä½œï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚è¿™å°±æ˜¯æ‰€è°“çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

åŒæ—¶ï¼Œä¸ç¡®å®šçš„å¹¶å‘æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æš´æ¶¨ã€‚dispatch_asyncçš„blockï¼Œä¼šè¢«dispatch_retainï¼Œç„¶åè¢«å­˜å‚¨èµ·æ¥ç­‰å¾…æ‰§è¡Œã€‚å¦‚æœå¹¶è¡Œé˜Ÿåˆ—ä¸­blockå‰§å¢ï¼Œæœªæ‰§è¡Œçš„blockå¯èƒ½ä¼šç§¯å‹ï¼Œå¯¼è‡´å¤§é‡å†…å­˜æ¶ˆè€—ã€‚

å› æ­¤å¯¹äºæ¶‰åŠå¤šçº¿ç¨‹è®¿é—®å’Œä¿®æ”¹çš„å±æ€§ï¼Œåº”è¯¥å¼•å…¥çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼Œå¦‚ä½¿ç”¨ `@synchronized(self)`ã€`dispatch_semaphore_t`ï¼ˆä¿¡å·é‡ï¼‰ç­‰æ¥é˜²æ­¢æ•°æ®ç«äº‰ã€‚å½“ç„¶ï¼Œè€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…å¤§é‡è¯»å†™åŒä¸€ä¸ªå…±äº«èµ„æºã€‚

:::