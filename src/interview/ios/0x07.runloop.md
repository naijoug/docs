---
title: RunLoop
icon: hashtag

index: true

---

  > è¿è¡Œå¾ªç¯

<!-- more -->

## RunLoop

### â“`RunLoop` æœ‰å‡ ç§äº‹ä»¶æºï¼Œæœ‰å‡ ç§æ¨¡å¼

::: details ğŸ’¡

  `RunLoop` æ˜¯ç”¨æ¥ç®¡ç†äº‹ä»¶å’Œå¤„ç† `IO` çš„åŸºæœ¬æ¶æ„
  
äº‹ä»¶æº

  - `Timer`ï¼šå®šæ—¶å™¨äº‹ä»¶
    > `RunLoop` æŒ‰ç…§è®¾å®šçš„æ—¶é—´åŒºé—´æ¥æ”¶å®šæ—¶å™¨äº‹ä»¶ã€‚
    
  - `Source`ï¼šè¾“å…¥æºäº‹ä»¶
    > åŒ…æ‹¬ä¸¤ç§ç±»å‹ï¼š`source0 & source1`
    * source0 : è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±ç”Ÿæˆå’Œç®¡ç†ã€‚
    * source1 ï¼š åŸºäº `Port` çš„è¾“å…¥æºï¼Œæ¥æ”¶æ¥è‡ªå…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨å½“å‰çº¿ç¨‹ä¸Šè°ƒç”¨æŒ‡å®šçš„å¤„ç†æ–¹æ³•ã€‚
    
  - `Observer`ï¼šè§‚å¯Ÿè€…äº‹ä»¶
    > å¯ä»¥è®¾ç½®åœ¨ `RunLoop` å„ä¸ªè¿è¡Œé˜¶æ®µæ¥æ”¶çš„äº‹ä»¶ã€‚
    
è¿è¡Œæ¨¡å¼

  - `NSDefaultRunLoopMode`ï¼ˆ`kCFRunLoopDefaultMode`ï¼‰ï¼šé»˜è®¤æ¨¡å¼
    > å¦‚æœä¸æ‰‹åŠ¨æŒ‡å®šæ¨¡å¼ï¼Œ`RunLoop` å°±åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹è¿è¡Œã€‚
    
  - `UITrackingRunLoopMode`ï¼šç•Œé¢è·Ÿè¸ªæ¨¡å¼
    > ç”¨äº `ScrollView` æ»šåŠ¨æ—¶ã€‚
    
  - `UIInitializationRunLoopMode`ï¼šå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„æ¨¡å¼
    > å¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚
    
  - `NSRunLoopCommonModes`ï¼ˆ`kCFRunLoopCommonModes`ï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªå ä½æ¨¡å¼ï¼Œä¸æ˜¯ä¸€ç§çœŸæ­£çš„ Modeã€‚
    > å¯ä»¥å°†äº‹ä»¶æºï¼ˆ`Timer/Observer/Source`ï¼‰æ·»åŠ åˆ° `CommonModes` ä¸­ï¼Œ`RunLoop` è¿è¡Œåœ¨å“ªç§ `Mode` æ—¶ï¼Œåªè¦è¿™ç§ `Mode` è¢«æ ‡è®°ä¸º `Common` çš„å±æ€§ï¼Œåˆ™ `RunLoop` å°±ä¼šå¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚
    
:::

### â“`Runloop` å†…éƒ¨å®ç°é€»è¾‘

::: details ğŸ’¡

  `RunLoop` çš„å†…éƒ¨å®ç°å¯ä»¥ç®€å•åœ°æ¦‚æ‹¬ä¸ºä¸€ä¸ª `while` å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­å¤„ç†å„ç§è¾“å…¥æºçš„äº‹ä»¶ã€‚`RunLoop` åœ¨å¼€å¯åä¼šä¸€ç›´åœ¨è¿™ä¸ªå¾ªç¯ä¸­æ‰§è¡Œï¼Œç›´åˆ°æ¥æ”¶åˆ°åœæ­¢ `RunLoop` çš„æ¶ˆæ¯ã€‚
    
  - `RunLoop` åœ¨å¯åŠ¨æ—¶ä¼šä»é¢„è®¾çš„ `Mode` ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œç„¶åè¿›å…¥ `RunLoop` çš„å¾ªç¯ã€‚
  
  - è¿›å…¥å¾ªç¯å‘¨æœŸ
    * é¦–å…ˆï¼Œå¤„ç†æ‰€æœ‰åˆ°æœŸçš„å®šæ—¶å™¨äº‹ä»¶ã€‚
    * ç„¶åï¼Œå¤„ç†æ‰€æœ‰çš„è¾“å…¥æºäº‹ä»¶ã€‚è¾“å…¥æºçš„äº‹ä»¶åŒ…æ‹¬æ¥è‡ª `Port` çš„æ¶ˆæ¯ï¼Œä»¥åŠç”¨æˆ·å®šä¹‰çš„å…¶ä»–äº‹ä»¶ã€‚
    * ç„¶åï¼Œå¦‚æœæœ‰è§‚å¯Ÿè€…çš„è¯ï¼Œ`RunLoop` ä¼šé€šçŸ¥è§‚å¯Ÿè€…å½“å‰ `RunLoop` çš„çŠ¶æ€ã€‚
    * æœ€åï¼Œå¦‚æœåœ¨å¤„ç†äº‹ä»¶çš„è¿‡ç¨‹ä¸­æ²¡æœ‰ä»»ä½•æºéœ€è¦å¤„ç†ï¼Œé‚£ä¹ˆ `RunLoop` ä¼šè¿›å…¥ä¼‘çœ ç­‰å¾…è¢«å”¤é†’ã€‚
  
  - ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œç›´åˆ°æ¥æ”¶åˆ°ç»“æŸ `RunLoop` çš„æ¶ˆæ¯ã€‚

:::

### â“`Runloop` åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·

::: details ğŸ’¡

  `Runloop` çš„åº•å±‚å®ç°é›†ä¸­åœ¨ `NSRunLoop`ï¼ˆ`Objective-C`ï¼‰å’Œ `CFRunLoop`ï¼ˆ`C`ï¼‰ä¸¤ä¸ªç±»ä¸­ã€‚å®ƒä»¬åœ¨ç»“æ„ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æä¾›ç»™å¼€å‘è€…ä½¿ç”¨çš„æ¥å£ä¸åŒã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è®¨è®ºçš„æ˜¯ `CFRunLoop` çš„ç»“æ„ï¼Œå› ä¸º `NSRunLoop` å®é™…ä¸Šæ˜¯å¯¹å®ƒçš„ä¸€å±‚å°è£…ã€‚

åº•å±‚æ•°æ®ç»“æ„ä¸»è¦åŒ…æ‹¬è¿™å‡ éƒ¨åˆ†ï¼š

- **Runloop**ï¼šæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æœ‰ä¸€ä¸ªå¯¹åº”çš„ `RunLoop`ï¼Œä½†æ˜¯ `RunLoop` å¿…é¡»åœ¨è‡ªå·±çš„çº¿ç¨‹ä¸­è¿è¡Œã€‚`RunLoop` å¯¹è±¡åŒ…å«äº†ä¸€ç»„ `RunLoopMode`ï¼Œ`Mode` ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼ŒåŒæ—¶åªèƒ½è¿è¡Œåœ¨ä¸€ä¸ª `Mode`ã€‚

- **Mode**ï¼šæ¯ä¸€ä¸ª `RunLoopMode` åŒ…å«äº†ä¸€ç»„ `Source`ã€`Timer`ã€ä»¥åŠ `Observer`ã€‚

    * **Source**ï¼šæºæ˜¯ `RunLoop` äº‹ä»¶çš„äº§ç”Ÿè€…ã€‚`Source` åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š`Source0` å’Œ `Source1`ã€‚`Source0` åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè€Œ `Source1` è¿˜åŒ…å«äº†ä¸€ä¸ª `mach_port` å’Œä¸€ä¸ªå›è°ƒï¼Œå¹¶ä¸” `Source1` èƒ½ä¸»åŠ¨å”¤é†’ `RunLoop`ã€‚
    * **Timer**ï¼šåŸºäºæ—¶é—´çš„è§¦å‘å™¨ï¼Œå®ƒå’Œ `NSTimer` æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ç»™ `NSTimer` è®¾ç½®çš„ `RunLoopMode` å®è´¨ä¸Šæ˜¯è®¾ç½®äº† `Timer` æ‰€åœ¨çš„ `Mode`ã€‚
    * **Observer**ï¼šè§‚å¯Ÿè€…ï¼Œä¸€ç§å¯ä»¥æ’å…¥ `RunLoop` ä¸­ä»¥æ–¹ä¾¿å¼€å‘è€…åœ¨ç‰¹å®šæ—¶æœºåšé¢å¤–å¤„ç†çš„ä¸œè¥¿ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ `beforeWaiting`ã€`afterWaiting` ç­‰ã€‚

- **ModeItems**ï¼š`Mode` ä¸­ `Source`ã€`Timer` å’Œ `Observer` ç»Ÿç§°ä¸º `ModeItems`ï¼Œå½“å®ƒä»¬è¢«æ³¨å†Œåˆ° `RunLoop` ä¸­ï¼Œä»–ä»¬å°±ä¼šè¢«æ·»åŠ åˆ°å½“å‰ `RunLoop` çš„å½“å‰ `Mode` ä¸‹ã€‚å½“ä¸€ä¸ª `Mode` çš„æ‰€æœ‰ `Items` éƒ½è¢«æ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ `RunLoop` å°±ä¼šè¿›è¡Œé€šçŸ¥æˆ–è€…æ˜¯è¿›å…¥ç¡çœ ç­‰å¾…ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„å¤„ç†ã€‚

- **CommonModes**ï¼šä¸ºäº†å¯ä»¥è®©ä¸€äº› `ModeItems` åœ¨å¤šä¸ª `Mode` ä¸­å…±äº«ï¼Œ`RunLoop` æä¾›äº† `CommonModes` è¿™ç§æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç»„ `Mode` çš„é›†åˆã€‚æˆ‘ä»¬å¯ä»¥å°† `ModeItems` æ·»åŠ è¿› `CommonModes` ä¸­ã€‚

:::

### â“`Runloop` ç›‘å¬çŠ¶æ€æœ‰å“ªå‡ ç§

::: details ğŸ’¡

é€šè¿‡ä½¿ç”¨ `CFRunLoopObserver` å¯ä»¥ç›‘å¬ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š

- **kCFRunLoopEntry** (å³å°†è¿›å…¥ Loop)ï¼šå³å°†è¿›å…¥è¿è¡Œå¾ªç¯çŠ¶æ€ã€‚

- **kCFRunLoopBeforeTimers** (å³å°†å¤„ç† Timer)ï¼šå³å°†å¤„ç† Timer å›è°ƒã€‚

- **kCFRunLoopBeforeSources** (å³å°†å¤„ç† Source)ï¼šå³å°†å¤„ç† Sourceã€‚

- **kCFRunLoopBeforeWaiting** (å³å°†è¿›å…¥ä¼‘çœ )ï¼šå³å°†è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

- **kCFRunLoopAfterWaiting** (è¢«å”¤é†’ï¼Œä½†åœ¨å¤„ç†äº‹ä»¶ä¹‹å‰)ï¼šè¢«å”¤é†’å¹¶å³å°†å¼€å§‹å¤„ç†äº‹ä»¶ã€‚

- **kCFRunLoopExit** (å³å°†é€€å‡º Loop)ï¼šå³å°†é€€å‡ºã€‚

:::

### â“`Runloop` å·¥ä½œæµç¨‹å¤§æ¦‚æ˜¯ä»€ä¹ˆæ ·çš„

::: details ğŸ’¡

`RunLoop` çš„å·¥ä½œæµç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨å¾ªç¯å†…éƒ¨ä¸æ–­åœ°æ£€æŸ¥å’Œå¤„ç†æ¥è‡ªæºï¼ˆ`Source`ï¼‰ã€å®šæ—¶å™¨ï¼ˆ`Timer`ï¼‰å’Œè§‚å¯Ÿè€…ï¼ˆ`Observer`ï¼‰çš„äº‹ä»¶æˆ–æ¶ˆæ¯ã€‚
  
å¯¹äºäº‹ä»¶çš„å¤„ç†é¡ºåºï¼Œ`RunLoop` éµå¾ªä»¥ä¸‹çš„åŸºæœ¬è§„åˆ™ï¼š
  
  - é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ŒRunLoop å·²ç»å¯åŠ¨ï¼ˆ`kCFRunLoopEntry`ï¼‰ã€‚
  
  - é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œå³å°†å¤„ç†å®šæ—¶å™¨äº‹ä»¶ï¼ˆ`kCFRunLoopBeforeTimers`ï¼‰ã€‚
  
  - é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œå³å°†å¤„ç†è¾“å…¥æºäº‹ä»¶ï¼ˆ`kCFRunLoopBeforeSources`ï¼‰ã€‚
  
  - å¦‚æœåœ¨å¤„ç†è¾“å…¥æºçš„æ—¶å€™ï¼Œæœ‰è¾“å…¥æºå°†å…¶æ ‡è®°ä¸º "å¾…å”¤é†’"ï¼ŒRunLoop å°±ä¼šè·³è½¬åˆ°ç¬¬äºŒæ­¥ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚
  
  - é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œå³å°†å¼€å§‹ä¼‘çœ ï¼ˆ`kCFRunLoopBeforeWaiting`ï¼‰ã€‚

  - ç„¶å RunLoop è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚

  - å¦‚æœ RunLoop è¢«å”¤é†’ï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ŒRunLoop å·²ç»è¢«å”¤é†’ä¸”åœ¨å¤„ç†äº‹ä»¶ä¹‹å‰ï¼ˆ`kCFRunLoopAfterWaiting`ï¼‰ã€‚ç„¶åå¤„ç†å”¤é†’å®ƒçš„äº‹ä»¶ï¼ˆå¯èƒ½æ˜¯å®šæ—¶å™¨äº‹ä»¶æˆ–è€…è¾“å…¥æºäº‹ä»¶ï¼‰ï¼Œå¤„ç†å®Œæˆåï¼Œè¿›å…¥ç¬¬äºŒæ­¥ã€‚

  - é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ŒRunLoop å³å°†é€€å‡ºï¼ˆ`kCFRunLoopExit`ï¼‰ã€‚
  
:::

### â“`Runloop` æœ‰å“ªäº›åº”ç”¨

::: details ğŸ’¡

  åœ¨ `iOS` å¼€å‘ä¸­ `RunLoop` æœ‰è®¸å¤šå¸¸è§çš„åº”ç”¨ï¼Œåƒæ˜¯å¤„ç†ç”¨æˆ·è§¦æ‘¸äº‹ä»¶ã€å¤„ç†è®¡æ—¶å™¨äº‹ä»¶ã€è¿›è¡Œç½‘ç»œè¯·æ±‚ä»¥åŠå…¶ä»–ä¸€äº›å…³é”®çš„ç³»ç»Ÿäº‹ä»¶ã€‚

ä»¥ä¸‹åˆ—å‡ºä¸€äº›å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼š

-  **å®šæ—¶å™¨**
    > å®šæ—¶å™¨çš„å®ç°ä¾æ‰˜äº `RunLoop`ã€‚å¦‚æœä¸€ä¸ª `NSTimer` æ²¡æœ‰æ·»åŠ åˆ° `RunLoop`ï¼Œé‚£ä¹ˆå®šæ—¶å™¨äº‹ä»¶åˆ™ä¸ä¼šè¢«è§¦å‘ã€‚å› æ­¤èƒ½å¤Ÿç”¨ `RunLoop` æ¥æ§åˆ¶å®šæ—¶å™¨çš„è§¦å‘é¢‘ç‡ã€‚

- **UI åˆ·æ–°**
    > å½“æ›´æ”¹ `UIView` çš„å±æ€§ï¼ˆæ¯”å¦‚ `frame`ï¼‰ä»¥é‡æ–°å¸ƒå±€è§†å›¾æ—¶ï¼Œå®é™…ä¸Šæ›´æ”¹å¹¶ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ˜¯ä¼šè¢«æ”¾åœ¨ä¸€ä¸ª `UI` æ›´æ–°é˜Ÿåˆ—é‡Œï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡ `RunLoop` æ—¶ï¼Œç³»ç»Ÿä¼šä»é˜Ÿåˆ—ä¸­å–å‡ºè¿™äº›æ›´æ”¹å¹¶ä¸€æ¬¡æ€§å…¨éƒ¨æ¸²æŸ“åˆ°å±å¹•ä¸Šã€‚

- **å»¶è¿Ÿæ˜¾ç¤º**
    > `RunLoop` ä¹Ÿå¯ä»¥ç”¨äºæ§åˆ¶ `UI` çš„å»¶è¿Ÿæ˜¾ç¤ºã€‚
    
    ```swift
    [self performSelector:@selector(myMethod) withObject:nil afterDelay:3.0];
    ```

- **å¸¸é©»çº¿ç¨‹**
    > çº¿ç¨‹ä¸€æ—¦å®Œæˆä»»åŠ¡ï¼Œå®ƒå°±ä¼šé€€å‡ºã€‚è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šåšçš„æ‰€æœ‰è®¾ç½®ï¼ˆä¾‹å¦‚åˆå§‹åŒ–å˜é‡ï¼Œæ‰“å¼€æ•°æ®åº“ç­‰ï¼‰ï¼Œéƒ½ä¼šéšç€çº¿ç¨‹çš„é€€å‡ºè€Œå¤±æ•ˆã€‚ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡è®© `RunLoop` å»è¿è¡Œï¼Œä½¿å¾—è¿™ä¸ªçº¿ç¨‹èƒ½ä¸€ç›´å­˜åœ¨ï¼Œä¸ä¼šç»“æŸï¼Œè¿™å°±æ˜¯å¸¸é©»çº¿ç¨‹ã€‚è¿™ç§æŠ€å·§å¸¸å¸¸ç”¨äºç½‘ç»œè¯·æ±‚æˆ–è€…åå°ä»»åŠ¡ã€‚

- **å¤„ç†è§¦æ‘¸äº‹ä»¶**
    > åœ¨ `iOS` åº”ç”¨ç¨‹åºä¸­ï¼Œ`RunLoop` ä¹Ÿè¢«ç”¨æ¥å¤„ç†ç”¨æˆ·çš„è§¦æ‘¸äº‹ä»¶ã€‚å½“ç”¨æˆ·è§¦æ‘¸å±å¹•æ—¶ï¼Œç³»ç»Ÿä¼šå°†è§¦æ‘¸äº‹ä»¶åŠ å…¥åˆ°ä¸» `RunLoop` ä¸­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç”¨æˆ·çš„è§¦æ‘¸äº‹ä»¶å¾—åˆ°åŠæ—¶çš„å“åº”ã€‚

- **å›¾ç‰‡æ‡’åŠ è½½ä¸å¤§é‡æ•°æ®å¤„ç†**
    > ä¾‹å¦‚åœ¨æ»šåŠ¨ loading å¤§å›¾æ—¶ï¼Œä¸ºäº†ä¿è¯æµç•…æ€§ï¼Œé€šå¸¸å›¾ç‰‡çš„åŠ è½½å’Œè§£ç æ“ä½œä¼šåœ¨åå°è¿›è¡Œï¼Œç„¶ååœ¨ `RunLoop` çš„ç©ºé—²æ—¶é—´ï¼ŒæŠŠè§£ç åçš„å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥ã€‚

:::

------

## çº¿ç¨‹

### iOS çº¿ç¨‹å¯åŠ¨ï¼Œå¿…é¡»è¦å¯åŠ¨ Runloop å—

::: details ğŸ’¡

  åœ¨ `iOS` ä¸­ï¼Œçº¿ç¨‹å¯åŠ¨å¹¶ä¸ä¸€å®šéœ€è¦å¯åŠ¨ `RunLoop`ã€‚`RunLoop` å¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„ç»„ä»¶ï¼Œåªæœ‰å½“éœ€è¦åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­è¿›è¡ŒæŸäº›ç‰¹å®šçš„ä»»åŠ¡ï¼Œå¦‚ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€å®šæ—¶ä»»åŠ¡ã€ç½‘ç»œè¯·æ±‚ç­‰æ—¶æ‰éœ€è¦å¯åŠ¨ã€‚

  é™¤äº†ä¸»çº¿ç¨‹ï¼Œæ–°åˆ›å»ºçš„å­çº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰å¼€å¯ `RunLoop` çš„ã€‚ä¸»çº¿ç¨‹ä¹‹æ‰€ä»¥æœ‰ `RunLoop`ï¼Œæ˜¯å› ä¸ºåœ¨åº”ç”¨å¯åŠ¨æ—¶ `UIKit` è‡ªåŠ¨å¸®ä½ åˆ›å»ºå’Œå¯åŠ¨äº†ã€‚`RunLoop` æ˜¯` Objective-C` å’Œ `Swift` çš„è¿è¡Œæ—¶ç¯å¢ƒåœ¨ä¸»çº¿ç¨‹é»˜é»˜å¼€å¯äº†çš„ä¸€ä¸ªäº‹ä»¶å¤„ç†å¾ªç¯ï¼Œæ¥å¤„ç†å„ç§äº‹ä»¶ã€‚

  è‹¥éœ€è¦å®æ—¶åˆ·æ–° `UI`ï¼Œæ›´æ–° `UI` çŠ¶æ€æˆ–è€…å®Œæˆè¾ƒä¸ºå¤æ‚çš„ç½‘ç»œäº¤äº’ä»»åŠ¡ï¼Œå¾ˆå¤šæ—¶å€™å°±éœ€è¦å¼€å¯å­çº¿ç¨‹çš„ `RunLoop`ã€‚ä¾‹å¦‚ï¼Œåœ¨æ–°çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨ï¼Œæ˜¯éœ€è¦å¼€å¯ `RunLoop` çš„ã€‚å› ä¸º `NSTimer` å®é™…ä¸Šæ˜¯æ³¨å†Œåˆ° `RunLoop` ä¸Šçš„ï¼Œé€šè¿‡ `RunLoop` æ¥ç›‘æ§æ—¶é—´å˜åŒ–å¹¶è°ƒåº¦ä»»åŠ¡çš„ã€‚

:::

### å“ªäº›æƒ…å†µä¸‹ï¼Œçº¿ç¨‹éœ€è¦å¯åŠ¨ RunLoop

::: details ğŸ’¡

- å®šæ—¶å™¨ï¼šå¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨ï¼ˆ`NSTimer`ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹çš„ `RunLoop` éœ€è¦è¢«å¯åŠ¨ã€‚å› ä¸ºå®šæ—¶å™¨äº‹ä»¶æ˜¯ç”± `RunLoop` è°ƒåº¦å’Œå¤„ç†çš„ã€‚

- å¼‚æ­¥ä»»åŠ¡ï¼šå½“åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œå¯èƒ½éœ€è¦ `RunLoop` æ¥å¸®åŠ©ç­‰å¾…æˆ–è€…é©±åŠ¨æŸäº›äº‹ä»¶å‘ç”Ÿã€‚

- ç½‘ç»œè¯·æ±‚ï¼šå½“ä½¿ç”¨æŸäº›ç½‘ç»œ `API`ï¼ˆå¦‚ `NSURLConnection`ï¼‰æ—¶ï¼Œéœ€è¦åœ¨çº¿ç¨‹çš„ `RunLoop` ä¸­è¿è¡Œè¯·æ±‚ã€‚

- ç•Œé¢æ›´æ–°ï¼šå½“ä½ éœ€è¦å®šæœŸæ›´æ–° `UI` æˆ–è€…å¤„ç†ç”¨æˆ·äº¤äº’æ—¶ï¼Œä¹Ÿéœ€è¦å¯åŠ¨ `RunLoop`ã€‚ 

- ç³»ç»Ÿå†…éƒ¨çš„ä¸€äº›ä»»åŠ¡ï¼šæ¯”å¦‚è¯´ç›‘å¬ `NSObject` å¯¹è±¡çš„ `performSelector:withObject:afterDelay:` æ–¹æ³•ï¼Œ`RunLoop` å°±éœ€è¦å¯åŠ¨æ¥ç›‘å¬å’Œå¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚

- ä½¿ç”¨ `GCD` æˆ–è€… `NSOperation` å°†ä»»åŠ¡æ”¾å…¥åˆ°å…¶ä»–çº¿ç¨‹çš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªä»»åŠ¡å’Œç”¨æˆ·äº¤äº’ã€å®šæ—¶å™¨ç­‰æœ‰å…³ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯åŠ¨ `RunLoop`ã€‚

- åœ¨å­çº¿ç¨‹ä¸­éœ€è¦é•¿è¿æ¥çš„æ—¶å€™ï¼Œéœ€è¦å¯åŠ¨ `RunLoop` æ¥ä¿æŒçº¿ç¨‹çš„å­˜æ´»ã€‚

- æ–‡æœ¬è¾“å…¥ï¼šæ»‘åŠ¨è§†å›¾ç­‰å“åº”ç”¨æˆ·äº¤äº’äº‹ä»¶æ—¶ï¼Œéœ€è¦è¿›è¡Œå¤§é‡è®¡ç®—ï¼ˆä¾‹å¦‚æ–‡æœ¬å¸ƒå±€ï¼‰ï¼Œéœ€æŠŠä»»åŠ¡æ”¾åœ¨å­çº¿ç¨‹å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿéœ€è¦å¯åŠ¨çº¿ç¨‹çš„ `RunLoop`ã€‚

:::

------

## performSelector

### â“`runloop` ä¸ `performSelector` çš„å…³ç³»

::: details ğŸ’¡

  `RunLoop` å’Œ `performSelector` ä¹‹é—´çš„å…³ç³»æ˜¯å¯†åˆ‡çš„ã€‚`RunLoop` åœ¨ `iOS` ä¸­å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­ä¸æ–­åœ°å¤„ç†å„ç§äº‹ä»¶ï¼Œå¦‚ `UI` è§¦æ‘¸äº‹ä»¶ï¼Œå®šæ—¶å™¨äº‹ä»¶ï¼Œ`selector` äº‹ä»¶ç­‰ã€‚`performSelector` å°±æ˜¯ `RunLoop` çš„ä¸€ç§åº”ç”¨æ–¹å¼ã€‚

`performSelector` æ˜¯ `NSObject` çš„ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œç”¨äºåœ¨å½“å‰çº¿ç¨‹æˆ–æŒ‡å®šçº¿ç¨‹ä¸Šæ‰§è¡Œä¸€ä¸ªæŒ‡å®šçš„æ–¹æ³•ã€‚è¿è¡Œè¿™ä¸ªæ–¹æ³•ä¼šå‘ `Runloop` æ·»åŠ ä¸€ä¸ª `selector`ï¼Œ`Runloop` åœ¨å¤„ç†çš„æ—¶å€™ä¼šæ£€æŸ¥æ‰€æœ‰å¾…å¤„ç†çš„ `selector` å¹¶é€ä¸ªæ‰§è¡Œã€‚

```objc
[self performSelector:@selector(methodName) withObject:nil afterDelay:3.0];
```

å¦‚æœæŸä¸ªçº¿ç¨‹çš„è¿è¡Œå¾ªç¯ä¸è¢«å¯åŠ¨æˆ–è€…å·²ç»é€€å‡ºï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œçš„ `performSelector` æ–¹æ³•å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚ä¾‹å¦‚åœ¨å­çº¿ç¨‹ä¸­ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨ `RunLoop` çš„ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¯åŠ¨ `RunLoop`ã€‚

```objc
NSThread *thread = [[NSThread alloc] initWithTarget:self selector:@selector(testThread) object:nil];
[thread start];

- (void)testThread {
    NSLog(@"Enter Thread");
    
    // å®šæ—¶å™¨éœ€è¦æ·»åŠ åˆ° RunLoop åæ‰ä¼šè¿è¡Œ
    NSTimer *timer = [NSTimer timerWithTimeInterval:1.0 target:self selector:@selector(timerRun) userInfo:nil repeats:YES];
    [[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];
    
    // åœ¨æ²¡æœ‰ timer æˆ–è€… performSelector æƒ…å†µä¸‹å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä¿æŒ runloop è¿è¡Œ
    // [[NSRunloop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];
    
    NSLog(@"Exit Thread");
}
```

:::

### â“`performSelector` çš„å®ç°åŸç†

::: details ğŸ’¡

  `performSelector` æ–¹æ³•æ˜¯ `Objective-C` é‡Œé¢åŠ¨æ€æ–¹æ³•é€‰æ‹©æœºåˆ¶çš„ä¸€ä¸ªä½“ç°ã€‚å®ç°åŸç†ä¸»è¦æ˜¯åŸºäº `Objective-C` çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚å½“è°ƒç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å‘è¿™ä¸ªå¯¹è±¡å‘é€ä¸€ç§å«åš `selector` çš„æ¶ˆæ¯ã€‚

  - é€šè¿‡ `SEL` ç±»å‹çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯ `selector`ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼‰æ‰¾åˆ°æ–¹æ³•çš„å®ç°ï¼ˆ`IMP`ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯å‡½æ•°æŒ‡é’ˆï¼‰ã€‚

  - ç„¶åæ ¹æ®è¿™ä¸ªå‡½æ•°æŒ‡é’ˆå’Œä¼ å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ã€‚

åœ¨è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿›è¡Œäº† `performSelector:withObject:afterDelay:` è°ƒç”¨ï¼Œå®é™…ä¸Šå†…éƒ¨å®ç°æ˜¯æŠŠè¿™ä¸ªè°ƒç”¨åŒ…è£…ä¸ºäº†ä¸€ä¸ª `Timer`ï¼Œæ·»åŠ åˆ°äº†å½“å‰çš„ `RunLoop` ä¸­ã€‚ç„¶ååœ¨ `RunLoop` è½®è¯¢çš„è¿‡ç¨‹ä¸­ç¢°åˆ°äº†é¢„è®¾çš„æ—¶é—´ç‚¹ï¼Œå°±ä¼šè°ƒç”¨å¯¹åº”çš„ `selector`ã€‚å¦å¤–å¦‚ä¼ å…¥çš„ `SEL` å¯¹è±¡æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œä¼šå¼‚å¸¸å´©æºƒï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ï¼Œè¦ç‰¹åˆ«æ³¨æ„æ–¹æ³•åŒ¹é…é—®é¢˜ã€‚

  è¿™ç§åŠ¨æ€è°ƒç”¨æ–¹æ³•çš„æ–¹å¼è®© `Objective-C` çš„çµæ´»æ€§å¤§å¤§æå‡ï¼Œå¯ä»¥æ›´å¥½åœ°é€‚åº”å„ç§å˜åŒ–çš„éœ€æ±‚ï¼Œåœ¨ `Objective-C` ä¸­å†æåˆ°çš„ â€œé¸­å­ç±»å‹â€ å°±æ˜¯è¿™å—çµæ´»æ€§çš„ä¸€ç§ä½“ç°ã€‚

:::

### â“`performSelector` vs `NSInvocation`

::: details ğŸ’¡

  `performSelector` æ–¹æ³•å’Œ `NSInvocation` è¿™ä¸¤ä¸ªéƒ½å¯ä»¥ç”¨äºåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è°ƒç”¨æ–¹æ³•ï¼Œä½†å®ƒä»¬ä¹‹é—´æœ‰ä¸€äº›æ˜æ˜¾çš„åŒºåˆ«ã€‚

- **å‚æ•°çš„ä¸ªæ•°å’Œç±»å‹**ï¼š`performSelector` åªèƒ½æ¥å—æœ€å¤šä¸¤ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå‚æ•°éƒ½å¿…é¡»æ˜¯å¯¹è±¡ç±»å‹ã€‚å¦‚æœä½ è¦è°ƒç”¨çš„æ–¹æ³•æœ‰æ›´å¤šçš„å‚æ•°ï¼Œæˆ–è€…å‚æ•°ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆå°±å¿…é¡»ä½¿ç”¨ `NSInvocation`ã€‚

- **è¿”å›å€¼**ï¼š`performSelector` çš„è¿”å›å€¼å›ºå®šä¸º `id` ç±»å‹ï¼Œå¯¹äºè¿”å›å€¼ä¸ºåŸºç¡€æ•°æ®ç±»å‹çš„å‡½æ•°ï¼Œä½¿ç”¨ `performSelector` å¯èƒ½å‡ºç°æ­§ä¹‰ã€‚è€Œå¯¹äº `NSInvocation` æ¥è¯´ï¼Œè¿”å›å€¼çš„ç±»å‹å¯ä»¥æ ¹æ®ä½ ä¼ å…¥çš„ `Method Signature` æ¥ç¡®å®šï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

- **å¯è¯»æ€§**ï¼š `performSelector` å¯è¯»æ€§æ›´å¥½ï¼Œè€Œ `NSInvocation` çš„å‚æ•°ã€è¿”å›å€¼çš„å¤„ç†ä»¥åŠæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ç›¸å¯¹å¤æ‚ï¼Œä¼šå½±å“ä»£ç çš„å¯è¯»æ€§ã€‚

- **æ€§èƒ½**ï¼š`performSelector` ç›¸æ¯”äº `NSInvocation` åœ¨æ€§èƒ½ä¸Šæ›´ä¼˜äº›ï¼Œå› ä¸º `NSInvocation` åœ¨è®¾ç½®è¿”å›å€¼ã€è·å–è¿”å›å€¼ã€å‚æ•°è®¾ç½®ç­‰æ–¹é¢éœ€è¦ç»è¿‡åŒ…è£…å’Œè½¬æ¢ã€‚

é€šå¸¸ï¼Œä½¿ç”¨ `performSelector` å·²ç»å¯ä»¥æ»¡è¶³å¤§éƒ¨åˆ†çš„éœ€æ±‚ï¼Œå¯¹äºä¸€äº›æ›´å¤æ‚çš„æƒ…å†µï¼Œæ¯”å¦‚å‡½æ•°å‚æ•°ä¸ªæ•°ä¸å®šï¼Œæœ‰åŸºç¡€æ•°æ®ç±»å‹å‚æ•°æˆ–è¿”å›å€¼ç­‰ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨åˆ° `NSInvocation`ã€‚

:::

### â“ä»¥ä¸‹ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆ

  ```objc
  NSLog(@"1");
  dispatch_async(dispatch_get_global_queue(0, 0), ^{
    NSLog(@"2");
    [self performSelector:@selector(test) withObject:nil afterDelay:10];
    NSLog(@"3");
  });
  NSLog(@"4");
  - (void)test {
    NSLog(@"5");
  }
  ```

::: details ğŸ’¡

  > æ‰“å°é¡ºåº : 1, 4, 2, 3

  "1"å’Œ"4"æ˜¯æ™®é€šçš„ç›´æ¥æ‰§è¡Œä»£ç ï¼Œå› æ­¤ä¼šæŒ‰ç…§é¡ºåºè¾“å‡ºã€‚
  
  "2"å’Œ"3"ä½äºå¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œä¼šåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šåœ¨"1"å’Œ"4"ä¹‹åå¼€å§‹æ‰§è¡Œã€‚

  "5"ä¸ä¼šè¾“å‡ºã€‚åŸå› æ˜¯`[self performSelector:@selector(test) withObject:nil afterDelay:10];`è¿™ä¸€è¡Œä»£ç è¢«æ”¾åœ¨å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼æ˜¯ä¾èµ– `RunLoop` çš„ï¼Œè€Œæ–°åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨ `RunLoop` çš„ï¼Œæ‰€ä»¥`performSelector:afterDelay:`æ–¹æ³•ä¼šå¤±æ•ˆã€‚

:::

  > å¦‚æœæƒ³è¦ä½¿ "5" èƒ½å¤Ÿæ‰“å°ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ

::: details ğŸ’¡   
 
  ```objc
  // æ–¹æ¡ˆä¸€ : æ”¾å…¥ä¸»çº¿ç¨‹ RunLoop
  [self performSelectorOnMainThread:@selector(test) withObject:nil waitUntilDone:NO];
    
  // æ–¹æ¡ˆäºŒ : åœ¨å­çº¿ç¨‹ä¸­æ‰‹åŠ¨å¯åŠ¨ RunLoop
  NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
  [self performSelector:@selector(test) withObject:nil afterDelay:5.0];
  [runLoop run];
  ```

:::