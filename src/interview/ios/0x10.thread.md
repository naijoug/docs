---
title: å¤šçº¿ç¨‹
icon: hashtag

index: true

---

<!-- more -->

## reference

- [Run repeating NSTimer with GCD?](https://stackoverflow.com/questions/10522928/run-repeating-nstimer-with-gcd)
- [2018-04-09 iOS Swift GCD å¼€å‘æ•™ç¨‹](https://juejin.im/post/5acaea17f265da239a601a01#heading-17)
- [2018-03-03 5 é“ iOS å¤šçº¿ç¨‹â€œé¢è¯•é¢˜â€](https://juejin.cn/post/6844903569322164232)
- [2017-08-25 ä»ä¸€é“ç½‘æ˜“é¢è¯•é¢˜æµ…è°ˆ Objective-C çº¿ç¨‹å®‰å…¨](https://nemocdz.github.io/post/%E4%BB%8E%E4%B8%80%E9%81%93%E7%BD%91%E6%98%93%E9%9D%A2%E8%AF%95%E9%A2%98%E6%B5%85%E8%B0%88-objective-c-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/)
- [2016-01-16 ä¸å†å®‰å…¨çš„ OSSpinLock](https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/)

------

## NSMachPort

### â“`NSMachPort` æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

> `NSMachPort` æ˜¯ä¸€ç§ç”¨äºè¿›ç¨‹é—´é€šä¿¡ï¼ˆ`IPC`ï¼‰çš„æœºåˆ¶ã€‚ `NSMachPort` å°è£…äº† `Mach`ï¼ˆæ“ä½œç³»ç»Ÿçš„ä½çº§å†…æ ¸ï¼‰ç«¯å£çš„æ“ä½œï¼Œå¹¶å°†å…¶æ•´åˆåˆ°åŸºç¡€åº“çš„ `Runloop` æœºåˆ¶ä¸­ï¼Œä½¿å¾—å¯¹ `Mach` ç«¯å£çš„æ“ä½œèƒ½æ–¹ä¾¿åœ°è¿›è¡Œã€‚

 `NSMachPort` æ˜¯ `NSPort` çš„å­ç±»ï¼Œå®ç°äº†å‘æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯çš„åŠŸèƒ½ã€‚`NSPort` å¯¹è±¡ä»£è¡¨ä¸€ç§ `IPC` æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç®¡ç†ä¸€å—å†…å­˜ï¼Œç”¨æ¥å­˜å‚¨æ¶ˆæ¯ã€‚

  å¯ä»¥ä½¿ç”¨ `NSMachPort` å¯¹è±¡åœ¨ç¨‹åºçš„ä¸åŒçº¿ç¨‹ä¹‹é—´æˆ–è·¨è¿‡ä¸åŒçš„ç¨‹åºè¿›è¡Œé€šä¿¡ã€‚å®ä¾‹åŒ–ä¸€ä¸ª `NSMachPort` å¯¹è±¡åï¼Œå¯ä»¥å°†è¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ª `RunLoop` ä¸­ï¼Œç„¶åå†é€šè¿‡è¿™ä¸ª `RunLoop` æ¥è¿›è¡Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ã€‚åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œ`RunLoop` ä¼šå°†å¤„ç†åŠ¨ä½œåˆ‡æ¢åˆ°ä¸è¿™ä¸ª `port` å…³è”çš„çº¿ç¨‹ä¸Šæ¥ã€‚

:::

### â“`Mach` æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

> `Mach` æ˜¯ä¸€ç§ç”¨äºå®ç°æ“ä½œç³»ç»Ÿçš„å¾®å†…æ ¸ï¼Œå¹¶ä¸”æ˜¯åŒ…æ‹¬ `iOS` å’Œ `macOS` åœ¨å†…çš„å¾ˆå¤šç°ä»£æ“ä½œç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚`Mach` å†…æ ¸å’Œå…¶ä»–çš„ä¸€äº›æœåŠ¡ï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰ä¸€èµ·ï¼Œè¢«åŒ…è£¹åœ¨ä¸€ä¸ªå«åš `XNU` çš„å¤§ä¸€ç‚¹çš„å†…æ ¸ä¸­ã€‚

  `Mach` æä¾›äº†ä¸€äº›åŸºç¡€çš„ã€ä½çº§åˆ«çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬çº¿ç¨‹ç®¡ç†ï¼Œè™šæ‹Ÿå†…å­˜ç®¡ç†å’Œè¿›ç¨‹é—´é€šä¿¡ (`IPC`)ã€‚å®ƒæœ‰åŠ©äºæŠŠè¿™äº›åº•å±‚ä»»åŠ¡ä»å…¶ä»–çš„ï¼Œæ›´é«˜çº§çš„ç³»ç»ŸæœåŠ¡ä¸­è¿›è¡Œåˆ†ç¦»ï¼Œä½¿å¾—æ“ä½œç³»ç»Ÿçš„ç»“æ„æ›´åŠ æ¸…æ™°ã€‚

  å°¤å…¶æ˜¯åœ¨è¿›ç¨‹é—´é€šä¿¡æ–¹é¢ï¼Œ`Mach` ä½¿ç”¨äº†ä¸€ç§å«åš `Mach Port` çš„æœºåˆ¶æ¥å®ç°çº¿ç¨‹æˆ–è€…è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚`Mach Port` å¼ºå¤§åˆ°å¯ä»¥å¤„ç†å¤§é‡çš„å¹¶è¡Œå¤„ç†ä»»åŠ¡ï¼Œå¹¶ä¸”å¯ä»¥æŠŠæ¶ˆæ¯ä»ä¸€ä¸ªè¿›ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œæˆ–è€…åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…çš„ä¸åŒçº¿ç¨‹é—´è¿›è¡Œå‘é€ã€‚

:::

------

## çº¿ç¨‹

### â“`iOS` ä¸­çš„å¸¸ç”¨çº¿ç¨‹ç›¸å…³ç±»å‹æœ‰å“ªäº›

::: details ğŸ’¡

  - `NSThread`: æœ€åŸºç¡€çš„çº¿ç¨‹ä½¿ç”¨æ–¹å¼ï¼Œ`Cocoa` æä¾›äº†å¯¹è±¡åŒ–çš„çº¿ç¨‹ `NSThread`ï¼Œå¯ä»¥ç›´æ¥æ“ä½œçº¿ç¨‹ï¼Œå¦‚åˆ›å»ºã€å¯åŠ¨ã€ä¼‘çœ ç­‰ã€‚`Swift` ä¸­å¯¹åº” `Thread`ã€‚

  - `GCD` (Grand Central Dispatch): `Apple` å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„å¹¶è¡Œè¿è¡Œä»»åŠ¡è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸»è¦ç”¨äºä¼˜åŒ–åº”ç”¨ä»¥æ”¯æŒå¤šæ ¸å¤„ç†å™¨ä»¥åŠå…¶ä»–å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿã€‚`GCD` æä¾›äº†ä¸€ç§ç®€å•æ˜“ç”¨ä¸”åŠŸèƒ½å¼ºå¤§çš„æ–¹å¼æ¥ç®¡ç†å¤šçº¿ç¨‹æ“ä½œã€‚

  - `NSOperation`: æ˜¯ `GCD` çš„é¢å‘å¯¹è±¡å°è£…ï¼Œç›¸æ¯” `GCD` èƒ½åšæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œæ¯”å¦‚ï¼Œæ·»åŠ æ“ä½œä¾èµ–ï¼Œè®¾å®šæ“ä½œä¼˜å…ˆçº§ï¼Œå–æ¶ˆæ“ä½œç­‰ç­‰ã€‚`NSOperationQueue` æä¾›äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¥æŒ‰ç…§æ·»åŠ è¿›å»çš„é¡ºåºæ¥å¯åŠ¨ `NSOperation`ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®å¹¶å‘æ•°å’Œä¼˜å…ˆçº§ã€‚

:::

### çº¿ç¨‹å®‰å…¨

#### â“`atomic` çº¿ç¨‹å®‰å…¨å—

::: details ğŸ’¡

  `atomic` å±æ€§åªä¿è¯å±æ€§ `setter` å’Œ `getter` çš„åŸå­æ“ä½œï¼Œä»¥é˜²æ­¢æ•°æ®è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥æˆ–è€…åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»å–ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸èƒ½å®Œå…¨ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

  > å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ Bï¼Œå®ƒä»¬éƒ½å°è¯•æ›´æ–°åŒä¸€ä¸ªæ•°å€¼ã€‚çº¿ç¨‹ A è¯»å–è¯¥æ•°å€¼ï¼Œç„¶ååœ¨ A æ‰§è¡Œå†™å…¥æ“ä½œä¹‹å‰ï¼Œçº¿ç¨‹ B ä¹Ÿè¯»å–äº†è¯¥æ•°å€¼ï¼Œå¹¶ä¸”å†™å›äº†ä¸€ä¸ªæ–°çš„å€¼ã€‚ç„¶åçº¿ç¨‹ A ç»§ç»­å®ƒçš„å†™å…¥æ“ä½œï¼Œè¿™æ ·å°±è¦†ç›–äº†çº¿ç¨‹ B çš„æ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„"ç«æ€æ¡ä»¶"ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`atomic`å±æ€§å¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

  è™½ç„¶ `atomic` å±æ€§å¯ä»¥ä¿è¯å•ç‹¬çš„ `getter` æˆ– `setter` æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å®ƒä¸èƒ½ä¿è¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼ˆä¾‹å¦‚å…ˆè¯»å–ï¼Œç„¶åæ ¹æ®è¯»å–çš„å€¼åšè®¡ç®—ï¼Œç„¶åå†™å›æ–°çš„å€¼ï¼‰æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„çº¿ç¨‹å®‰å…¨ã€‚

  å¦‚æœéœ€è¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œåº”ä½¿ç”¨ `mutex`ï¼ˆäº’æ–¥é”ï¼‰æˆ–è€…å…¶å®ƒçš„çº¿ç¨‹åŒæ­¥æŠ€æœ¯ã€‚å¯ä»¥ä½¿ç”¨ `DispatchQueue`ã€`NSLock`ã€`NSOperationQueue` æˆ–è€…ç”¨ `GCD`ï¼ˆ`Grand Central Dispatch`ï¼‰ç­‰æ–¹å¼æ¥å¤„ç†çº¿ç¨‹åŒæ­¥ã€‚

:::

#### â“`NSMutableArray` çº¿ç¨‹å®‰å…¨å—

::: details ğŸ’¡
  
  > çº¿ç¨‹å®‰å…¨ï¼šæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å½“æ•°æ®å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°å¹¶è¡Œå­˜å–æ—¶ï¼Œè¯¥æ•°æ®å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚åä¹‹ï¼Œå¦‚æœæ•°æ®çš„ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æˆ–è€…å‘ç”Ÿé”™è¯¯ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

  `NSMutableArray` æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚å†…éƒ¨å°è£…äº†ä¸€ä¸ªåŠ¨æ€æ‰©å®¹çš„æ•°ç»„ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ç»„æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹æ•°ç»„å…ƒç´ çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•åœ¨åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚

    ç¤ºä¾‹ï¼š
    
    çº¿ç¨‹A è°ƒç”¨äº† addObjectï¼šæ–¹æ³•ï¼Œè¯•å›¾å‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚
    åŒæ—¶ï¼Œçº¿ç¨‹Bä¹Ÿè°ƒç”¨äº†addObjectï¼šæ–¹æ³•ï¼Œè¯•å›¾å‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚

    åœºæ™¯ä¸€ï¼š
    ä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ˜¯äº¤æ›¿è¿›è¡Œçš„ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç° çº¿ç¨‹A å…ˆå°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œç„¶åæ•°ç»„æ‰©å®¹ã€‚
    çº¿ç¨‹B ä¹Ÿå°†å…ƒç´ æ·»åŠ åˆ°åŒä¸€ä½ç½®ï¼Œç„¶åå†æ¬¡è§¦å‘æ•°ç»„çš„æ‰©å®¹ã€‚
    ç»“æœå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºä¸¤ä¸ªå…ƒç´ è¢«æ·»åŠ åˆ°äº†åŒä¸€ä¸ªä½ç½®ã€‚

    åœºæ™¯äºŒï¼š
    çº¿ç¨‹A åœ¨æ·»åŠ å…ƒç´ çš„åŒæ—¶ï¼Œçº¿ç¨‹B å¯èƒ½åœ¨åˆ é™¤å…ƒç´ ã€‚
    å¦‚æœ çº¿ç¨‹A å·²ç»å®Œæˆäº†æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶ çº¿ç¨‹B åˆ é™¤äº†åˆšåˆšå·²ç»æ·»åŠ çš„å…ƒç´ ï¼Œè¿™æ ·ä¹Ÿä¼šå¼•å‘æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚
    
:::

#### â“`UIKit` çº¿ç¨‹å®‰å…¨å—

::: details ğŸ’¡

`UIKit` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

  ä¸€èˆ¬æ¥è¯´ï¼Œ`UIKit` çš„ç±»åº”è¯¥åªåœ¨ä¸»çº¿ç¨‹ä¸Šä½¿ç”¨ã€‚å°½ç®¡æœ‰ä¸€äº› `UIKit` çš„æ–¹æ³•è¢«æ–‡æ¡£æ˜ç¡®æŒ‡å‡ºå¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­è°ƒç”¨ï¼Œä½†è¿™æ˜¯å¾ˆå°‘è§çš„ï¼Œè€Œä¸”è¿™äº›æ–¹æ³•åœ¨æ–‡æ¡£ä¸­éƒ½æœ‰æ˜ç¡®çš„æ³¨æ˜ã€‚

  ä¸»è¦åŸå› æ˜¯å› ä¸º `UIKit` çš„è®¾è®¡å¹¶ä¸åŒ…æ‹¬åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¿æŠ¤æ•°æ®çš„æœºåˆ¶ã€‚å¦‚æœåœ¨å¤šä¸ªçº¿ç¨‹ä¸­åŒæ—¶ä¿®æ”¹ `UIKit` çš„å¯¹è±¡ï¼Œæ¯”å¦‚è§†å›¾çš„å±æ€§æˆ–è€…æ•°æ®æºï¼Œè¿™å¯èƒ½å¯¼è‡´æ•°æ®å†²çªæˆ–è€…å…¶ä»–æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ `iOS` åº”ç”¨å¼€å‘ä¸­é€šå¸¸çš„åšæ³•æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œæ‰€æœ‰çš„ `UI` æ“ä½œã€‚è¿™å°±æ˜¯éœ€è¦åœ¨ä¸»çº¿ç¨‹æ›´æ–° `UI` çš„åŸå› ã€‚

  å¦‚æœéœ€è¦åœ¨åå°çº¿ç¨‹å®Œæˆä¸€äº›é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚æˆ–è€…å¤§æ•°æ®è®¡ç®—ï¼Œç„¶åéœ€è¦æ›´æ–° `UI`ï¼Œåº”è¯¥åœ¨æ“ä½œå®ŒæˆåæŠŠ `UI` æ›´æ–°çš„æ“ä½œæ”¾å›ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚åœ¨ `Swift` ä¸­ï¼Œå¯ä»¥ä½¿ç”¨`DispatchQueue.main.async { /* æ›´æ–° UI */ }`å°† `UI` æ›´æ–°çš„æ“ä½œæ”¾å›ä¸»çº¿ç¨‹ã€‚

:::

### ä¸»çº¿ç¨‹

#### â“ä¸ºä»€ä¹ˆåªåœ¨ä¸»çº¿ç¨‹åˆ·æ–° `UI`

::: details ğŸ’¡

  - çº¿ç¨‹å®‰å…¨ï¼š`UIKit` å¹¶ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒåŒæ—¶åœ¨å¤šä¸ªçº¿ç¨‹æ“ä½œ `UI` å¯èƒ½ä¼šå¯¼è‡´æ— æ³•é¢„æœŸçš„ç»“æœï¼Œæ¯”å¦‚ `UI` çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´å´©æºƒã€‚

  - æ€§èƒ½è€ƒè™‘ï¼šæ¸²æŸ“ `UI` æ˜¯ä¸€ä¸ªç›¸å¯¹é‡çš„æ“ä½œï¼Œå¦‚æœåœ¨å¤šä¸ªçº¿ç¨‹ä¸­æ“ä½œï¼Œç»å¸¸éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¶ˆè€—çš„ `CPU` èµ„æºå°†ä¼šå¢å¤šï¼Œè€Œä¸”å¯èƒ½å‡ºç°ç”»é¢æ’•è£‚ç­‰ç°è±¡ã€‚

  - ç”¨æˆ·ä½“éªŒï¼šä¸»çº¿ç¨‹ä¹Ÿè¢«ç§°ä¸º `UI` çº¿ç¨‹ï¼Œå®ƒä¸»è¦è´Ÿè´£å’Œç”¨æˆ·çš„äº¤äº’ï¼Œå“åº”ç”¨æˆ·çš„è§¦æ‘¸äº‹ä»¶ç­‰ã€‚å¦‚æœå¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œ `UI` æ“ä½œï¼Œé‚£ä¹ˆæ— è®ºåå°çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¸ä¼šå½±å“åˆ° `UI` çš„å“åº”æ€§ï¼Œè¿™æ ·å¯ä»¥ä¿è¯è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

:::

#### â“ä¸ºä»€ä¹ˆåªæœ‰ä¸»çº¿ç¨‹çš„ `Runloop` æ˜¯å¼€å¯çš„

::: details ğŸ’¡

  `Runloop` æ˜¯è´Ÿè´£å¤„ç†åº”ç”¨ä¸­å„ç§äº‹ä»¶çš„æœºåˆ¶ï¼Œä¾‹å¦‚å±å¹•è§¦æ‘¸ï¼Œå®šæ—¶å™¨äº‹ä»¶ï¼Œç½‘ç»œæ•°æ®è¿”å›ç­‰ã€‚`RunLoop` ä½¿å¾—çº¿ç¨‹å¯ä»¥ç­‰å¾…æ¥æ”¶äº‹ä»¶è€Œä¸å ç”¨ `CPU` æ—¶é—´ã€‚å½“æ²¡æœ‰äº‹ä»¶å¤„ç†æ—¶ï¼Œçº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå½“æ–°çš„äº‹ä»¶åˆ°æ¥æ—¶çº¿ç¨‹è¢«å”¤é†’å¤„ç†äº‹ä»¶ã€‚

  å› ä¸ºæ‰€æœ‰çš„ `UI` æ›´æ–°ã€ç”¨æˆ·äº¤äº’ç­‰äº‹ä»¶éƒ½åœ¨ä¸»çº¿ç¨‹çš„ `Runloop` ä¸­å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯è‹¹æœè®¾è®¡çš„è¦æ±‚ã€‚

  å¯¹äºå…¶ä»–å­çº¿ç¨‹ï¼Œ`RunLoop` æ˜¯é»˜è®¤ä¸å¼€å¯çš„ã€‚å› ä¸ºå¼€å¯ `RunLoop` ä¼šæœ‰ä¸€äº›èµ„æºæŸè€—ï¼Œå¦‚æœå­çº¿ç¨‹ä¸éœ€è¦å¤„ç†åƒå®šæ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ç­‰äº‹ä»¶ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å¼€å¯ `RunLoop`ã€‚

  ä½†å¦‚æœä½ ç¡®å®éœ€è¦åœ¨å­çº¿ç¨‹ä¸­å¤„ç†äº‹ä»¶ï¼Œæ¯”å¦‚é•¿æœŸå¾…å‘½çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥æ‰‹åŠ¨å¼€å¯ `RunLoop`ã€‚ä¾‹å¦‚åœ¨å¼€å‘ä¸­ï¼Œå¯èƒ½ä¼šåœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ `NSURLConnection`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‰‹åŠ¨å¼€å¯è¿™ä¸ªçº¿ç¨‹çš„ `RunLoop`ï¼Œå› ä¸º `NSURLConnection` éœ€è¦ä½¿ç”¨ `RunLoop` æ¥å¤„ç†ç½‘ç»œè¿”å›äº‹ä»¶ã€‚
    
:::

### é­”æœ¯æ•°å­—

#### â“`0x8BADF00D` æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

  > `0x8BADF00D` ("ate bad food") æ˜¯ä¸€ä¸ªç”±è‹¹æœå…¬å¸å®šä¹‰çš„â€œé­”æœ¯æ•°å­—â€é”™è¯¯ä»£ç ã€‚åœ¨åº”ç”¨ç¨‹åºé•¿æ—¶é—´å ç”¨ä¸»çº¿ç¨‹å¯¼è‡´ç³»ç»Ÿçœ‹é—¨ç‹—å¼•å‘çš„åº”ç”¨ç¨‹åºç»ˆæ­¢æ—¶ä½¿ç”¨ã€‚

  åœ¨ `iOS` å¼€å‘ä¸­åº”å°½é‡é¿å…åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»ä½•å¯èƒ½è€—æ—¶çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€å¤§é‡è®¡ç®—ç­‰ç­‰ã€‚è¿™æ˜¯å› ä¸ºè¿™äº›ä»»åŠ¡ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå› æ­¤å½±å“ç”¨æˆ·ç•Œé¢çš„å“åº”ã€‚å¦‚æœæ‰§è¡Œè¿™äº›ä»»åŠ¡çš„æ—¶é—´è¿‡é•¿ï¼Œå°±å¯èƒ½ä¼šæ”¶åˆ° `0x8badf00d` é”™è¯¯ï¼Œè¡¨ç¤ºåº”ç”¨ç¨‹åºå› å“åº”è¶…æ—¶è€Œè¢«ç³»ç»Ÿç»ˆæ­¢ã€‚

  ä¸€èˆ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `GCD`(Grand Central Dispatch) æˆ– `NSOperation` å°†è€—æ—¶æ“ä½œæ”¾åœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

:::

#### â“`0xdead10cc`ã€`0xbad22222`ã€`oxdeadfa11`

::: details ğŸ’¡

è¿™äº›æ˜¯åœ¨è‹¹æœå¹³å°ä¸Šç”¨ä½œç‰¹æ®Šé”™è¯¯æ ‡è¯†çš„â€œé­”æ³•æ•°å­—â€ã€‚

  - `0xdead10cc`: æ˜¯ `iOS`ä¸­ç”¨æ¥è¡¨ç¤ºåº”ç”¨ç¨‹åºå› ä¸ºåœ¨åå°æŒæœ‰ç³»ç»Ÿèµ„æºè€Œè¢«ç³»ç»Ÿç»ˆæ­¢çš„æƒ…å†µã€‚ç‰¹åˆ«æŒ‡åº”ç”¨ç¨‹åºåœ¨è¿›å…¥åå°åä»ç„¶æŒæœ‰äº†ä¸€ä¸ªæ–‡ä»¶é”ï¼ˆfile lockï¼‰ã€‚

  - `0xbad22222`: è¿™ä¸ªå€¼åœ¨å†…æ ¸ä¸­ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæŸåçš„çº¿ç¨‹çŠ¶æ€ï¼ˆcorrupt thread stateï¼‰ã€‚

  - `0xdeadfa11`: åœ¨ `iOS` ä¸­å½“ç”¨æˆ·å¼ºåˆ¶é€€å‡ºåº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚é€šè¿‡ä»»åŠ¡æ æ»‘åŠ¨å…³é—­åº”ç”¨ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šç”¨è¿™ä¸ªé­”æ³•æ•°å­—æ ‡è¯†ã€‚"deadfall" ç±»ä¼¼äºâ€œdead failâ€çš„å‘éŸ³ï¼Œè¡¨ç¤ºåº”ç”¨æ­»æ‰æˆ–è€…å¤±è´¥äº†ã€‚

:::

------

## çº¿ç¨‹åŒæ­¥

### â“`iOS` ä¸­çº¿ç¨‹åŒæ­¥ç­–ç•¥æœ‰å“ªäº›

::: details ğŸ’¡

  - äº’æ–¥é”ï¼ˆMutexï¼‰ï¼šäº’æ–¥é”å¯ä»¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸€æ®µä»£ç æˆ–è€…å…±äº«èµ„æºã€‚
    > åœ¨ `Objective-C` ä¸­ `@synchronized` å…³é”®å­—å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªäº’æ–¥é”ã€‚åœ¨ `Swift` ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä½¿ç”¨ `DispatchSemaphore` æˆ– `NSLock`ã€‚

  - æ¡ä»¶é”ï¼ˆConditionï¼‰ï¼šæ¡ä»¶é”æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„é”ï¼Œå®ƒä¸ä»…èƒ½é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªåŒºå—ï¼Œè€Œä¸”åªæœ‰åœ¨æ»¡è¶³ä¸€å®šçš„å‰ç½®æ¡ä»¶æ—¶æ‰ä¼šå…è®¸è®¿é—®ã€‚
    > å¯ä»¥ä½¿ç”¨ `NSCondition` æˆ– `NSConditionLock` ç±»æ¥åˆ›å»ºæ¡ä»¶é”ã€‚

  - è‡ªæ—‹é”ï¼ˆSpinlockï¼‰ï¼šè‡ªæ—‹é”å’Œäº’æ–¥é”ç±»ä¼¼ï¼Œå®ƒä»¬éƒ½ç”¨äºä¿æŠ¤å…±äº«èµ„æºçš„è®¿é—®ã€‚ä½†æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹æ— æ³•ç«‹å³è·å¾—é”æ—¶ï¼Œå®ƒä¼šä¸€ç›´åœ¨å¾ªç¯ä¸­ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚
    > é€šå¸¸ç”¨äºç­‰å¾…æ—¶é—´éå¸¸çŸ­çš„æƒ…å†µã€‚
   
  - è¯»å†™é”ï¼šè¯»å†™é”è¢«è®¾è®¡ä¸ºè§£å†³å¤šè¯»å•å†™é—®é¢˜ã€‚å³ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–ï¼Œä½†å†™å…¥å¿…é¡»ç‹¬å ã€‚è¿™æ ·å‡å°‘äº†é˜»å¡ï¼Œæé«˜äº†å¹¶è¡Œæ€§ã€‚
   
  - ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼šä¿¡å·é‡æ˜¯ä¸€ç§æ›´ä¸ºä¸€èˆ¬åŒ–çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ã€‚å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºï¼Œä½†æ˜¯å¿…é¡»é™åˆ¶åŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°é‡ã€‚
   
  - `GCD` ä¸²è¡Œé˜Ÿåˆ—ï¼ˆ`Serial Dispatch Queue`ï¼‰ï¼šä¿è¯æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä¸€ä¸ªæŒ‡å®šçš„é˜Ÿåˆ—ä¸­æŒ‰ç…§æ·»åŠ çš„é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œï¼Œå› æ­¤æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥è¿›è¡ŒåŒæ­¥ã€‚

:::

### çº¿ç¨‹é”

#### â“`OC` ä¸­çš„é”æœ‰å“ªäº›
    
::: details ğŸ’¡

  `OC`ä¸­æœ‰å¤šç§æ–¹å¼æ¥å®ç°çº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯"é”"çš„æ¦‚å¿µã€‚

  - `NSLock`ï¼šæœ€åŸºæœ¬çš„é”ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç›´è§‚å’Œç®€å•ã€‚åªéœ€è¦åœ¨æ“ä½œå‰åŠ é”ï¼Œæ“ä½œåè§£é”å³å¯ã€‚

    ```objc
    NSLock *lock = [[NSLock alloc] init];
    [lock lock];
    // Access shared resource here.
    [lock unlock];
    ```

  - `@synchronized`ï¼šçº¿ç¨‹åŒæ­¥å…³é”®å­—ï¼Œç”¨äºè‡ªåŠ¨åŠ é”å’Œè§£é”ã€‚æ”¾åœ¨éœ€è¦ä¿æŠ¤çº¿ç¨‹å®‰å…¨çš„ä»£ç å‰é¢å³å¯ã€‚

    ```objc
    @synchronized (self) {
        // Access shared resource here.
    }
    ```

  - `NSCondition`ï¼šæ¡ä»¶é”ï¼Œå½“æŸæ¡ä»¶æ»¡è¶³æ—¶åŠ é”ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚

    ```objc
    NSCondition *condition = [[NSCondition alloc] init];
    [condition lock];
    while (/* å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ */) {
        [condition wait];
    }
    // Access shared resource here.
    [condition unlock];
    ```

  - `NSRecursiveLock`ï¼šé€’å½’é”ï¼Œå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œä¸ä¼šé€ æˆæ­»é”ã€‚
    
    ```objc
    NSRecursiveLock *rLock = [[NSRecursiveLock alloc] init];
    [rLock lock];
    // Access shared resource here.
    [rLock unlock];
    ```

  - `dispatch_semaphore_t`ï¼šä¿¡å·é‡ï¼Œæ˜¯ `GCD` ä¸­çš„ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡æ§åˆ¶ä¿¡å·é‡çš„æ•°é‡æ¥è¿›è¡Œçº¿ç¨‹çš„å¹¶å‘æ§åˆ¶ã€‚

    ```objc
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
    // Access shared resource here.
    dispatch_semaphore_signal(semaphore);
    ```

  - `Mutex`ï¼šäº’æ–¥é”
  
    ```objc
    pthread_mutex_t mutex;
    pthread_mutex_init(&mutex, NULL);
    pthread_mutex_lock(&mutex);
    // Access shared resource here.
    pthread_mutex_unlock(&mutex);
    ```
  
  - `OSSpinLock`ï¼šè‡ªæ—‹é”ï¼Œå¦‚æœç”±äºç«äº‰èµ„æºä¸å¯ç”¨è€Œæ— æ³•ç«‹å³è·å¾—é”ï¼Œå®ƒä¼šä¸€ç›´åœ¨ç”¨æˆ·æ€è‡ªæ—‹ï¼ˆå¿™ç­‰ï¼‰ï¼Œç›´åˆ°é”å˜ä¸ºå¯ç”¨ä¸ºæ­¢ã€‚
    > ç”±äºå®ƒåœ¨ç”¨æˆ·æ€å°±å¯ä»¥è‡ªæ—‹ï¼Œä¸ç”¨åƒå…¶ä»–é”é‚£æ ·è¿›å…¥å†…æ ¸æ€è¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼Œæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ã€‚ä½†æ˜¯è‡ªæ—‹é”ç”±äºæ°¸ä¸é˜»å¡ï¼Œä¸€ç›´å ç”¨ `CPU`ï¼Œæ‰€ä»¥åœ¨èµ„æºç«äº‰ä¸¥é‡çš„æƒ…å†µä¸‹æ•ˆç‡ä¼šå¾ˆä½ã€‚æ³¨æ„ï¼Œ`OSSpinLock` åœ¨ `iOS10.0` åå·²ç»ä¸å†å®‰å…¨ï¼Œæ¨èä½¿ç”¨ `os_unfair_lock`ã€‚
   
    ```objc
    pthread_spinlock_t spinlock;
    pthread_spin_init(&spinlock, 0);
    pthread_spin_lock(&spinlock);
    // Access shared resource here.
    pthread_spin_unlock(&spinlock);
    ```

  - `os_unfair_lock`ï¼š`OSSpinLock` çš„æ›¿ä»£å“ï¼Œå®‰å…¨æ€§æ›´å¥½ï¼Œæ¨èç”¨äºä½å»¶è¿Ÿå’Œé«˜å¹¶å‘çš„åœºæ™¯ã€‚
    
:::
    
#### â“`swift` ä¸­çš„é”æœ‰å“ªäº›

::: details ğŸ’¡
    
  - `Dispatch Semaphore` ä¿¡å·é‡ï¼šå½“ä¿¡å·é‡çš„å€¼ `<=0` æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹, `>0` æ—¶, ä¼šä½¿ä¿¡å·é‡çš„å€¼å‡1ï¼Œç„¶åæ‰§è¡Œåç»­çš„ä»£ç ã€‚

    ```swift
    let semaphore = DispatchSemaphore(value: 1)
    semaphore.wait()
    // Do something
    semaphore.signal()
    ```

  - `NSLock`: å®ƒæ˜¯å¯¹ `mutex` çš„ä¸€æ¬¡ç®€å•çš„å°è£…ï¼Œæ›´åŠ é¢å‘å¯¹è±¡ï¼Œç”¨èµ·æ¥æ›´åŠ ç®€å•ã€‚

    ```swift
    let lock = NSLock()
    lock.lock()
    // Do something
    lock.unlock()
    ```

  - `NSRecursiveLock`ï¼šå…è®¸åŒä¸€çº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œè€Œä¸ä¼šå¼•èµ·æ­»é”ã€‚é€’å½’é”ä¼šè·Ÿè¸ªè§£é”å’ŒåŠ é”çš„æ•°ç›®ï¼Œåªæœ‰è¿™ä¸¤ä¸ªæ•°ç›®ç›¸åŒæ—¶ï¼Œé”æ‰ä¼šè¢«çœŸæ­£é‡Šæ”¾æ‰ã€‚

    ```swift
    let recursiveLock = NSRecursiveLock()
    recursiveLock.lock()
    // Do something
    recursiveLock.unlock()
    ```

  - `Mutex` (PTHREAD_MUTEX_NORMAL)ï¼šå¯ä»¥å®ç°é”çš„å¿«é€Ÿæ£€æŸ¥ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡å·²ç»ä¸Šé”ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç«‹åˆ»è¿”å›ï¼Œçº¿ç¨‹ä¸ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ã€‚

    ```swift
    var mutex = pthread_mutex_t()
    pthread_mutex_lock(&mutex)
    // Do something
    pthread_mutex_unlock(&mutex)
    
    ```

  - `Spin Lock`ï¼šå¿™ç­‰é”ï¼Œä¼šä¸€ç›´å ç”¨ `CPU` çš„èµ„æºï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ã€‚è‡ªæ—‹é”åªåº”ä½¿ç”¨åœ¨ä¿è¯çº¿ç¨‹ä¸ä¼šè¢«å¤§é‡é˜»å¡çš„åœºæ™¯ï¼Œæ¯”å¦‚å†…æ ¸çš„æ•°æ®ç»“æ„æˆ–è€…å®æ—¶çº¿ç¨‹ç¼–ç¨‹ã€‚

    ```swift
    var unfairLock = os_unfair_lock_s()
    os_unfair_lock_lock(&unfairLock)
    // Do something
    os_unfair_lock_unlock(&unfairLock)
    ```

æ€»ç»“ï¼š
  
  - `Dispatch Semaphore` ä¿¡å·é‡ã€`NSLock`ã€`NSRecursiveLock`éƒ½æ˜¯é€šè¿‡ `Foundation` æ¡†æ¶æä¾›çš„ `API` æ¥å®ç°çš„ï¼›
  - `Mutex` é”æ˜¯é€šè¿‡ `pthread` åº“ä¸­çš„ `mutex` æä¾›çš„ï¼›
  - `SpinLock` æ˜¯é€šè¿‡ `os` åº“ä¸­çš„ `os_unfair_lock` æ¥å®ç°çš„ã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œä½¿ç”¨å“ªç§é”å–å†³äºå…·ä½“éœ€æ±‚ï¼š
  
  - å¦‚æœéœ€è¦æŠ¢å å¼çš„é”ï¼Œå¹¶ä¸”ä¸èƒ½å®¹å¿çº¿ç¨‹å†»ç»“ï¼Œ`NSLock`å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚
  - å¯¹äºéœ€è¦å¿«é€Ÿæ£€æŸ¥çš„æƒ…å†µï¼Œ`mutex` å¯èƒ½ä¼šæ›´åˆé€‚ã€‚
  - å¦‚æœåªæ˜¯éœ€è¦ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ¥ä¿æŠ¤ä¸€æ®µä»£ç ï¼Œç„¶å`Dispatch Semaphore`ä¹Ÿè®¸å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚

:::
    
#### â“è‡ªæ—‹é” vs äº’æ–¥é”

::: details ğŸ’¡

ä¸¤è€…åŒºåˆ«ï¼šåœ¨äºå½“é”æ— æ³•è·å–çš„æ—¶å€™ï¼Œå®ƒä»¬å¤„ç†æ–¹å¼çš„ä¸åŒã€‚

  - è‡ªæ—‹é”ï¼ˆ`SpinLock`ï¼‰ï¼š
    
    å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–ä¸€ä¸ªå·²ç»è¢«å ç”¨çš„è‡ªæ—‹é”æ—¶ï¼Œå®ƒä¼šæŒç»­åœ°æŸ¥è¯¢ï¼ˆ`spin`ï¼Œæ•…å`è‡ªæ—‹é”`ï¼‰é”çš„çŠ¶æ€ä»¥å°è¯•è·å–é”çš„æ‰€æœ‰æƒã€‚æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹ä¼šåœ¨ç”¨æˆ·æ€å¿™ç­‰ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚å› æ­¤ï¼Œè‡ªæ—‹é”æ˜¯éé˜»å¡çš„ã€‚
    
    è¿™ç§æ–¹å¼å¯¹ `CPU` æ˜¯æå…¶æ¶ˆè€—èµ„æºçš„ï¼Œä½†æ˜¯å½“é”æŒæœ‰çš„æ—¶é—´éå¸¸çŸ­æ—¶ï¼ˆä¾‹å¦‚ï¼Œåªæ˜¯ç®€å•åœ°è¯»å–æˆ–ä¿®æ”¹ä¸€å°å—æ•°æ®ï¼‰ï¼Œè‡ªæ—‹é”ä¼šæ¯”äº’æ–¥é”æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºçº¿ç¨‹æ— éœ€åœ¨äº’æ–¥é”çš„æ’é˜Ÿã€é˜»å¡å’Œå”¤é†’ç­‰æ“ä½œä¸­èŠ±è´¹æ—¶é—´ã€‚

  - äº’æ–¥é”ï¼ˆ`Mutex`ï¼‰ï¼š

    äº’æ–¥é”å’Œè‡ªæ—‹é”çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå·²ç»è¢«å ç”¨çš„äº’æ–¥é”æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡å¹¶è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œæœ¬çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’å¹¶è·å¾—é”æ¥ç»§ç»­æ‰§è¡Œã€‚

    è¿™æ ·æ˜¾ç„¶ä¼šæ¯”è‡ªæ—‹é”åœ¨æ— æ³•è·å¾—é”æ—¶æ›´èŠ‚çœ `CPU` èµ„æºï¼Œä¸è¿‡è·å–é”ä¸é‡Šæ”¾é”æ¶‰åŠåˆ°çš„çº¿ç¨‹åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´ä¹Ÿæ˜¯æœ‰ä¸€å®šå¼€é”€çš„ã€‚ç„¶è€Œï¼Œå¯¹äºæ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„ä»£ç å—ï¼ˆä¾‹å¦‚ `IO` ä»»åŠ¡ç­‰ï¼‰ï¼Œä½¿ç”¨äº’æ–¥é”é€šå¸¸ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

é€‚ç”¨åœºæ™¯ï¼š
    
  - è‡ªæ—‹é”é€‚ç”¨äºé”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¾ˆå°ä¸”ç¡®å®šæ—¶é—´çŸ­çš„æƒ…å†µã€‚
  - äº’æ–¥é”æ›´åˆé€‚è€—æ—¶é•¿çš„æ“ä½œåŠ é”ï¼Œå¦‚æœä¸´ç•ŒåŒºåŒ…å« `IO`ã€è€—æ—¶æ“ä½œæˆ–è€…åŒ…å«å…¶ä»–å½¢å¼çš„é”çš„è¯ï¼Œä½¿ç”¨è‡ªæ—‹é”åè€Œä¼šå› ä¸ºâ€œå¿™ç­‰â€æµªè´¹è¿‡å¤š `CPU` æ—¶é—´ã€‚

:::

  > ç”¨ `C/C++/OC` å®ç°è‡ªæ—‹é”æˆ–äº’æ–¥é”

::: details ğŸ’¡

  å®ç°äº’æ–¥é”ï¼Œå¯ä»¥ä½¿ç”¨åŸå­æ“ä½œæˆ–å†…å­˜å±éšœæ¥è¾¾æˆç›®çš„ã€‚

```cpp
#include <atomic>

// ä½¿ç”¨ `C++11` å®ç°çš„è‡ªæ—‹é”çš„ç®€å•ç‰ˆæœ¬
class SpinLock {
    // std::atomic_flag : C++ ä¸­çš„åŸå­å¸ƒå°”å‹æ ‡å¿—
    std::atomic_flag locked = ATOMIC_FLAG_INIT ;
    public:
    // std::memory_order_acquire & std::memory_order_release
    // å†…å­˜åºï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ­£ç¡®æ€§ã€‚
    void lock() {
        while (locked.test_and_set(std::memory_order_acquire)) { ; }
    }
    void unlock() {
        locked.clear(std::memory_order_release);
    }
};
```

:::

------

## çº¿ç¨‹é€šä¿¡

### â“`iOS` ä¸­çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡

::: details ğŸ’¡

 - `NSThread`
    > `NSThread` ç±»æä¾›äº†ä¸€äº›æ–¹æ³•æ¥å®ç°çº¿ç¨‹é—´é€šä¿¡ï¼Œä¾‹å¦‚ `performSelector:onThread:withObject:waitUntilDone:`ã€‚
    
   ```objc
   // åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   NSThread *thread = [[NSThread alloc] initWithBlock:^{
       // è€—æ—¶æ“ä½œ...
       // å›åˆ°ä¸»çº¿ç¨‹æ›´æ–° UI
       [self performSelectorOnMainThread:@selector(updateUI) withObject:nil waitUntilDone:YES];
   }];
   [thread start];
   ``` 

  - `GCD` ï¼ˆGrand Central Dispatchï¼‰
    > ä½¿ç”¨ `dispatch_get_main_queue` æˆ– `dispatch_get_global_queue` è·å–å¯¹åº”çš„é˜Ÿåˆ—ï¼Œåœ¨å¯¹åº”çš„é˜Ÿåˆ—ä¸­ä½¿ç”¨ `dispatch_async` æˆ– `dispatch_sync` å»æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ã€‚

   ```objc
   // åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
       // è€—æ—¶æ“ä½œ...
       // å›åˆ°ä¸»çº¿ç¨‹æ›´æ–° UI
       dispatch_async(dispatch_get_main_queue(), ^{
           // æ›´æ–° UI...
       });
   });
   ```
   
  - `NSOperationQueue`
    > å¯ä»¥åˆ›å»ºå¹¶ä½¿ç”¨å­çº¿ç¨‹å¯¹åº”çš„ `NSOperationQueue`ï¼Œå†ä½¿ç”¨ `addOperationWithBlock:` æ–¹æ³•æˆ–è€…é€šè¿‡ `NSInvocationOperation`ã€`NSBlockOperation` æ·»åŠ æ“ä½œã€‚
    
   ```objc
   // åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   [[NSOperationQueue new] addOperationWithBlock:^{
       // è€—æ—¶æ“ä½œ...
       // å›åˆ°ä¸»çº¿ç¨‹æ›´æ–° UI
       [[NSOperationQueue mainQueue] addOperationWithBlock:^{
           // æ›´æ–° UI...
       }];
   }];
   ```

:::

### â“æ‰§è¡Œä¸€ä¸ª `NSThread` ä»»åŠ¡, å¦‚ä½•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç»ˆæ­¢è¯¥çº¿ç¨‹

::: details ğŸ’¡

  å¯ä»¥é€šè¿‡ `NSThread` ç±»çš„ `cancel` æ–¹æ³•æ¥å‘å‡ºçº¿ç¨‹å–æ¶ˆçš„è¯·æ±‚ã€‚
  
  æ³¨æ„ï¼š`cancel` æ–¹æ³•å¹¶ä¸ä¼šå¼ºåˆ¶ç»ˆæ­¢çº¿ç¨‹çš„æ‰§è¡Œï¼Œå®ƒåªæ˜¯å°† `NSThread` å¯¹è±¡çš„ `cancelled` å±æ€§è®¾ç½®ä¸º `YES`ï¼Œå¼€å‘è€…éœ€è¦åœ¨ä»£ç ä¸­å®šæœŸæ£€æŸ¥è¿™ä¸ªå±æ€§æ¥å†³å®šæ˜¯å¦éœ€è¦åœæ­¢æ‰§è¡Œçº¿ç¨‹ã€‚
    
```objc
NSThread *thread = [[NSThread alloc] initWithBlock:^{
    for (int i = 0; i < 10000; i++) {
        if ([[NSThread currentThread] isCancelled]) {
            [NSThread exit];
        }

        // å¤„ç†å…¶ä»–ä»»åŠ¡...

    }
}];
[thread start];

// åœ¨å…¶ä»–åœ°æ–¹ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹è¿°ä»£ç æ¥å‘é€çº¿ç¨‹å–æ¶ˆçš„è¯·æ±‚
[thread cancel];
```

  è°ƒç”¨ `exit` æ–¹æ³•ä¼šç«‹å³åœæ­¢çº¿ç¨‹çš„æ‰§è¡Œï¼Œå¹¶ä¸”ä¸ä¼šè§¦å‘ `@finally` å—ã€‚ä½ éœ€è¦ç¡®ä¿åœ¨è°ƒç”¨ `exit` ä¹‹å‰å·²ç»æ­£ç¡®åœ°æ¸…ç†äº†æ‰€æœ‰èµ„æºï¼Œå¦åˆ™å¯èƒ½ä¼šå¼•å‘èµ„æºæ³„éœ²ç­‰é—®é¢˜ã€‚åŒæ—¶ï¼Œç”±äºçº¿ç¨‹è¢«ç»ˆæ­¢åæ— æ³•è¢«å†æ¬¡å¯åŠ¨ï¼Œéœ€è¦åœ¨çº¿ç¨‹è¢«ç»ˆæ­¢åé‡æ–°åˆ›å»ºçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

:::

### â“å¦‚ä½•ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„å·¥ä½œçº¿ç¨‹

::: details ğŸ’¡

  - `NSThread`
    > å¯ä»¥è°ƒç”¨ `cancel` æ–¹æ³•æ¥æ ‡è®°çº¿ç¨‹ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œç„¶ååœ¨ä»£ç ä¸­æ£€æŸ¥çº¿ç¨‹æ˜¯å¦è¢«æ ‡è®°ä¸ºå–æ¶ˆï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœæ­¢æ‰§è¡Œã€‚

    ```objc
    NSThread *thread = [[NSThread alloc] initWithBlock:^{
        while (![[NSThread currentThread] isCancelled]) {
            // æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡...
        }
    }];
    [thread start];
    
    // ç»“æŸçº¿ç¨‹
    [thread cancel];
    ```

  - `GCD`

    ```objc
    // ä½¿ç”¨GCDåˆ›å»ºçš„çº¿ç¨‹
    __block BOOL needToCancel = NO;
    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
        while (!needToCancel) {
            // æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡...
        }
    });
    
    // ç»“æŸçº¿ç¨‹
    needToCancel = YES;
    ```

:::

### â“å¼€å¯ä¸€æ¡çº¿ç¨‹çš„æ–¹æ³•ï¼Œçº¿ç¨‹å¯ä»¥å–æ¶ˆå—

::: details ğŸ’¡
    
  - `NSThread`:

    ```swift
    // åˆ›å»ºå¹¶å¯åŠ¨ NSThread
    let thread = Thread(target: self, selector: #selector(threadMethod), object: nil)
    thread.start()
    // è¯·æ±‚å–æ¶ˆæ‰§è¡Œ
    thread.cancel()
    
    // åœ¨ NSThread ä¸­æ‰§è¡Œçš„æ–¹æ³•
    @objc func threadMethod() {
        while !Thread.current.isCancelled {
            // ä½ çš„ä»£ç ...
        }
    }
    ```

  - `GCD`ï¼ˆåˆ›å»ºçº¿ç¨‹ï¼Œæ— æ³•å–æ¶ˆï¼‰:

    ```swift
    // åˆ›å»ºå¹¶å¯åŠ¨ GCD çº¿ç¨‹
    DispatchQueue.global().async {
        // ä½ çš„ä»£ç ...
    }
    ```

  - `NSOperation`:

    ```swift
    // åˆ›å»ºå¹¶å¯åŠ¨ NSOperation
    let operation = BlockOperation {
        while !operation.isCancelled {
            // ä½ çš„ä»£ç ...
        }
    }
    let operationQueue = OperationQueue()
    operationQueue.addOperation(operation)
    // è¯·æ±‚å–æ¶ˆæ‰§è¡Œ
    operation.cancel()
    ```

 - pthreadï¼ˆåˆ›å»ºçº¿ç¨‹ï¼Œæ— æ³•å–æ¶ˆï¼‰:

    ```swift
    import Darwin
    
    var thread: pthread_t?
    pthread_create(&thread, nil, { pointer in
        print("execute in pthread")
        return nil
    }, nil)
    ```

:::

------

## GCD

  > `GCD (Grand Central Dispatch)` æ˜¯ `Apple` å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸»è¦æ˜¯é€šè¿‡å‘æŒ‡å®šçš„é˜Ÿåˆ—ï¼ˆ`Dispatch Queue`ï¼‰ä¸­æ·»åŠ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä»»åŠ¡ = å·¥ä½œé¡¹ = ä»£ç å—ï¼‰æ¥è¿›è¡Œå·¥ä½œçš„ã€‚`GCD` çš„ç›®æ ‡æ˜¯ä¸ºäº†æœ€å¤§åŒ–åˆ©ç”¨å¤„ç†å™¨çš„å¤šæ ¸ï¼ŒåŒæ—¶æœ€å°åŒ–çº¿ç¨‹åˆ›å»ºå’Œç®¡ç†çš„å¼€é”€ã€‚

### â“`GCD` æ‰§è¡ŒåŸç†

::: details ğŸ’¡

  - ä»»åŠ¡ï¼šæ‰§è¡Œæ“ä½œçš„æœ€å°å•å…ƒï¼Œåªèƒ½æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°ï¼Œä¸èƒ½ç›´æ¥è®¿é—®å±æ€§æˆ–æ–¹æ³•ã€‚
  - é˜Ÿåˆ—ï¼ˆ`Dispatch Queue`ï¼‰ï¼šç”¨äºå­˜æ”¾ä»»åŠ¡çš„å…ˆè¿›å…ˆå‡ºï¼ˆ`FIFO`ï¼‰ç±»å‹çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚

  `GCD` ä¸ºæ¯ä¸ªå¤„ç†å™¨çš„æ ¸å¿ƒåœ¨ç³»ç»Ÿå†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå½“å‘ `DispatchQueue` æ·»åŠ ä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ä»»åŠ¡åˆ†å‘åˆ°è¿™äº›çº¿ç¨‹ä¸­è¿è¡Œï¼Œä»¥å®ç°ä»»åŠ¡çš„å¹¶å‘æ‰§è¡Œã€‚

  `DispatchQueue` å­˜åœ¨ä¸¤ç§ç±»å‹ï¼š`Serial Dispatch Queue`ï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰å’Œ `Concurrent Dispatch Queue`ï¼ˆå¹¶è¡Œé˜Ÿåˆ—ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡æ·»åŠ åˆ°ä¸²è¡Œé˜Ÿåˆ—ä¸­ä¼šæŒ‰ç…§æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œè€Œæ·»åŠ åˆ°å¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åˆ™ä¼šè¢«è°ƒåº¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å¹¶å‘æ‰§è¡Œã€‚

  `GCD` ä¸»è¦æœ‰å››ä¸ªç‰¹ç‚¹ï¼š
    
  - å¯ç”¨äºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—
  - è‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„ `CPU` å†…æ ¸
  - è‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆçº¿ç¨‹çš„åˆ›å»ºï¼Œè°ƒåº¦å’Œé”€æ¯ï¼‰
  - å…·æœ‰çº¿ç¨‹åŒæ­¥çš„åŠŸèƒ½

:::

### â“`GCD` èƒŒåçš„çº¿ç¨‹æ¨¡å‹æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

  > `GCD`(Grand Central Dispatch) åœ¨åº•å±‚æ˜¯åŸºäº `C` è¯­è¨€å®ç°çš„ï¼Œé‡‡ç”¨äº†åŸºäº**äº‹ä»¶é©±åŠ¨**çš„çº¿ç¨‹æ¨¡å‹ã€‚

  å½“ `GCD` æ¥æ”¶åˆ°ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åï¼Œå®ƒä¼šå°†è¿™ä¸ªä»»åŠ¡æ”¾åœ¨åˆé€‚çš„ `Dispatch Queue` ï¼ˆè°ƒåº¦é˜Ÿåˆ—ï¼‰ä¸­ã€‚æ¯ä¸ª `Dispatch Queue` éƒ½å…³è”ç€ä¸€ä¸ªçº¿ç¨‹ï¼Œå½“ `Queue` ä¸­çš„ä»»åŠ¡è¢«è°ƒåº¦å¹¶å¤„äº `ready` çŠ¶æ€æ—¶ï¼Œ`GCD` å°±ä¼šä»çº¿ç¨‹æ± ä¸­é€‰å–ä¸€ä¸ªå¯ç”¨çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚å¦‚æœçº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çº¿ç¨‹ï¼Œè¿™æ—¶ `GCD` ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚

  çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¤ç”¨çš„ï¼Œä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿™ä¸ªçº¿ç¨‹å›åˆ°çº¿ç¨‹æ± ä¸­ï¼Œå¯ä»¥è¢«å…¶ä»–ä»»åŠ¡ç»§ç»­ä½¿ç”¨ã€‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¿™ä¸ªä¸Šé™æ ¹æ®ç³»ç»Ÿèµ„æºæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚

  `GCD` çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸ºäº†æœ€å¤§é™åº¦åœ°æå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ï¼Œå®ƒä¼šè‡ªåŠ¨ç®¡ç†å’Œè°ƒåº¦ä»»åŠ¡ï¼Œä»¥å®ç°å¯¹ç³»ç»Ÿèµ„æºçš„åˆç†åˆ©ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œ`GCD` çš„ä»»åŠ¡è°ƒåº¦ç®—æ³•ä¼šæ ¹æ® `CPU` çš„ä½¿ç”¨æƒ…å†µã€`I/O` çŠ¶æ€ã€ç”µæºæƒ…å†µç­‰å› ç´ è¿›è¡ŒåŠ¨æ€è°ƒæ•´ï¼Œä»¥é™ä½ç³»ç»Ÿçš„èƒ½è€—ï¼Œæé«˜åº”ç”¨çš„å“åº”é€Ÿåº¦ã€‚
    
  `GCD` ä¹Ÿæä¾›äº† `Dispatch Groupã€Dispatch Barriersã€Dispatch Semaphores` ç­‰æœºåˆ¶ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿæ›´çµæ´»åœ°æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºå’ŒåŒæ­¥é—®é¢˜ã€‚
    
:::

### é˜Ÿåˆ—

#### â“`GCD` çš„é˜Ÿåˆ—ï¼ˆ`dispatch_queue_t`ï¼‰åˆ†å“ªä¸¤ç§ç±»å‹ï¼Œé»˜è®¤æä¾›å“ªäº›é˜Ÿåˆ—

::: details ğŸ’¡

é˜Ÿåˆ—ç±»å‹ï¼š

  - `Serial Dispatch Queue`: ä¸²è¡Œé˜Ÿåˆ—ï¼Œä»»åŠ¡ä¼šæŒ‰ç…§æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æ€»æ˜¯ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰å¼€å§‹æ‰§è¡Œã€‚
  - `Concurrent Dispatch Queue`: å¹¶è¡Œé˜Ÿåˆ—ï¼Œä»»åŠ¡ä¸éœ€è¦ç­‰å¾…ï¼Œå¯ä»¥åŒæ—¶ï¼ˆå¹¶å‘åœ°ï¼‰æ‰§è¡Œã€‚ä¸è¿‡å…·ä½“èƒ½å¤ŸåŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°å–å†³äºç³»ç»Ÿçš„èµ„æºçŠ¶å†µã€‚

ç³»ç»Ÿé»˜è®¤æä¾›çš„é˜Ÿåˆ—ï¼š

  - `Main Dispatch Queue`: ä¸»é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œç”¨äºåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚å› ä¸ºæ‰€æœ‰çš„ UI æ“ä½œéƒ½å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œæ‰€ä»¥ç»å¸¸ä¼šæŠŠ UI æ›´æ–°çš„ä»»åŠ¡æ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­ã€‚
  - `Global Dispatch Queue`: å…¨å±€é˜Ÿåˆ—ï¼Œå®ƒå®é™…ä¸Šæ˜¯å››ä¸ªå¹¶è¡Œé˜Ÿåˆ—ï¼Œç”¨äºåœ¨åå°æ‰§è¡Œä»»åŠ¡ã€‚å››ä¸ªå…¨å±€å¹¶è¡Œé˜Ÿåˆ—åˆ†åˆ«å¯¹åº”ç€å››ç§ä¸åŒçš„ä¼˜å…ˆçº§ï¼šé«˜ã€é»˜è®¤ã€ä½å’Œåå°ï¼ˆå³éå¸¸ä½ï¼‰ã€‚

:::

#### â“`DispatchQoS` çš„ä½œç”¨

::: details ğŸ’¡

  > `DispatchQoS`ï¼ˆå…¨ç§° `Dispatch Quality of Service`ï¼Œå³æœåŠ¡è´¨é‡ï¼‰æ˜¯ `Swift` ä¸­çš„ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒç”¨äºè¡¨ç¤ºä¸€ä¸ª `DispatchQueue`ï¼ˆè°ƒåº¦é˜Ÿåˆ—ï¼‰ä¸­ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚

```swift
// åˆ›å»º DispatchQueue æ—¶ï¼Œé€šè¿‡è®¾ç½® DispatchQoS æ¥è°ƒæ•´ä»»åŠ¡çš„ä¼˜å…ˆçº§
let queue = DispatchQueue(label: "com.example.queue", qos: .userInteractive)
```

`DispatchQoS` ä¼˜å…ˆçº§ï¼š

  - `userInteractive`ï¼šå’Œç”¨æˆ·äº¤äº’çš„ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡é€šå¸¸éœ€è¦ç«‹å³æ‰§è¡Œï¼Œç”¨ä»¥æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚
    > ä¾‹å¦‚ï¼Œæ»‘åŠ¨æ“ä½œã€åŠ¨ç”»æ˜¾ç¤ºç­‰ã€‚

  - `userInitiated`ï¼šç”¨æˆ·å¯åŠ¨çš„ï¼Œéœ€è¦ç«‹å³ç»“æœçš„ä»»åŠ¡ã€‚
    > ä¾‹å¦‚ï¼ŒåŠ è½½ç”¨æˆ·ç•Œé¢ã€è¯»å–æ–‡ä»¶ç­‰ã€‚

  - `default`ï¼šåœ¨æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚æˆ–ä¼˜å…ˆçº§çš„æ—¶å€™ï¼Œå¤§å¤šæ•°ä»»åŠ¡éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªçº§åˆ«ã€‚

  - `utility`ï¼šä¸éœ€è¦ç«‹åˆ»å®Œæˆä¸”è€—æ—¶çš„ä»»åŠ¡ã€‚
    > ä¾‹å¦‚ï¼Œä¸‹è½½ã€åŒæ­¥æ•°æ®ç­‰ã€‚
    
  - `background`ï¼šå‡ ä¹ä¸å½±å“ç”¨æˆ·çš„ä»»åŠ¡ã€‚
    > ä¾‹å¦‚ï¼Œæ¸…ç†ç£ç›˜ã€å¤‡ä»½æ•°æ®ç­‰ã€‚
    
  - `unspecified`ï¼šæœªæŒ‡å®šçš„ `QoS` ç±»å‹ã€‚
    
:::

#### â“`GCD` ä¸»çº¿ç¨‹ & ä¸»é˜Ÿåˆ—çš„å…³ç³»

::: details ğŸ’¡

  > ä¸»é˜Ÿåˆ—æ˜¯è¿è¡Œåœ¨ä¸»çº¿ç¨‹çš„ä¸€ä¸ªç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½ä¼šåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚å› ä¸ºæ‰€æœ‰ç›¸å…³çš„ `UI` æ“ä½œå’Œç”¨æˆ·äº¤äº’å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œï¼Œæ‰€ä»¥ç»å¸¸ä¼šå°†è¿™äº›å·¥ä½œæ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­è¿›è¡Œã€‚

ä¸»çº¿ç¨‹å’Œä¸»é˜Ÿåˆ—çš„å…³ç³»ï¼š

  - ä¸»é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸Šã€‚
  - æ·»åŠ åˆ°ä¸»é˜Ÿåˆ—çš„ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€æ¬¡ `RunLoop` è¿­ä»£æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚
  - å¯ä»¥ä½¿ç”¨ `dispatch_async` å°†ä¸€ä¸ªä»»åŠ¡æ”¾åˆ°ä¸»é˜Ÿåˆ—ï¼Œè¿™æ ·ä¸ç®¡å½“å‰æ˜¯åœ¨å“ªä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

:::

#### â“çº¿ç¨‹å’Œé˜Ÿåˆ—çš„å…³ç³»ï¼Œä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å¯èƒ½å­˜åœ¨äºä¸¤ä¸ªé˜Ÿåˆ—

::: details ğŸ’¡

  çº¿ç¨‹å’Œé˜Ÿåˆ—åœ¨ç¨‹åºæ‰§è¡Œä¸Šçš„å…³ç³»ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºé˜Ÿåˆ—ï¼ˆ`Queue`ï¼‰æ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹ï¼ˆ`Thread`ï¼‰çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚

  å¯¹äº Grand Central Dispatchï¼ˆ`GCD`ï¼‰æ¥è¯´ï¼Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹æˆ–è€…åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™å–å†³äºé˜Ÿåˆ—çš„ç±»å‹å’Œç³»ç»Ÿçš„è°ƒåº¦ã€‚ç”±ç³»ç»Ÿè´Ÿè´£ç®¡ç†çº¿ç¨‹ï¼Œå¼€å‘è€…åªéœ€è¦å…³æ³¨åœ¨å“ªä¸ªé˜Ÿåˆ—ä¸­æ‰§è¡Œä»»åŠ¡å³å¯ã€‚

  å¦‚æœè¯´çš„æ˜¯ä»»åŠ¡ï¼ˆ`Task`ï¼‰ï¼Œé‚£ä¹ˆä¸€ä¸ªä»»åŠ¡æ˜¯å¯ä»¥æ·»åŠ åˆ°å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å°†ä¼šè¢«ä¸€ä¸ªçº¿ç¨‹å–å‡ºæ‰§è¡Œã€‚ä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶å­˜åœ¨äºä¸¤ä¸ªé˜Ÿåˆ—ä¸­ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œå½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åï¼Œä¼šæ ¹æ®ç³»ç»Ÿçš„è°ƒåº¦å†³å®šå»æ‰§è¡Œå“ªä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚

:::

#### â“é˜Ÿåˆ—ä¸€å®šä¼šåˆ›å»ºçº¿ç¨‹å—ï¼Œé˜Ÿåˆ—æ˜¯å¦å¯ä»¥æ— é™åˆ¶åˆ›å»º

::: details ğŸ’¡

  ä¸æ˜¯æ‰€æœ‰é˜Ÿåˆ—éƒ½ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚é˜Ÿåˆ—åªæ˜¯å¯¹æ‰§è¡Œçš„ä»»åŠ¡è¿›è¡Œç®¡ç†çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…·ä½“æ‰§è¡Œä»»åŠ¡çš„æ˜¯çº¿ç¨‹ã€‚åœ¨ Grand Central Dispatchï¼ˆ`GCD`ï¼‰ä¸­ï¼Œä¸²è¡Œé˜Ÿåˆ—é€šå¸¸åªä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹ï¼‰ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œè€Œå¹¶è¡Œé˜Ÿåˆ—ä¼šæ ¹æ®ç³»ç»Ÿèµ„æºåŠ¨æ€åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚

  `GCD` ä¼šå¯¹çº¿ç¨‹è¿›è¡Œæ™ºèƒ½ç®¡ç†ï¼Œæ ¹æ®ç³»ç»Ÿçš„è´Ÿè½½æƒ…å†µå’Œèµ„æºæƒ…å†µåŠ¨æ€åœ°åˆ›å»ºæˆ–å¤ç”¨çº¿ç¨‹ã€‚å½“å¹¶è¡Œé˜Ÿåˆ—çš„ä»»åŠ¡å¤šäºåŒæ—¶å¯æ‰§è¡Œçš„çº¿ç¨‹æ•°æ—¶ï¼Œé˜Ÿåˆ—ä¸­çš„éƒ¨åˆ†ä»»åŠ¡ä¼šç­‰å¾…çº¿ç¨‹å¯ç”¨åæ‰ä¼šæ‰§è¡Œã€‚

  ç†è®ºä¸Šï¼Œé˜Ÿåˆ—çš„æ•°é‡å¹¶æ²¡æœ‰ç¡¬æ€§é™åˆ¶ï¼Œå¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ªé˜Ÿåˆ—ã€‚ç„¶è€Œç”±äºé˜Ÿåˆ—å ç”¨å†…å­˜ï¼Œè®¡ç®—æœºèµ„æºï¼ˆæ¯”å¦‚å†…å­˜ã€`CPU` æ—¶é—´ç‰‡ï¼‰æ˜¯æœ‰é™çš„ï¼Œå¦‚æœåˆ›å»ºå¤§é‡çš„é˜Ÿåˆ—å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ï¼Œæ€§èƒ½ä¸‹é™ï¼Œç”šè‡³ç¨‹åºå´©æºƒã€‚

:::

#### â“`dispatch_get_current_queue` ä¸ºä»€ä¹ˆè¢«åºŸå¼ƒ

::: details ğŸ’¡

  å®ƒåœ¨å¤æ‚å¹¶å‘ç¯å¢ƒä¸‹å®¹æ˜“å¼•å‘é—®é¢˜å’Œé”™è¯¯ã€‚

  - å®ƒçš„ç»“æœåœ¨ä¸åŒçš„è°ƒåº¦ç¯å¢ƒä¸‹å¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ã€‚ä»»åŠ¡å¯ä»¥åœ¨å¤šä¸ªé˜Ÿåˆ—ä¹‹é—´è¿ç§»ï¼Œå› æ­¤åœ¨è°ƒç”¨ `dispatch_get_current_queue` çš„æ—¶å€™ï¼Œè¿”å›çš„é˜Ÿåˆ—å¯èƒ½å¹¶ä¸æ˜¯çœŸæ­£æƒ³è¦çš„é˜Ÿåˆ—ã€‚

  - å¼€å‘è€…å¯èƒ½ä¼šæ»¥ç”¨ `dispatch_get_current_queue` è¿›è¡Œä¸€äº›åŒæ­¥ï¼ˆ`sync`ï¼‰è°ƒç”¨å¯¼è‡´æ­»é”ï¼Œè¿™æ ·ä½¿ç”¨æ˜¯éå¸¸å±é™©çš„ã€‚
    > ä¾‹å¦‚ï¼Œè°ƒç”¨è€…å¯èƒ½å°è¯•æ‰¾å‡ºå½“å‰æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå¹¶åœ¨å½“å‰æ‰§è¡Œçš„é˜Ÿåˆ—ä¸ŠåŒæ­¥è°ƒåº¦ä¸€ä¸ªæ–°çš„ä»»åŠ¡ã€‚å®ƒå¯èƒ½å¯¼è‡´æ­»é”ï¼Œå› ä¸ºæ–°ä»»åŠ¡åœ¨å½“å‰ä»»åŠ¡å®Œæˆä¹‹å‰æ— æ³•å¼€å§‹ã€‚
  
:::

### å¸¸ç”¨å‡½æ•°

#### â“`GCD` çš„ä¸€äº›å¸¸ç”¨çš„å‡½æ•°

::: details ğŸ’¡

  - `dispatch_queue_create`: åˆ›å»ºä¸€ä¸ªæ–°çš„ `dispatch` é˜Ÿåˆ—ã€‚

  - `dispatch_get_main_queue`: è·å–ä¸»é˜Ÿåˆ—ï¼Œå› ä¸º `UI` æ“ä½œåº”åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥é€šå¸¸ä¼šå°† `UI` æ“ä½œæ”¾åœ¨ä¸»é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚

  - `dispatch_async`: å¼‚æ­¥æ·»åŠ ä»»åŠ¡åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ã€‚æ­¤å‡½æ•°ç«‹å³è¿”å›ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚

  - `dispatch_sync`: åŒæ­¥æ·»åŠ ä»»åŠ¡åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ã€‚æ­¤å‡½æ•°ç›´åˆ°ä»»åŠ¡ç»“æŸæ‰è¿”å›ã€‚éœ€è¦é¿å…åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œå¦åˆ™å¯èƒ½é˜»å¡ä¸»çº¿ç¨‹é€ æˆ `UI` å¡é¡¿ã€‚

  - `dispatch_after`: åœ¨æŒ‡å®šæ—¶é—´åå°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚

  - `dispatch_once`: ç¡®ä¿æŸä¸ªä»»åŠ¡åœ¨åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸå†…åªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚ç»å¸¸ç”¨äºå•ä¾‹çš„å®ç°ã€‚

  - `dispatch_group_enter, dispatch_group_leave, dispatch_group_notify`: è¿™äº›å‡½æ•°ç”¨äºç®¡ç†ä¸€ç»„ä»»åŠ¡ã€‚å¯ä»¥ç­‰å¾…ä¸€ç»„ä»»åŠ¡å…¨éƒ¨å®Œæˆåå†æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œï¼Œæˆ–è€…æ¥æ”¶ä¸€ç»„ä»»åŠ¡å®Œæˆçš„é€šçŸ¥ã€‚
    
  - `dispatch_suspend, dispatch_resume`: åˆ†åˆ«ç”¨äºæš‚åœå’Œæ¢å¤é˜Ÿåˆ—ã€‚å¯ä»¥ç”¨æ¥æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œã€‚
    
:::

#### â“`dispatch_once` å®ç°åŸç†

::: details ğŸ’¡

  > `dispatch_once` æ˜¯ä¸€ä¸ª `GCD` æä¾›çš„æ‰§è¡Œä¸€æ¬¡ä¸”ä»…ä¸€æ¬¡çš„å‡½æ•°ï¼Œé€šå¸¸ç”¨äºå•ä¾‹çš„åˆå§‹åŒ–ã€‚`dispatch_once` æ‹¥æœ‰çº¿ç¨‹å®‰å…¨æ€§ï¼Œå³ä½¿åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œä¹Ÿå¯ä»¥ä¿è¯è¢«å°è£…çš„ä»£ç åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¼šå‡ºç°é‡å…¥é—®é¢˜ã€‚

```objc
static dispatch_once_t onceToken;
dispatch_once(&onceToken, ^{
    // è¿™æ®µä»£ç åœ¨åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡
});
```

å®ç°åŸç†ï¼š

  - `dispatch_once` ä½¿ç”¨ `OSAtomicCompareAndSwapLong` ç¡®ä¿åˆå§‹åŒ–ä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚è¿™ä¸ªå‡½æ•°ä¼šåŸå­æ€§åœ°æ¯”è¾ƒå‰ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°†ç¬¬ä¸‰ä¸ªå‚æ•°çš„å€¼èµ‹ç»™ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¹¶è¿”å› `true`ï¼›å¦åˆ™ç›´æ¥è¿”å› `false`ã€‚è¿™é‡Œåˆ©ç”¨è¿™ä¸ªåŸå­æ“ä½œï¼Œåªæœ‰ç¬¬ä¸€ä¸ªåˆ°è¾¾ `dispatch_once` çš„çº¿ç¨‹èƒ½å¤Ÿå°† `pred` ä» 0 å˜ä¸ºé 0ã€‚

  - `dispatch_once` çš„å®ç°ä¸­è¿˜ä½¿ç”¨äº†ä¸€ä¸ªä¿¡å·é‡ï¼ˆ`semaphore`ï¼‰æ¥ä¿è¯å³ä½¿åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–ä»£ç ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
    
:::

#### â“`dispatch_barrier_async` çš„ä½œç”¨æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

  > `dispatch_barrier_async`: ç”¨äºåœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šåˆ›å»ºä¸€ä¸ªå±éšœï¼Œé˜»æ­¢é˜Ÿåˆ—ä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å’Œè¿˜æ²¡æœ‰å¼€å§‹çš„ä»»åŠ¡åŒæ—¶è¿›è¡Œã€‚

  `dispatch_barrier_async` æäº¤çš„ä»»åŠ¡ä¼šç­‰å¾…åœ¨å®ƒä¹‹å‰æäº¤åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆåæ‰å¼€å§‹æ‰§è¡Œï¼ŒåŒæ—¶ï¼Œå®ƒåˆä¼šé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è‡ªå·±çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ‰ä¼šå¼€å§‹æ‰§è¡Œåœ¨å®ƒä¹‹åæäº¤çš„ä»»åŠ¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ`dispatch_barrier_async` æäº¤çš„ä»»åŠ¡ä¼šæ‹¥æœ‰æ•´ä¸ªé˜Ÿåˆ—ï¼Œå®ƒä¸éœ€è¦æ‹…å¿ƒè‡ªå·±çš„æ“ä½œä¼šä¸é˜Ÿåˆ—ä¸Šçš„å…¶ä»–ä»»åŠ¡å‘ç”Ÿå†²çªã€‚

  `dispatch_barrier_async` åªå¯¹è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—æœ‰æ•ˆã€‚å¯¹äºç³»ç»Ÿæä¾›çš„å…¨å±€å¹¶å‘é˜Ÿåˆ—å’Œä¸»é˜Ÿåˆ—ï¼ˆå®è´¨æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼‰`dispatch_barrier_async` ä¼šåƒæ™®é€šçš„ `dispatch_async` ä¸€æ ·ï¼Œä¸å…·æœ‰ "å±éšœ" çš„ç‰¹æ€§ã€‚

è¿™ä¸ªå‡½æ•°å¸¸è§çš„ç”¨æ³•æ˜¯åœ¨å¹¶å‘è¯»å–æ•°æ®çš„æ—¶å€™è¿›è¡Œæ•°æ®çš„å†™å…¥æ“ä½œï¼Œæˆ–è€…æ˜¯å¯¹æ•°æ®çš„åŸå­æ“ä½œã€‚

  ğŸŒ° å‡å¦‚æœ‰å¤šä¸ªçº¿ç¨‹åœ¨å¹¶å‘åœ°ä»ä¸€ä¸ªæ•°ç»„ä¸­è¯»å–æ•°æ®ï¼ŒåŒæ—¶åˆéœ€è¦åœ¨æŸä¸ªæ—¶åˆ»å‘è¿™ä¸ªæ•°ç»„ä¸­å†™å…¥æ•°æ®ï¼Œä¸ºäº†é˜²æ­¢æ•°æ®å†²çªï¼Œå¯ä»¥ä½¿ç”¨ `dispatch_barrier_async` è¿›è¡Œå†™æ“ä½œï¼Œè¿™æ ·åœ¨å†™å…¥æ•°æ®æ—¶å°±ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹åœ¨è¯»å–æ•°æ®ã€‚

```swift
// åˆå§‹åŒ–ä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—
let concurrentQueue = DispatchQueue(label: "concurrent.queue", attributes: .concurrent)
let array = NSMutableArray()

// è¯»æ“ä½œ
concurrentQueue.async {
    print("è¯»å–æ•°æ®ï¼š\(array)")
}

// å†™æ“ä½œ
concurrentQueue.async(flags: .barrier) {
    array.add("new data")
    print("å†™å…¥æ•°æ®ï¼šnew data")
}

```

:::

#### â“`dispatch_barrier_sync` ä¸ `dispatch_group_t` çš„åŒºåˆ«

::: details ğŸ’¡

  - `dispatch_barrier_sync`ä¸»è¦ç”¨äºåœ¨å¹¶å‘é˜Ÿåˆ—ä¸Šè®¾ç½®ä¸€ä¸ªâ€œå±éšœâ€ï¼Œé˜»æ­¢é˜Ÿåˆ—ä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å’Œè¿˜æ²¡æœ‰å¼€å§‹çš„ä»»åŠ¡åŒæ—¶è¿›è¡Œã€‚å±éšœä»»åŠ¡ä¼šç­‰å¾…åœ¨å®ƒä¹‹å‰æäº¤åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨å®Œæˆåæ‰å¼€å§‹æ‰§è¡Œï¼ŒåŒæ—¶å®ƒåˆä¼šé˜»å¡é˜Ÿåˆ—ï¼Œå¹¶åœ¨è‡ªå·±æ‰§è¡Œå®Œæˆåæ‰ä¼šè®©é˜Ÿåˆ—ä¸­çš„å…¶ä»–ä»»åŠ¡å¼€å§‹æ‰§è¡Œã€‚

  - `dispatch_group_t` ä¸»è¦æ˜¯ç”¨äºç®¡ç†å’ŒåŒæ­¥ä¸€ç»„ä»»åŠ¡ï¼Œå¯ä»¥è®©ä½ åœ¨ä¸€ç»„ä»»åŠ¡éƒ½å®Œæˆä»¥åå¾—åˆ°é€šçŸ¥æˆ–è€…ç­‰å¾…è¿™ç»„ä»»åŠ¡éƒ½å®Œæˆã€‚ä½ å¯ä»¥å¯¹è¿™ç»„ä»»åŠ¡è®¾ç½®å®Œæˆçš„å›è°ƒï¼Œä¹Ÿå¯ä»¥é€‰æ‹©é˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¿™ç»„ä»»åŠ¡éƒ½å®Œæˆã€‚

  ä¸¤è€…çš„åŒºåˆ«ï¼š`dispatch_barrier_sync` æ˜¯ç”¨äºåœ¨å¹¶å‘é˜Ÿåˆ—ä¸­åˆ›å»ºç‰¹æ®Šçš„ä¸²è¡Œæ‰§è¡Œç‚¹ï¼Œè€Œ `dispatch_group_t` æ˜¯ç”¨æ¥åŒæ­¥ä¸€ç»„ä»»åŠ¡ï¼Œç­‰å¾…å®ƒä»¬å…¨éƒ¨å®Œæˆã€‚

:::

#### â“`dispatch_barrier_sync` çš„åŠŸèƒ½ç”¨ `dispatch_group_t` å¦‚ä½•å®ç°

::: details ğŸ’¡

  `dispatch_group_t` å®ç° `dispatch_barrier_sync` çš„åŠŸèƒ½éœ€è¦ç»“åˆ `dispatch_semaphore_t` æ¥ä½¿ç”¨ã€‚å› ä¸º `dispatch_barrier_sync` æœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå°±æ˜¯ä¼šé˜»å¡å½“å‰çº¿ç¨‹æ¥å®ç°åŒæ­¥çš„æ•ˆæœï¼Œè€Œ `dispatch_group_t` æœ¬èº«æ˜¯æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½çš„ã€‚æ‰€ä»¥éœ€è¦ç”¨åˆ° `dispatch_semaphore_t` æ¥å®ç°é˜»å¡æ•ˆæœã€‚

```objc
dispatch_queue_t concurrentQueue = dispatch_queue_create("concurrent.queue", DISPATCH_QUEUE_CONCURRENT);
dispatch_semaphore_t sema = dispatch_semaphore_create(0);
dispatch_group_t group = dispatch_group_create();

dispatch_group_enter(group);
dispatch_async(concurrentQueue, ^{
    // ç¬¬ä¸€ä¸ªä»»åŠ¡
    dispatch_group_leave(group);
});

dispatch_group_enter(group);
dispatch_async(concurrentQueue, ^{
    // ç¬¬äºŒä¸ªä»»åŠ¡
    dispatch_group_leave(group);
});

dispatch_group_notify(group, concurrentQueue, ^(){
    dispatch_async(concurrentQueue, ^{
        // å±éšœä»»åŠ¡ã€‚è¿™ä¸ªä»»åŠ¡ä¼šç­‰å‰é¢çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œå†æ‰§è¡Œ
        dispatch_semaphore_signal(sema);  // ä»»åŠ¡å®Œæˆï¼Œå‘é€ä¿¡å·
    });
});

dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);  // ç­‰å¾…ä¿¡å·ï¼Œå®ç°é˜»å¡æ•ˆæœ
// å±éšœä»»åŠ¡æ‰§è¡Œå®Œæ¯•
```

:::

### å®é™…åº”ç”¨

#### â“å¦‚ä½•ç”¨ `GCD` åŒæ­¥è‹¥å¹²ä¸ªå¼‚æ­¥è°ƒç”¨

::: details ğŸ’¡

  é€šè¿‡ `dispatch_group_t`ï¼ˆè°ƒåº¦ç»„ï¼‰æ¥å®ç°å¤šä¸ªå¼‚æ­¥è°ƒç”¨çš„åŒæ­¥ã€‚

```objc
// åˆ›å»ºä¸€ä¸ªè°ƒåº¦ç»„
dispatch_group_t group = dispatch_group_create();

// åœ¨å¼‚æ­¥å›è°ƒæ‰§è¡Œå‰è°ƒç”¨ dispatch_group_enter å°†ä»»åŠ¡æ·»åŠ åˆ°è°ƒåº¦ç»„
dispatch_group_enter(group);
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    // åšä¸€äº›å¼‚æ­¥æ“ä½œ...
    
    // æ‰§è¡Œå®Œåè°ƒç”¨ dispatch_group_leave å°†ä»»åŠ¡ä»è°ƒåº¦ç»„ç§»é™¤
    dispatch_group_leave(group);
});

dispatch_group_enter(group);
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    // åšä¸€äº›å¼‚æ­¥æ“ä½œ...
    dispatch_group_leave(group);
});

// ç›‘å¬è°ƒåº¦ç»„ä»»åŠ¡éƒ½å·²å®Œæˆ
dispatch_group_notify(group, dispatch_get_main_queue(), ^{
    // å½“ group ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œä¼šæ‰§è¡Œè¿™ä¸ª block
    NSLog(@"All tasks are finished.");
});
``` 

:::

#### â“`GCD` ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿçš„æ­»é”ç°è±¡

::: details ğŸ’¡

  åœ¨ä½¿ç”¨ Grand Central Dispatchï¼ˆ`GCD`ï¼‰è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œæ­»é”é€šå¸¸å‘ç”Ÿåœ¨å½“å‰çº¿ç¨‹åŒæ­¥æ´¾å‘ï¼ˆ`sync`ï¼‰ä¸€ä¸ª `block` åˆ°å½“å‰çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šç­‰å¾…è¯¥ä»»åŠ¡å®Œæˆï¼Œä½†æ˜¯è¿™ä¸ªä»»åŠ¡å´æ­£åœ¨ç­‰å¾…å½“å‰çº¿ç¨‹ç©ºé—²ï¼Œä»è€Œå½¢æˆäº†ä¸€ä¸ªå¾ªç¯ç­‰å¾…ï¼Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚

```swift
// ä¸»é˜Ÿåˆ—ï¼Œå¼‚æ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶ååœ¨è¿™ä¸ªä»»åŠ¡ä¸­åŒæ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡åˆ°ä¸»é˜Ÿåˆ—
DispatchQueue.main.async {
    DispatchQueue.main.sync {
        // do something
    }
}
// ä¸²è¡Œé˜Ÿåˆ—ï¼ŒåŒæ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶ååœ¨è¿™ä¸ªä»»åŠ¡ä¸­åˆåŒæ­¥æ´¾å‘ä¸€ä¸ªä»»åŠ¡åˆ°è¿™ä¸ªä¸²è¡Œé˜Ÿåˆ—
let queue = DispatchQueue(label: "my.queue")
queue.sync {
    queue.sync {
        // do something
    }
}

// å¹¶è¡Œé˜Ÿåˆ—ï¼Œå¼‚æ­¥åœ°å¯åŠ¨äº†ä»»åŠ¡ 1ã€‚ç„¶åï¼Œåœ¨ä»»åŠ¡ 1 çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¯•å›¾åŒæ­¥åœ°å¯åŠ¨ä»»åŠ¡ 2
let queue = DispatchQueue(label: "my.queue", attributes: .concurrent)
queue.async {
    print("Task 1 started")
    queue.sync {
        print("Task 2 started")
    }
    print("Task 1 finished")
}
```

:::

#### â“`GCD` å·²ç»è°ƒç”¨èƒ½ä¸èƒ½å–æ¶ˆ

::: details ğŸ’¡

  `GCD` ä¸­çš„ä»»åŠ¡ï¼ˆ`Block`ï¼‰å·²ç»å¼€å§‹æ‰§è¡Œï¼Œå°±æ— æ³•å–æ¶ˆã€‚`GCD` çš„ `API` å¹¶æœªæä¾›ä¸»åŠ¨å–æ¶ˆ `Block` æ‰§è¡Œçš„åŠŸèƒ½ã€‚

```objc
// ä½¿ç”¨æ ‡è®°ç¬¦å®ç°ç±»ä¼¼â€œå–æ¶ˆâ€æ‰§è¡Œçš„æ•ˆæœ
__block BOOL taskShouldExit = NO;
dispatch_async(myQueue, ^{
    while (!taskShouldExit) {
        // ä½ çš„ä»»åŠ¡ä»£ç 
    }
});
```

:::

------

## NSOperation

### â“äº†è§£ `NSOperation` ä¸ `NSOperationQueue` å—

::: details ğŸ’¡

  > `NSOperation` å’Œ `NSOperationQueue` æ˜¯åŸºäº `GCD` è¿›è¡Œäº†é¢å‘å¯¹è±¡çš„å°è£…ï¼Œæä¾›äº†æ›´å¤šçš„æ§åˆ¶å’Œç®¡ç†ä»»åŠ¡çš„åŠŸèƒ½ã€‚

  - `NSOperation` è¡¨ç¤ºä¸€ä¸ªå•ä¸€çš„ä»»åŠ¡ã€‚
    > å¯ä»¥é€šè¿‡ç»§æ‰¿ `NSOperation` å¹¶å®ç°å…¶ä¸»æ–¹æ³•æ¥å®šä¹‰è‡ªå·±çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `NSInvocationOperation` å’Œ `NSBlockOperation` æ¥åˆ›å»ºæ“ä½œã€‚
    
  - `NSOperationQueue` æ˜¯ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—ï¼Œæ˜¯ `NSOperation` çš„æ‰§è¡Œè€…ã€‚
    > å¯ä»¥æŠŠ `NSOperation` å¯¹è±¡æ·»åŠ åˆ° `NSOperationQueue` ä¸­ï¼Œé˜Ÿåˆ—ä¼šè‡ªåŠ¨è°ƒåº¦å¹¶æ‰§è¡Œé‡Œé¢çš„æ“ä½œã€‚

ä¼˜ç‚¹ï¼š

  - æ”¯æŒä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚
    > å¯ä»¥é€šè¿‡ `addDependency:` æ–¹æ³•æ¥å®šä¹‰æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚é˜Ÿåˆ—ä¼šç¡®ä¿ä¸€ä¸ªæ“ä½œåœ¨å…¶æ‰€æœ‰ä¾èµ–çš„æ“ä½œéƒ½å·²ç»å®Œæˆä¹‹åæ‰å¼€å§‹æ‰§è¡Œã€‚

  - å…è®¸å–æ¶ˆæ“ä½œã€‚
    > `NSOperation` æä¾›äº† `cancel` æ–¹æ³•ï¼Œå¯ä»¥å–æ¶ˆæœªæ‰§è¡Œçš„æ“ä½œã€‚è¿™æ˜¯ `GCD` æ— æ³•åšåˆ°çš„ã€‚

  - æ”¯æŒä¼˜å…ˆçº§ã€‚
    > å¯ä»¥é€šè¿‡ `queuePriority` å±æ€§æ¥è®¾å®šæ“ä½œçš„ä¼˜å…ˆçº§ã€‚é˜Ÿåˆ—ä¼šä¼˜å…ˆè°ƒåº¦ä¼˜å…ˆçº§é«˜çš„æ“ä½œã€‚

  - æ”¯æŒ `KVO`ã€‚
    > å¯ä»¥è§‚å¯Ÿ `NSOperation` çš„ `isExecuting`ã€`isFinished` ç­‰å±æ€§ï¼Œä»¥è·å–æ“ä½œçš„æ‰§è¡ŒçŠ¶æ€ã€‚

  - å¯ä»¥é™åˆ¶æœ€å¤§å¹¶å‘æ•°é‡ã€‚
    > é€šè¿‡ `NSOperationQueue` çš„ `maxConcurrentOperationCount` å±æ€§ï¼Œå¯ä»¥è®¾å®šé˜Ÿåˆ—ä¸­åŒæ—¶æ‰§è¡Œçš„æ“ä½œçš„æœ€å¤§æ•°é‡ã€‚

:::

### â“æœ‰å“ªäº›åœºæ™¯æ˜¯ `NSOperation` æ¯” `GCD` æ›´å®¹æ˜“å®ç°çš„

::: details ğŸ’¡

  - **æ“ä½œä¾èµ–**ï¼š`NSOperation` å¯ä»¥è®¾ç½®ä¾èµ–ï¼Œæ¯”å¦‚æ“ä½œ A å’Œæ“ä½œ Bï¼Œå¯ä»¥è®¾ç½®æ“ä½œ B ä¾èµ–äºæ“ä½œ Aï¼Œè¿™æ ·æ“ä½œ A æ‰§è¡Œå®Œæ¯•åï¼Œæ“ä½œ B æ‰ä¼šæ‰§è¡Œã€‚è¿™åœ¨ `GCD` ä¸­ä¸å®¹æ˜“å®ç°ã€‚

   ```swift
   let operationA = BlockOperation { /* Your task A here */ }
   let operationB = BlockOperation { /* Your task B here */ }
   operationB.addDependency(operationA)
   let queue = OperationQueue()
   queue.addOperation(operationA)
   queue.addOperation(operationB)
   ```

  - **æ“ä½œå–æ¶ˆ**ï¼š`NSOperation` å¯ä»¥åœ¨æ“ä½œæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«å–æ¶ˆã€‚å¦‚æœæœ‰å¤šä¸ªæ“ä½œå¹¶è¡Œæˆ–ä¸²è¡Œæ‰§è¡Œï¼Œä¸”åœ¨æŸäº›æ¡ä»¶ä¸‹éœ€è¦æå‰ç»“æŸæŸäº›è¿˜æœªæ‰§è¡Œçš„æ“ä½œï¼Œé‚£ä¹ˆä½¿ç”¨ `NSOperation` å°±å¾ˆå®¹æ˜“å¤„ç†ã€‚

   ```swift
   let operation = BlockOperation { /* Your task here */ }
   let queue = OperationQueue()
   queue.addOperation(operation)
   operation.cancel()
   ```
  
  - **æ“ä½œçŠ¶æ€æ§åˆ¶**ï¼š`NSOperation` å…è®¸ä½ æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶å’ŒæŸ¥è¯¢æ“ä½œçš„çŠ¶æ€ï¼ˆä¾‹å¦‚æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œæ˜¯å¦å·²ç»å®Œæˆç­‰ï¼‰ã€‚è¿™åœ¨ `GCD` ä¸­ä¸å®¹æ˜“å®ç°ã€‚
    
  - **æ“ä½œä¼˜å…ˆçº§**ï¼š`NSOperation` å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œè¿™å¯ä»¥ç”¨äºæ§åˆ¶å¤šä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚è¿™åœ¨ `GCD` ä¸­ä¸å®¹æ˜“å®ç°ã€‚
    
  - **é‡å¤æ‰§è¡Œ/å»¶è¿Ÿæ‰§è¡Œæ“ä½œ**ï¼š`NSOperation` å¯ä»¥é€šè¿‡ `NSOperationQueue` çš„ `maxConcurrentOperationCount` å±æ€§æ¥æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„æ“ä½œæ•°ï¼Œè€Œ `GCD` åˆ™éœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚`NSOperation` ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® `start` æ–¹æ³•çš„è°ƒç”¨æ—¶æœºæ¥å®ç°å»¶è¿Ÿæ‰§è¡Œã€‚
    
:::

### â“`NSOperationQueue` ä¸­çš„ `maxConcurrentOperationCount` é»˜è®¤å€¼

::: details ğŸ’¡

é»˜è®¤å€¼æ˜¯ `NSOperationQueueDefaultMaxConcurrentOperationCount`ï¼Œå…¶å€¼ä¸º `-1`ã€‚

  - `NSOperationQueueDefaultMaxConcurrentOperationCount`ï¼Œè¡¨ç¤ºè¯¥é˜Ÿåˆ—ä»¥å¹¶å‘æ–¹å¼è¿è¡Œæ‰€æœ‰å¯ä»¥è¿è¡Œçš„æ“ä½œã€‚å…·ä½“å¯ä»¥è¿è¡Œçš„æ“ä½œæ•°ä¼šå–å†³äºç³»ç»Ÿæ¡ä»¶ã€‚

  - `maxConcurrentOperationCount` çš„å€¼å¤§äº `1`ï¼Œåˆ™é˜Ÿåˆ—å¯ä»¥å¹¶å‘åœ°è¿è¡Œå¤šä¸ªæ“ä½œï¼Œå…·ä½“æ•°é‡ä¸ä¼šè¶…è¿‡è®¾ç½®çš„å€¼ã€‚

  - `maxConcurrentOperationCount` çš„å€¼ä¸º `1`ï¼Œé˜Ÿåˆ—ä¼šå˜æˆä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚æ³¨æ„è¿™æ—¶å¹¶ä¸å…·å¤‡ä¸²è¡Œé˜Ÿåˆ—çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ä¸ä¿è¯æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚

å¹¶å‘æ“ä½œå’Œä¸²è¡Œæ“ä½œçš„ä¸»è¦åŒºåˆ«åœ¨äºï¼šå¹¶å‘æ“ä½œå¯èƒ½åŒæ—¶åœ¨å…¶ä»–çº¿ç¨‹ä¸Šè¿è¡Œï¼Œè€Œä¸²è¡Œæ“ä½œæ€»æ˜¯åœ¨ä¸€ä¸ªç‰¹å®šçš„çº¿ç¨‹ï¼ˆå¯èƒ½ä¸æ€»æ˜¯ç›¸åŒçš„çº¿ç¨‹ï¼‰ä¸ŠæŒ‰åºè¿è¡Œï¼Œä¸ä¼šå¹¶å‘æ‰§è¡Œã€‚

:::

### â“`NSOperation` æ˜¯å¦‚ä½•ç»ˆæ­¢/å–æ¶ˆä»»åŠ¡çš„

::: details ğŸ’¡

  `cancel` æ–¹æ³•ï¼Œå¯ä»¥å°†æ“ä½œæ ‡è®°ä¸ºå–æ¶ˆã€‚ç„¶è€Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å¹¶ä¸ä¼šç«‹å³åœæ­¢å·²ç»åœ¨æ‰§è¡Œçš„æ“ä½œï¼Œä¹Ÿä¸ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²ç»è¢«æ ‡è®°ä¸ºå–æ¶ˆçš„æ“ä½œã€‚

å–æ¶ˆä¸€ä¸ªæ“ä½œä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š
  
 - å®ƒä¼šè®¾ç½®æ“ä½œçš„ `isCancelled` å±æ€§ä¸º `YES`ã€‚å¯ä»¥åœ¨æ“ä½œçš„æ‰§è¡Œä»£ç ä¸­æ£€æŸ¥è¿™ä¸ªå±æ€§çš„å€¼ï¼Œå¦‚æœå‘ç°å·²ç»è¢«å–æ¶ˆï¼Œå°±å¯ä»¥å°½å¿«ç»ˆæ­¢æ‰§è¡Œä»£ç ã€‚

 - å¦‚æœæ“ä½œè¿˜åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰è¢«å¼€å§‹æ‰§è¡Œï¼Œé‚£ä¹ˆåœ¨æ“ä½œè¢«å–æ¶ˆåï¼Œå®ƒå°±æ°¸è¿œä¸ä¼šå¼€å§‹æ‰§è¡Œäº†ã€‚

  ç»ˆæ­¢/å–æ¶ˆä¸€ä¸ª `NSOperation` éœ€è¦ä¸»åŠ¨å»æŸ¥è¯¢ `isCancelled` å±æ€§å¹¶æ ¹æ®è¿™ä¸ªå±æ€§çš„å€¼å†³å®šæ˜¯å¦æå‰é€€å‡ºæ‰§è¡Œä»£ç ã€‚è¿™å°±è¦æ±‚æ‰§è¡Œä»£ç éœ€è¦å®šæœŸæ£€æŸ¥è¿™ä¸ªå±æ€§çš„å€¼ã€‚å¦‚æœæ“ä½œçš„ä»»åŠ¡å¾ˆå¿«å°±å¯ä»¥å®Œæˆï¼Œå¯èƒ½ä¸éœ€è¦æ£€æŸ¥ã€‚ä½†å¯¹äºå¯èƒ½è¿è¡Œæ—¶é—´è¾ƒé•¿çš„ä»»åŠ¡ï¼Œæœ€å¥½åœ¨æ“ä½œä»£ç ä¸­å®šæœŸæ£€æŸ¥ `isCancelled` å±æ€§ï¼Œè¿™æ ·åœ¨æ“ä½œè¢«å–æ¶ˆæ—¶ï¼Œå¯ä»¥å°½å¿«å“åº”ã€‚

:::

### â“`NSOperation` å¯åŠ¨çš„ä¸¤ç§æ–¹å¼(`start` å’Œ `main`)çš„åŒºåˆ«

::: details ğŸ’¡
    
  - `start` æ–¹æ³•æ˜¯ç”¨æ¥å¼€å§‹æ‰§è¡Œ `operation` çš„ã€‚
    > å½“è°ƒç”¨ä¸€ä¸ª `operation` çš„ `start` æ–¹æ³•æ—¶ï¼Œ`operation` ä¼šæ ¹æ®å®ƒçš„ `isReady` å±æ€§æ¥å†³å®šæ˜¯å¦ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼Œæˆ–è€…æŠŠä»»åŠ¡æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚
    * å¦‚æœ `isReady == true`ï¼ˆä¾èµ–çš„å…¶ä»– `operations` éƒ½å·²ç»å®Œæˆï¼‰ã€‚`start` ä¼šè°ƒç”¨ `main` æ–¹æ³•æ¥æ‰§è¡Œå®é™…çš„ä»»åŠ¡ã€‚é€šå¸¸ä¸éœ€è¦ï¼ˆä¹Ÿä¸åº”è¯¥ï¼‰æ‰‹åŠ¨è°ƒç”¨ `start` æ–¹æ³•ï¼Œè€Œæ˜¯åº”è¯¥æŠŠ `operation` å¯¹è±¡æ·»åŠ åˆ° `operation queue` ä¸­ï¼Œè®© `queue` æ¥ç®¡ç† `operation` çš„ç”Ÿå‘½å‘¨æœŸã€‚
    * å¦‚æœ  `isReady == false`ï¼ˆè¡¨ç¤º `operation` è¿˜æœ‰å…¶ä»–çš„ `dependencies` æ²¡æœ‰å®Œæˆï¼‰ï¼Œé‚£ä¹ˆè¯¥ `operation` å°†ä¸èƒ½ç«‹å³å¼€å§‹ã€‚

  - `main` æ–¹æ³•æ˜¯éœ€è¦åœ¨è‡ªå®šä¹‰çš„ `NSOperation` å­ç±»ä¸­å®ç°çš„æ–¹æ³•ï¼Œç”¨æ¥æŒ‡å®š `operation` çš„å®é™…å·¥ä½œå†…å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ `main` æ–¹æ³•ä¸­å®šä¹‰ `operation` å¯¹è±¡æ‰€è¦å®Œæˆçš„ä»»åŠ¡ã€‚å½“ `start` æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸” `operation` å¯¹è±¡å·²ç»å‡†å¤‡å¥½è¿è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ `main` æ–¹æ³•ã€‚

:::

### â“æœ‰è‡ªå®šä¹‰è¿‡ `NSOperation` å—

::: details ğŸ’¡

```swift
class CustomOperation: Operation {
    override func main() {
        // `operation` çš„å–æ¶ˆçŠ¶æ€ï¼Œå¦‚æœå·²å–æ¶ˆï¼Œç«‹å³è¿”å›å¹¶ç»“æŸæ‰§è¡Œã€‚
        if isCancelled {
            return
        }
        // Put the task code here.
        print("Task starts")

        Thread.sleep(forTimeInterval: 2)
        
        if isCancelled {
            return
        }
        
        // Task is finished.
        print("Task finished")
    }
}

// åˆ›å»ºè¿™ä¸ªè‡ªå®šä¹‰æ“ä½œçš„å®ä¾‹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—
let operation = CustomOperation()
let operationQueue = OperationQueue()

operationQueue.addOperation(operation)
```
ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `addDependency(_:)` è®¾ç½® operation ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæˆ–è€…ä½¿ç”¨ `queuePriority` å’Œ `qualityOfService` è®¾ç½® operation çš„ä¼˜å…ˆçº§å’ŒæœåŠ¡è´¨é‡ç­‰ç­‰ã€‚

è¿™æ ·ï¼Œå½“æ“ä½œè¢«æ·»åŠ åˆ°æ“ä½œé˜Ÿåˆ—åï¼Œé˜Ÿåˆ—ä¼šè‡ªåŠ¨å¼€å§‹æ‰§è¡Œæ“ä½œã€‚å¦‚æœ operation æ²¡æœ‰ä¾èµ–å…¶ä»–æ“ä½œä¸”æ“ä½œé˜Ÿåˆ—æ²¡æœ‰æš‚åœï¼Œåˆ™æ“ä½œä¼šç«‹å³å¼€å§‹ã€‚è€Œä¸€æ—¦ operation å¼€å§‹æ‰§è¡Œï¼Œ`NSOperationQueue` ä¼šè°ƒç”¨ operation çš„ `start` æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨ `main` æ–¹æ³•ï¼Œæ‰§è¡Œä½ åœ¨ `main` æ–¹æ³•ä¸­å®šä¹‰çš„ä»»åŠ¡ã€‚

:::


------

## çº¿ç¨‹è®¾è®¡

### â“å¦‚æœè®©ä½ æ¥å®ç°å±æ€§çš„ `atomic`ï¼Œå¦‚ä½•å®ç°

::: details ğŸ’¡

  å¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼Œå¯¹è¯»å†™æ“ä½œè¿›è¡Œä¿æŠ¤ï¼Œæ¥é˜²æ­¢ä¸åŒçº¿ç¨‹ä¸­çš„è¯»å†™æ“ä½œç›¸äº’å¹²æ‰°ã€‚

```swift
public class Atomic<T> {
    // å®šä¹‰ `DispatchQueue` æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œæ˜¯äº’æ–¥çš„
    private let queue = DispatchQueue(label: "queue.atomic.lock")
    private var value: T
    public init(_ value: T) {
        self.value = value
    }
    // get set ä¸­è¿›è¡ŒåŠ é”ä¿æŠ¤
    public var atomicValue: T {
        set {
            queue.sync {
                value = newValue
            }
        }
        get {
            return queue.sync {
                value
            }
        }
    }
}
```

:::

### â“å¦‚ä½•å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ `NSMutableArray`

::: details ğŸ’¡

- ä½¿ç”¨ `@synchronized`
    > `@synchronized` ä¼šä½¿ç”¨ç»™å®šçš„å¯¹è±¡ä½œä¸ºé”ï¼Œåœ¨åŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°è¿™ä¸ªé”å¹¶æ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚å…¶ä»–å°è¯•è·å–è¿™ä¸ªé”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚

    ```objc
    @implementation ThreadSafeMutableArray {
        NSMutableArray *_array;
        NSObject *_lock;
    }
    
    - (id)init {
        self = [super init];
        if (self) {
            _array = [NSMutableArray array];
            _lock = [[NSObject alloc] init];
        }
        return self;
    }
    
    - (id)objectAtIndex:(NSUInteger)index {
        id obj = nil;
        @synchronized(_lock) {
            obj = [_array objectAtIndex:index];
        }
        return obj;
    }
    
    - (void)addObject:(id)anObject {
        @synchronized(_lock) {
            [_array addObject:anObject];
        }
    }
    @end
    ```

- `GCD` çš„ä¸²è¡Œé˜Ÿåˆ—
    > åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸Šæ‰§è¡Œçš„ä»»åŠ¡ä¼šä¸€æ¬¡æ‰§è¡Œä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ç¡®ä¿å¯¹ `_array` çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³ä½¿æœ‰å¤šä¸ªçº¿ç¨‹éƒ½åœ¨ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ã€‚

    ```objc
    @implementation ThreadSafeMutableArray
    {
        NSMutableArray *_array;
        dispatch_queue_t _queue;
    }
    
    - (id)init {
        self = [super init];
        if (self) {
            _array = [NSMutableArray array];
            _queue = dispatch_queue_create("com.example.ThreadSafeMutableArray", DISPATCH_QUEUE_SERIAL);
        }
        return self;
    }
    
    - (id)objectAtIndex:(NSUInteger)index {
        __block id obj;
        dispatch_sync(_queue, ^{
            obj = [_array objectAtIndex:index];
        });
        return obj;
    }
    
    - (void)addObject:(id)anObject {
        dispatch_sync(_queue, ^{
            [_array addObject:anObject];
        });
    }
    @end
    ```
    
  æ— è®ºæ˜¯ä½¿ç”¨ `@synchronized` è¿˜æ˜¯ä½¿ç”¨ `GCD` çš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œéƒ½ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ã€‚æ‰€ä»¥åœ¨ä¸€äº›å¯¹æ€§èƒ½éå¸¸æ•æ„Ÿçš„ç¯å¢ƒä¸­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨æ›´ä½çº§çš„ `API`ï¼Œå¦‚ `pthread_mutex_t` æˆ– `os_unfair_lock`ï¼Œæ¥å®ç°çº¿ç¨‹å®‰å…¨ï¼Œæˆ–è€…å°½é‡é¿å…åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«æ•°æ®ã€‚

æ³¨æ„ï¼š`NSArray` å’Œ `NSMutableArray` çš„ä¸€äº›æ–¹æ³•å¯èƒ½ä¼šäº§ç”Ÿæ„å¤–çš„å¹¶å‘é—®é¢˜ã€‚
  > ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è®¿é—®ä¸€ä¸ª `NSMutableArray` çš„å…ƒç´ ï¼ŒåŒæ—¶åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ä¿®æ”¹è¿™ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆå³ä½¿ä»£ç æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¹Ÿå¯èƒ½ä¼šå¼•å‘å¼‚å¸¸ã€‚è¿™æ˜¯å› ä¸º `NSMutableArray` å†…éƒ¨çš„å®ç°å¯èƒ½å¹¶éçº¿ç¨‹å®‰å…¨ã€‚åªèƒ½åœ¨åŒä¸€æ—¶é—´å¯¹æ•°ç»„è¿›è¡Œè¯»å–æˆ–è€…å†™å…¥æ“ä½œï¼Œä¸èƒ½åŒæ—¶è¿›è¡Œä¸¤è€…ã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨ `NSMutableArray` æ—¶ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰è®¿é—®å’Œä¿®æ”¹éƒ½æ˜¯ä¸²è¡Œçš„ï¼Œæ‰èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

:::

### â“`iOS` ä¸­å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹

::: details ğŸ’¡

  åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œåå°±ç«‹å³é€€å‡ºï¼Œè€Œæ˜¯èƒ½å¤Ÿç­‰å¾…æ–°çš„ä»»åŠ¡çš„åŠ å…¥å¹¶æ‰§è¡Œã€‚è¿™åœ¨å¤„ç†ä¸€äº›æŒä¹…çš„ã€å‘¨æœŸæ€§çš„æˆ–è€…éœ€è¦åœ¨ç‰¹å®šçº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»»åŠ¡éå¸¸æœ‰ç”¨ã€‚

  æ ¸å¿ƒç‚¹åœ¨äºåˆ›å»ºçº¿ç¨‹æ—¶ï¼Œå¯åŠ¨ `RunLoop`ï¼Œä½†æ˜¯ `RunLoop` å¦‚æœåœ¨æ²¡æœ‰ä»»ä½•äº‹ä»¶æºæ—¶ä¼šé€€å‡ºï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ ä¸€ä¸ª `port` äº‹ä»¶è®© `RunLoop` ä¸€ç›´è¿è¡Œã€‚
    
  ```swift
  /// å®ˆæŠ¤çº¿ç¨‹
  class DaemonThread: NSObject {
    // åˆ›å»ºçš„å®ˆæŠ¤çº¿ç¨‹ï¼Œå¹¶å¼€å¯ä¸€ä¸ªRunloop
    private lazy var thread = Thread {
        // æ·»åŠ äº†ä¸€ä¸ª port äº‹ä»¶æºåˆ° RunLoop ä¸­é˜²æ­¢å®ƒå› ä¸ºæ²¡æœ‰äº‹ä»¶æºç«‹å³é€€å‡º
        RunLoop.current.add(Port(), forMode: .default)
        // å¯åŠ¨ RunLoop
        RunLoop.current.run()
    }
    
    override init() {
        super.init()
        // å¯åŠ¨çº¿ç¨‹
        thread.start()
    }
    /// åœ¨å®ˆæŠ¤è¿›ç¨‹æ‰§è¡Œä»»åŠ¡
    func execute(task: @escaping () -> ()) {
        perform(#selector(runTask(_:)), on: thread, with: task, waitUntilDone: false)
    }
    /// åœæ­¢å®ˆæŠ¤çº¿ç¨‹
    func stop() {
        perform(#selector(clear), on: thread, with: nil, waitUntilDone: false)
    }
    
    /// æ¸…ç†èµ„æº : åœæ­¢ RunLoopã€é€€å‡ºçº¿ç¨‹
    @objc private func clear() {
        CFRunLoopStop(CFRunLoopGetCurrent())
        Thread.exit()
    }
    /// æ‰§è¡Œä»»åŠ¡
    @objc private func runTask(_ task: () -> ()) {
        task()
    }
  }
  ```

:::

### â“`iOS` ä¸‹å¦‚ä½•å®ç°æŒ‡å®šçº¿ç¨‹æ•°ç›®çš„çº¿ç¨‹æ± 

::: details ğŸ’¡

å¯ä»¥ä½¿ç”¨ `NSOperationQueue` æ¥å®ç°çº¿ç¨‹æ± ï¼š

```swift
let operationQueue = OperationQueue()
operationQueue.maxConcurrentOperationCount = 5  // æŒ‡å®šçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸º5
for i in 1...10 {
    let operation = BlockOperation {
        print("Task \(i) is executing in thread: \(Thread.current)")
    }
    operationQueue.addOperation(operation)
}
```

æ³¨æ„ï¼šé˜Ÿåˆ—æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰çœŸæ­£åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡ `GCD` æ¥è°ƒåº¦ä»»åŠ¡çš„æ‰§è¡Œï¼ŒèƒŒåçœŸæ­£å¤„ç†å¹¶å‘çš„å¯èƒ½æ˜¯çº¿ç¨‹ä¹Ÿå¯èƒ½æ˜¯æ›´åº•å±‚çš„æœºåˆ¶ã€‚

:::

### â“æœ‰ `aã€bã€cã€d` 4ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œå¦‚ä½•åˆ¤æ–­ `aã€bã€cã€d` éƒ½å®Œæˆæ‰§è¡Œ

::: details ğŸ’¡

```objc
dispatch_group_t group = dispatch_group_create();
dispatch_queue_t queue = dispatch_queue_create("my.queue", DISPATCH_QUEUE_SERIAL);

dispatch_group_async(group, queue, ^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚A...
});
dispatch_group_async(group, queue, ^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚B...
});
dispatch_group_async(group, queue, ^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚C...
});
dispatch_group_async(group, queue, ^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚D...
});

dispatch_group_notify(group, dispatch_get_main_queue(), ^{
    // åœ¨è¿™é‡Œå¤„ç†Aã€Bã€Cã€Då…¨éƒ¨å®Œæˆåçš„é€»è¾‘...
});
```

:::

> â“å¦‚æœéœ€è¦ `aã€bã€cã€d` é¡ºåºæ‰§è¡Œï¼Œè¯¥å¦‚ä½•å®ç°

::: details ğŸ’¡

  é€šè¿‡`NSOperation`çš„`dependencies`å±æ€§æ¥æ§åˆ¶æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—ä»–ä»¬æŒ‰é¡ºåºæ‰§è¡Œã€‚å½“æ‰€æœ‰æ“ä½œéƒ½å®Œæˆæ‰§è¡Œåï¼Œå†æ·»åŠ ä¸€ä¸ªæ–°çš„æ“ä½œåˆ°é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ“ä½œå°±ç›¸å½“äºâ€œå…¨éƒ¨å®Œæˆâ€çš„å›è°ƒã€‚

```objc
NSOperationQueue *queue = [[NSOperationQueue alloc] init];

NSBlockOperation *operationA = [NSBlockOperation blockOperationWithBlock:^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚A...
}];
NSBlockOperation *operationB = [NSBlockOperation blockOperationWithBlock:^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚B...
}];
[operationB addDependency:operationA]; // Bä¾èµ–A

NSBlockOperation *operationC = [NSBlockOperation blockOperationWithBlock:^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚C...
}];
[operationC addDependency:operationB]; // Cä¾èµ–B

NSBlockOperation *operationD = [NSBlockOperation blockOperationWithBlock:^{
    // æ‰§è¡Œå¼‚æ­¥è¯·æ±‚D...
}];
[operationD addDependency:operationC]; // Dä¾èµ–C

[queue addOperations:@[operationA, operationB, operationC, operationD] waitUntilFinished:NO];

NSBlockOperation *finishOperation = [NSBlockOperation blockOperationWithBlock:^{
    // åœ¨è¿™é‡Œå¤„ç†Aã€Bã€Cã€Då…¨éƒ¨å®Œæˆåçš„é€»è¾‘...
}];
[finishOperation addDependency:operationD];

[queue addOperation:finishOperation];
```

:::

### â“ç°åœ¨æœ‰ 20 ä¸ªå¼‚æ­¥è¯·æ±‚éœ€è¦å‘é€ï¼Œè¦æ±‚å°†åŒä¸€æ—¶åˆ»çš„å¹¶å‘è¯·æ±‚æ•°é‡æ§åˆ¶åœ¨ 3 ä¸ªä»¥å†…ï¼Œå¦‚ä½•å®ç°

::: details ğŸ’¡

```swift
// é€šè¿‡ä¿¡å·é‡æ§åˆ¶åŒæ—¶è¿›è¡Œçš„ä»»åŠ¡æ•°
let semaphore = DispatchSemaphore(value: 3)
// ç”¨äºæ‰€æœ‰è¯·æ±‚å®Œæˆä¹‹åçš„é€šçŸ¥
let group = DispatchGroup()

let urls: [URL] = [...] // 20 ä¸ª URL

for url in urls {
    group.enter()
    semaphore.wait()
    URLSession.shared.dataTask(with: url) { (data, response, error) in
        // åœ¨è¿™é‡Œå¤„ç†è¯·æ±‚ç»“æœ
       semaphore.signal()
       group.leave()
    }.resume()
}

group.notify(queue: .main) {
    print("æ‰€æœ‰è¯·æ±‚éƒ½å·²ç»å®Œæˆï¼")
}
```

:::

### â“ä¸‹é¢è¿™æ®µä¼ªä»£ç å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚ä½•æ”¹è¿›

```objc
int main(int argc, const char * argv[]) {
    // ...
    NSUInteger threadCount = [NSProcessInfo processInfo].activeProcessorCount;
    NSCondition *cond = [NSCondition new];
    for (int i = 0; i < threadCount; i++) {
        [NSThread detachNewThreadWithBlock:^{
            while (YES) {
                [cond lock];
                while (/* Queue is empty */) {
                    [cond wait];
                }
                // Dequeue an item.
                [cond unlock];
                // Handle the item.
            }
        }];
    }

    while (YES) {
        // Enqueue something when it comes.
        [cond broadcast];
    }
    
    // ...
}
```

::: details ğŸ’¡

è¿™æ®µä»£ç ä¸­åˆ›å»ºäº†ä¸€äº›çº¿ç¨‹ï¼Œå®ƒä»¬æŒç»­åœ°ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼ˆ`NSCondition`ï¼‰å¹¶åœ¨æ¥æ”¶åˆ°ä¿¡å·åä»é˜Ÿåˆ—ä¸­å–å‡ºé¡¹è¿›è¡Œå¤„ç†ã€‚åŒæ—¶åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œä¼šåœ¨æ–°çš„é¡¹åŠ å…¥é˜Ÿåˆ—åå‘é€å¹¿æ’­æ¥å”¤é†’è¿™äº›çº¿ç¨‹ã€‚

  - é—®é¢˜ä¸€ï¼šçº¿ç¨‹è¿‡å¤šã€‚

    è™½ç„¶è¿™é‡Œä½¿ç”¨äº†ç­‰äº `CPU` æ ¸å¿ƒæ•°çš„çº¿ç¨‹æ•°ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­å¹¶ä¸æ¨èåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ã€‚çº¿ç¨‹çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢å­˜åœ¨ä¸€å®šçš„å¼€é”€ï¼Œè¿‡å¤šçš„çº¿ç¨‹å¯èƒ½å¯¼è‡´è¿™äº›å¼€é”€å¢å¤§ï¼Œè€Œä¸”çº¿ç¨‹è¿‡å¤šå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ã€‚

    å¦‚æœå¯èƒ½çš„è¯ï¼Œé€šå¸¸æ›´å¤šåœ°ä½¿ç”¨ä»»åŠ¡é˜Ÿåˆ—å’Œçº¿ç¨‹æ± æ¥å®ç°å¹¶å‘æ§åˆ¶ï¼Œåˆ©ç”¨æœ‰é™çš„çº¿ç¨‹å¤„ç†æ›´å¤šçš„ä»»åŠ¡ã€‚å¯ä»¥ä½¿ç”¨ `NSOperationQueue` æˆ– Grand Central Dispatch (`GCD`) æ¥ä»£æ›¿ç›´æ¥åˆ›å»ºçº¿ç¨‹ã€‚è¿™ä¸¤è€…éƒ½æä¾›äº†çº¿ç¨‹æ± çš„æœºåˆ¶ï¼Œèƒ½æœ‰æ•ˆåœ°å¤ç”¨çº¿ç¨‹ã€‚

  - é—®é¢˜äºŒï¼šå¯èƒ½å­˜åœ¨çš„æ­»é”ã€‚

    åœ¨è¿™æ®µä»£ç ä¸­ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶å˜é‡çš„è¿‡ç¨‹ä¸­ä¸€ç›´æŒæœ‰é”ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´ä¸»çº¿ç¨‹è¯•å›¾æ·»åŠ æ–°çš„é¡¹åˆ°é˜Ÿåˆ—ä¸­å¹¶å‘é€å¹¿æ’­ï¼Œå¯èƒ½éœ€è¦è·å–åŒæ ·çš„é”ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´æ­»é”ã€‚åœ¨æ·»åŠ æ–°çš„é¡¹åˆ°é˜Ÿåˆ—ä¸­ä»¥åŠåœ¨ä»é˜Ÿåˆ—ä¸­å–å‡ºé¡¹æ—¶ï¼Œéƒ½åº”è¯¥åœ¨äº’æ–¥é”çš„ä¿æŠ¤ä¹‹ä¸‹ã€‚

  - é—®é¢˜ä¸‰ï¼šçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ã€‚

    ä¼šä¸€ç›´åœ¨åå°åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹ï¼Œè€Œä¸”æ²¡æœ‰æä¾›é€€å‡ºæœºåˆ¶ã€‚è¿™å¯èƒ½ä¼šåœ¨åº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å ç”¨å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚ä½ åº”è¯¥æä¾›ä¸€ç§æœºåˆ¶æ¥åœ¨é€‚å½“çš„æ—¶å€™ç»ˆæ­¢è¿™äº›çº¿ç¨‹ã€‚

æ€»ç»“ï¼šå¯ä»¥è€ƒè™‘ä½¿ç”¨ `NSOperationQueue` æˆ– `GCD` æ¥æ›¿ä»£ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶æœ‰æ•ˆç®¡ç†é”å’Œæ¡ä»¶å˜é‡ä»¥é¿å…æ­»é”ï¼ŒåŒæ—¶æä¾›ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚

:::

------

## ä»£ç åˆ†æ

### â“ä¸‹é¢ä»£ç æ‰§è¡Œç»“æœ

```objc
NSLog(@"1");
dispatch_sync(dispatch_get_main_queue(), ^{
    NSLog(@"2");
});
NSLog(@"3");
```

::: details ğŸ’¡

  - å¦‚æœè¿™æ®µä»£ç åœ¨**ä¸»çº¿ç¨‹**ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šå¯¼è‡´æ­»é”ã€‚
    > å› ä¸º `dispatch_sync` å‡½æ•°æ˜¯ä¸€ä¸ªåŒæ­¥æ‰§è¡Œçš„å‡½æ•°ï¼Œå®ƒä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶ç­‰å¾… `dispatch_sync` å†…éƒ¨çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåå†ç»§ç»­æ‰§è¡Œã€‚ç„¶è€Œæ­¤å¤„çš„ `dispatch_sync` å†…éƒ¨ä»»åŠ¡è¢«æ´¾å‘åˆ°äº†ä¸»é˜Ÿåˆ—ï¼Œæ‰€ä»¥è¿™ä¸ªä»»åŠ¡éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ä½†æ˜¯ä¸»çº¿ç¨‹æ­¤æ—¶è¢«ä¸Šè¿°çš„ `dispatch_sync` é˜»å¡äº†ï¼Œæ‰€ä»¥ `dispatch_sync` å†…éƒ¨çš„ä»»åŠ¡æ— æ³•æ‰§è¡Œã€‚è¿™å°±é€ æˆäº†æ­»é”ï¼Œä¸Šè¿°ä»£ç ä¼šåœ¨è¾“å‡º "1" ååœæ­¢ã€‚

  - å¦‚æœè¿™æ®µä»£ç åœ¨ä¸€ä¸ª**éä¸»çº¿ç¨‹**æ‰§è¡Œï¼Œé‚£ä¹ˆå®ƒä¼šå…ˆé˜»å¡è¯¥çº¿ç¨‹ï¼Œå†åœ¨ä¸»çº¿ç¨‹ä¸ŠåŒæ­¥æ‰§è¡Œä»»åŠ¡ï¼Œè¾“å‡º "2"ï¼Œç„¶åå–æ¶ˆé˜»å¡ï¼Œæ¥ç€è¾“å‡º "3"ï¼Œæ‰€ä»¥ç»“æœæ˜¯ "1"ï¼Œ"2"ï¼Œ"3"ã€‚

:::

> â“æ”¹ä¸º `global queue` å‘¢

```objc
NSLog(@"1");
dispatch_sync(dispatch_get_global_queue(), ^{
    NSLog(@"2");
});
NSLog(@"3");
```

::: details ğŸ’¡

è¿™æ®µä»£ç æ— è®ºåœ¨ä¸»çº¿ç¨‹è¿˜æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæœ€ç»ˆçš„è¾“å‡ºç»“æœéƒ½æ˜¯ "1", "2", "3"ã€‚

  é¦–å…ˆè¾“å‡º "1"ï¼Œç„¶å `dispatch_sync` ä¼šå°† `block` ä¸­çš„ä»»åŠ¡åŒæ­¥åœ°æ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ° `block` ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ç”±äºè¿™é‡Œä½¿ç”¨çš„æ˜¯å…¨å±€é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œä¸”å’Œå½“å‰çº¿ç¨‹ï¼ˆæ— è®ºä¸»çº¿ç¨‹æˆ–å­çº¿ç¨‹ï¼‰ä¸æ˜¯åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”ã€‚`block` ä¸­çš„ä»»åŠ¡æ‰§è¡Œåï¼Œè¾“å‡º "2"ï¼Œç„¶å `dispatch_sync` è¿”å›ï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œè¾“å‡º "3"ã€‚æ‰€ä»¥æœ€ç»ˆçš„è¾“å‡ºç»“æœå°±æ˜¯ "1", "2", "3"ã€‚

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```objc
dispatch_queue_t queue = dispatch_get_main_queue();
BOOL isEqual = [queue isKindOfClass:[NSObject class]];
NSLog(@"isEqual=%d", isEqual);
```

::: details ğŸ’¡

è¾“å‡ºç»“æœæ˜¯ `isEqual=1`ã€‚

  è™½ç„¶ `Objective-C `çš„ `GCD` é˜Ÿåˆ—æ˜¯åŸºäº `C` è¯­è¨€çš„ `dispatch_queue_t` ç±»å‹å®ç°çš„ï¼Œä½†å®ƒä»ç„¶æ˜¯ `NSObject` çš„å­ç±»ã€‚å°½ç®¡ `GCD` çš„ `API` éƒ½æ˜¯ç”¨çº¯ `C` æ¥å®ç°çš„ï¼Œä½†å®é™…ä¸Š `GCD` å¯¹è±¡åœ¨ `Objective-C` çš„è¿è¡Œæ—¶ç¯å¢ƒä¸­æ˜¯è¢«å½“ä½œ `Objective-C` å¯¹è±¡æ¥å¤„ç†çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„ `queue` æ˜¯å¯ä»¥è¢«å½“ä½œ `NSObject` çš„å®ä¾‹æ¥å¤„ç†çš„ï¼Œæ‰€ä»¥ `[queue isKindOfClass:[NSObject class]]` çš„ç»“æœæ˜¯ `YES`ï¼Œå³ `isEqual=1`ã€‚

  ç„¶è€Œï¼Œä¸èƒ½ç›´æ¥å¯¹ `dispatch_queue_t` ç±»å‹çš„å¯¹è±¡å‘é€ `Objective-C` æ¶ˆæ¯ï¼Œä¾‹å¦‚ `respondsToSelector:`ã€`performSelector:` ç­‰ï¼Œè¿™æ ·åšå¯èƒ½ä¼šå¼•å‘å¼‚å¸¸æˆ–è€…å´©æºƒã€‚å› ä¸º `dispatch_queue_t` ä»¥åŠå…¶ä»–çš„ `GCD` å¯¹è±¡ç±»å‹å¹¶æ²¡æœ‰å®ç°è¿™äº›æ–¹æ³•ã€‚

:::

### â“ä¸‹é¢ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆ

```objc
@property (nonatomic, strong) NSString *target;
//....

dispatch_queue_t queue = dispatch_queue_create("parallel", DISPATCH_QUEUE_CONCURRENT);
for (int i = 0; i < 1000000 ; i++) {
	dispatch_async(queue, ^{
     	self.target = [NSString stringWithFormat:@"ksddkjalkjd%d",i];
	});
}
```

::: details ğŸ’¡

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```swift
func test1() {
    DispatchQueue.main.sync {
        print("1")
    }
}
test1()
```

::: details ğŸ’¡

:::

### â“ä¸‹é¢ä»£ç è¾“å‡ºç»“æœ

```swift
func test2() {
    print("1")
    let queue = DispatchQueue.init(label: "thread")
    queue.async {
        print("2")
        DispatchQueue.main.sync {
            print("3")
            queue.sync {
                print("4")
            }
        }
        print("5")
    }
    print("6")
    queue.async {
        print("7")
    }
    print("8")
}
```

::: details ğŸ’¡

:::


