---
title: å¤šçº¿ç¨‹
icon: hashtag

index: true
order: 7

---

<!-- more -->

## çº¿ç¨‹å®‰å…¨

### `UIKit` æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

### â“`atomic` çº¿ç¨‹å®‰å…¨å—ï¼Ÿ

::: details ğŸ’¡

  `atomic` å±æ€§åªä¿è¯å±æ€§ setter å’Œ getter çš„åŸå­æ“ä½œï¼Œä»¥é˜²æ­¢æ•°æ®è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥æˆ–è€…åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»å–ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸èƒ½å®Œå…¨ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

  > å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ Bï¼Œå®ƒä»¬éƒ½å°è¯•æ›´æ–°åŒä¸€ä¸ªæ•°å€¼ã€‚çº¿ç¨‹ A è¯»å–è¯¥æ•°å€¼ï¼Œç„¶ååœ¨ A æ‰§è¡Œå†™å…¥æ“ä½œä¹‹å‰ï¼Œçº¿ç¨‹ B ä¹Ÿè¯»å–äº†è¯¥æ•°å€¼ï¼Œå¹¶ä¸”å†™å›äº†ä¸€ä¸ªæ–°çš„å€¼ã€‚ç„¶åçº¿ç¨‹ A ç»§ç»­å®ƒçš„å†™å…¥æ“ä½œï¼Œè¿™æ ·å°±è¦†ç›–äº†çº¿ç¨‹ B çš„æ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„"ç«æ€æ¡ä»¶"ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`atomic`å±æ€§å¹¶ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

  è™½ç„¶ `atomic` å±æ€§å¯ä»¥ä¿è¯å•ç‹¬çš„ getter æˆ– setter æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å®ƒä¸èƒ½ä¿è¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼ˆä¾‹å¦‚å…ˆè¯»å–ï¼Œç„¶åæ ¹æ®è¯»å–çš„å€¼åšè®¡ç®—ï¼Œç„¶åå†™å›æ–°çš„å€¼ï¼‰æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“çš„çº¿ç¨‹å®‰å…¨ã€‚

  å¦‚æœéœ€è¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œåº”ä½¿ç”¨ `mutex`ï¼ˆäº’æ–¥é”ï¼‰æˆ–è€…å…¶å®ƒçš„çº¿ç¨‹åŒæ­¥æŠ€æœ¯ã€‚å¯ä»¥ä½¿ç”¨ `DispatchQueue`ã€`NSLock`ã€`NSOperationQueue` æˆ–è€…ç”¨ `GCD`ï¼ˆ`Grand Central Dispatch`ï¼‰ç­‰æ–¹å¼æ¥å¤„ç†çº¿ç¨‹åŒæ­¥ã€‚

:::

### â“å¦‚æœè®©ä½ æ¥å®ç°å±æ€§çš„ `atomic`ï¼Œå¦‚ä½•å®ç°ï¼Ÿ

::: details ğŸ’¡

  å¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼Œå¯¹è¯»å†™æ“ä½œè¿›è¡Œä¿æŠ¤ï¼Œæ¥é˜²æ­¢ä¸åŒçº¿ç¨‹ä¸­çš„è¯»å†™æ“ä½œç›¸äº’å¹²æ‰°ã€‚

  ```swift
  public class Atomic<T> {
    // å®šä¹‰ `DispatchQueue` æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥è¿™ä¸ªæ“ä½œæ˜¯äº’æ–¥çš„
    private let queue = DispatchQueue(label: "queue.atomic.lock")
    private var value: T
    public init(_ value: T) {
        self.value = value
    }
    // get set ä¸­è¿›è¡ŒåŠ é”ä¿æŠ¤
    public var atomicValue: T {
        set {
            queue.sync {
                value = newValue
            }
        }
        get {
            return queue.sync {
                value
            }
        }
    }
  }
  ```

:::

### â“`NSMutableArray` çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Ÿ

::: details ğŸ’¡
  
  > çº¿ç¨‹å®‰å…¨ï¼šæ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å½“æ•°æ®å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨åœ°å¹¶è¡Œå­˜å–æ—¶ï¼Œè¯¥æ•°æ®å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚åä¹‹ï¼Œå¦‚æœæ•°æ®çš„ä¸€è‡´æ€§ä¸å¯é¢„æµ‹æˆ–è€…å‘ç”Ÿé”™è¯¯ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

  `NSMutableArray` æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚å†…éƒ¨å°è£…äº†ä¸€ä¸ªåŠ¨æ€æ‰©å®¹çš„æ•°ç»„ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ç»„æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹æ•°ç»„å…ƒç´ çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•åœ¨åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚

    ç¤ºä¾‹ï¼š
    
    çº¿ç¨‹A è°ƒç”¨äº† addObjectï¼šæ–¹æ³•ï¼Œè¯•å›¾å‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚
    åŒæ—¶ï¼Œçº¿ç¨‹Bä¹Ÿè°ƒç”¨äº†addObjectï¼šæ–¹æ³•ï¼Œè¯•å›¾å‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚

    åœºæ™¯ä¸€ï¼š
    ä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ˜¯äº¤æ›¿è¿›è¡Œçš„ï¼Œé‚£ä¹ˆå°±å¯èƒ½å‡ºç° çº¿ç¨‹A å…ˆå°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œç„¶åæ•°ç»„æ‰©å®¹ã€‚
    çº¿ç¨‹B ä¹Ÿå°†å…ƒç´ æ·»åŠ åˆ°åŒä¸€ä½ç½®ï¼Œç„¶åå†æ¬¡è§¦å‘æ•°ç»„çš„æ‰©å®¹ã€‚
    ç»“æœå°±ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºä¸¤ä¸ªå…ƒç´ è¢«æ·»åŠ åˆ°äº†åŒä¸€ä¸ªä½ç½®ã€‚

    åœºæ™¯äºŒï¼š
    çº¿ç¨‹A åœ¨æ·»åŠ å…ƒç´ çš„åŒæ—¶ï¼Œçº¿ç¨‹B å¯èƒ½åœ¨åˆ é™¤å…ƒç´ ã€‚
    å¦‚æœ çº¿ç¨‹A å·²ç»å®Œæˆäº†æ·»åŠ å…ƒç´ ï¼Œè¿™æ—¶ çº¿ç¨‹B åˆ é™¤äº†åˆšåˆšå·²ç»æ·»åŠ çš„å…ƒç´ ï¼Œè¿™æ ·ä¹Ÿä¼šå¼•å‘æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚
    
:::

### `sqlite` ä¸­çš„è¯»å†™æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ

### â“`OC` ä¸­çš„é”æœ‰å“ªäº›ï¼Ÿ
    
::: details ğŸ’¡

  `OC`ä¸­æœ‰å¤šç§æ–¹å¼æ¥å®ç°çº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯"é”"çš„æ¦‚å¿µã€‚

  - `NSLock`ï¼šæœ€åŸºæœ¬çš„é”ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç›´è§‚å’Œç®€å•ã€‚åªéœ€è¦åœ¨æ“ä½œå‰åŠ é”ï¼Œæ“ä½œåè§£é”å³å¯ã€‚

    ```objc
    NSLock *lock = [[NSLock alloc] init];
    [lock lock];
    // Access shared resource here.
    [lock unlock];
    ```

  - `@synchronized`ï¼šçº¿ç¨‹åŒæ­¥å…³é”®å­—ï¼Œç”¨äºè‡ªåŠ¨åŠ é”å’Œè§£é”ã€‚æ”¾åœ¨éœ€è¦ä¿æŠ¤çº¿ç¨‹å®‰å…¨çš„ä»£ç å‰é¢å³å¯ã€‚

    ```objc
    @synchronized (self) {
        // Access shared resource here.
    }
    ```

  - `NSCondition`ï¼šæ¡ä»¶é”ï¼Œå½“æŸæ¡ä»¶æ»¡è¶³æ—¶åŠ é”ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚

    ```objc
    NSCondition *condition = [[NSCondition alloc] init];
    [condition lock];
    while (/* å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ */) {
        [condition wait];
    }
    // Access shared resource here.
    [condition unlock];
    ```

  - `NSRecursiveLock`ï¼šé€’å½’é”ï¼Œå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œä¸ä¼šé€ æˆæ­»é”ã€‚
    
    ```objc
    NSRecursiveLock *rLock = [[NSRecursiveLock alloc] init];
    [rLock lock];
    // Access shared resource here.
    [rLock unlock];
    ```

  - `dispatch_semaphore_t`ï¼šä¿¡å·é‡ï¼Œæ˜¯ `GCD` ä¸­çš„ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡æ§åˆ¶ä¿¡å·é‡çš„æ•°é‡æ¥è¿›è¡Œçº¿ç¨‹çš„å¹¶å‘æ§åˆ¶ã€‚

    ```objc
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
    // Access shared resource here.
    dispatch_semaphore_signal(semaphore);
    ```

  - `Mutex`ï¼šäº’æ–¥é”
  
    ```objc
    pthread_mutex_t mutex;
    pthread_mutex_init(&mutex, NULL);
    pthread_mutex_lock(&mutex);
    // Access shared resource here.
    pthread_mutex_unlock(&mutex);
    ```
  
  - `OSSpinLock`ï¼šè‡ªæ—‹é”ï¼Œå¦‚æœç”±äºç«äº‰èµ„æºä¸å¯ç”¨è€Œæ— æ³•ç«‹å³è·å¾—é”ï¼Œå®ƒä¼šä¸€ç›´åœ¨ç”¨æˆ·æ€è‡ªæ—‹ï¼ˆå¿™ç­‰ï¼‰ï¼Œç›´åˆ°é”å˜ä¸ºå¯ç”¨ä¸ºæ­¢ã€‚ç”±äºå®ƒåœ¨ç”¨æˆ·æ€å°±å¯ä»¥è‡ªæ—‹ï¼Œä¸ç”¨åƒå…¶ä»–é”é‚£æ ·è¿›å…¥å†…æ ¸æ€è¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼Œæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ã€‚ä½†æ˜¯è‡ªæ—‹é”ç”±äºæ°¸ä¸é˜»å¡ï¼Œä¸€ç›´å ç”¨ CPUï¼Œæ‰€ä»¥åœ¨èµ„æºç«äº‰ä¸¥é‡çš„æƒ…å†µä¸‹æ•ˆç‡ä¼šå¾ˆä½ã€‚æ³¨æ„ï¼Œ`OSSpinLock` åœ¨ `iOS10.0` åå·²ç»ä¸å†å®‰å…¨ï¼Œæ¨èä½¿ç”¨ `os_unfair_lock`ã€‚
   
    ```objc
    pthread_spinlock_t spinlock;
    pthread_spin_init(&spinlock, 0);
    pthread_spin_lock(&spinlock);
    // Access shared resource here.
    pthread_spin_unlock(&spinlock);
    ```
    
:::
    
### â“`swift` ä¸­çš„é”æœ‰å“ªäº›ï¼Ÿ

::: details ğŸ’¡


  - `Dispatch Semaphore` ä¿¡å·é‡ï¼šå½“ä¿¡å·é‡çš„å€¼ `<=0` æ—¶ï¼Œä¼šé˜»å¡çº¿ç¨‹, `>0` æ—¶, ä¼šä½¿ä¿¡å·é‡çš„å€¼å‡1ï¼Œç„¶åæ‰§è¡Œåç»­çš„ä»£ç ã€‚

    ```swift
    let semaphore = DispatchSemaphore(value: 1)
    semaphore.wait()
    // Do something
    semaphore.signal()
    ```

  - `NSLock`: å®ƒæ˜¯å¯¹ `mutex` çš„ä¸€æ¬¡ç®€å•çš„å°è£…ï¼Œæ›´åŠ é¢å‘å¯¹è±¡ï¼Œç”¨èµ·æ¥æ›´åŠ ç®€å•ã€‚

    ```swift
    let lock = NSLock()
    lock.lock()
    // Do something
    lock.unlock()
    ```

  - `NSRecursiveLock`ï¼šå…è®¸åŒä¸€çº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œè€Œä¸ä¼šå¼•èµ·æ­»é”ã€‚é€’å½’é”ä¼šè·Ÿè¸ªè§£é”å’ŒåŠ é”çš„æ•°ç›®ï¼Œåªæœ‰è¿™ä¸¤ä¸ªæ•°ç›®ç›¸åŒæ—¶ï¼Œé”æ‰ä¼šè¢«çœŸæ­£é‡Šæ”¾æ‰ã€‚

    ```swift
    let recursiveLock = NSRecursiveLock()
    recursiveLock.lock()
    // Do something
    recursiveLock.unlock()
    ```

  - `Mutex` (PTHREAD_MUTEX_NORMAL)ï¼šå¯ä»¥å®ç°é”çš„å¿«é€Ÿæ£€æŸ¥ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡å·²ç»ä¸Šé”ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç«‹åˆ»è¿”å›ï¼Œçº¿ç¨‹ä¸ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ã€‚

    ```swift
    var mutex = pthread_mutex_t()
    pthread_mutex_lock(&mutex)
    // Do something
    pthread_mutex_unlock(&mutex)
    
    ```

  - `Spin Lock`ï¼šå¿™ç­‰é”ï¼Œä¼šä¸€ç›´å ç”¨ `CPU` çš„èµ„æºï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ã€‚è‡ªæ—‹é”åªåº”ä½¿ç”¨åœ¨ä¿è¯çº¿ç¨‹ä¸ä¼šè¢«å¤§é‡é˜»å¡çš„åœºæ™¯ï¼Œæ¯”å¦‚å†…æ ¸çš„æ•°æ®ç»“æ„æˆ–è€…å®æ—¶çº¿ç¨‹ç¼–ç¨‹ã€‚

    ```swift
    var unfairLock = os_unfair_lock_s()
    os_unfair_lock_lock(&unfairLock)
    // Do something
    os_unfair_lock_unlock(&unfairLock)
    ```

  ä¸Šè¿°äº”ç§é”ä¸­ï¼Œ
  `Dispatch Semaphore` ä¿¡å·é‡ã€`NSLock`ã€`NSRecursiveLock`éƒ½æ˜¯é€šè¿‡ `Foundation` æ¡†æ¶æä¾›çš„ API æ¥å®ç°çš„ï¼›
  `Mutex` é”æ˜¯é€šè¿‡ `pthread` åº“ä¸­çš„ `mutex` æä¾›çš„ï¼›
  `SpinLock` æ˜¯é€šè¿‡ `os` åº“ä¸­çš„ `os_unfair_lock` æ¥å®ç°çš„ã€‚

  åœ¨å®é™…å¼€å‘ä¸­ï¼Œä½¿ç”¨å“ªç§é”å–å†³äºä½ çš„éœ€æ±‚ï¼š
  
  - å¦‚æœéœ€è¦æŠ¢å å¼çš„é”ï¼Œå¹¶ä¸”ä¸èƒ½å®¹å¿çº¿ç¨‹å†»ç»“ï¼Œ`NSLock`å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚
  - å¯¹äºéœ€è¦å¿«é€Ÿæ£€æŸ¥çš„æƒ…å†µï¼Œ`mutex` å¯èƒ½ä¼šæ›´åˆé€‚ã€‚
  - å¦‚æœåªæ˜¯éœ€è¦ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ¥ä¿æŠ¤ä¸€æ®µä»£ç ï¼Œç„¶å`Dispatch Semaphore`ä¹Ÿè®¸å°±å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚

:::
    
### â“è‡ªæ—‹é”å’Œäº’æ–¥é”å¯¹æ¯”ï¼Ÿ

::: details ğŸ’¡

  ä¸¤è€…åŒºåˆ«åœ¨äºå½“é”æ— æ³•è·å–çš„æ—¶å€™ï¼Œå®ƒä»¬å¤„ç†æ–¹å¼çš„ä¸åŒã€‚

  - è‡ªæ—‹é”ï¼ˆ`SpinLock`ï¼‰ï¼š
    
    å½“ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–ä¸€ä¸ªå·²ç»è¢«å ç”¨çš„è‡ªæ—‹é”æ—¶ï¼Œå®ƒä¼šæŒç»­åœ°æŸ¥è¯¢ï¼ˆ`spin`ï¼Œæ•…å`è‡ªæ—‹é”`ï¼‰é”çš„çŠ¶æ€ä»¥å°è¯•è·å–é”çš„æ‰€æœ‰æƒã€‚æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹ä¼šåœ¨ç”¨æˆ·æ€å¿™ç­‰ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚å› æ­¤ï¼Œè‡ªæ—‹é”æ˜¯éé˜»å¡çš„ã€‚
    
    è¿™ç§æ–¹å¼å¯¹ `CPU` æ˜¯æå…¶æ¶ˆè€—èµ„æºçš„ï¼Œä½†æ˜¯å½“é”æŒæœ‰çš„æ—¶é—´éå¸¸çŸ­æ—¶ï¼ˆä¾‹å¦‚ï¼Œåªæ˜¯ç®€å•åœ°è¯»å–æˆ–ä¿®æ”¹ä¸€å°å—æ•°æ®ï¼‰ï¼Œè‡ªæ—‹é”ä¼šæ¯”äº’æ–¥é”æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºçº¿ç¨‹æ— éœ€åœ¨äº’æ–¥é”çš„æ’é˜Ÿã€é˜»å¡å’Œå”¤é†’ç­‰æ“ä½œä¸­èŠ±è´¹æ—¶é—´ã€‚

  - äº’æ–¥é”ï¼ˆ`Mutex`ï¼‰ï¼š

    äº’æ–¥é”å’Œè‡ªæ—‹é”çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå·²ç»è¢«å ç”¨çš„äº’æ–¥é”æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šè¢«é˜»å¡å¹¶è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œæœ¬çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’å¹¶è·å¾—é”æ¥ç»§ç»­æ‰§è¡Œã€‚

    è¿™æ ·æ˜¾ç„¶ä¼šæ¯”è‡ªæ—‹é”åœ¨æ— æ³•è·å¾—é”æ—¶æ›´èŠ‚çœ `CPU` èµ„æºï¼Œä¸è¿‡è·å–é”ä¸é‡Šæ”¾é”æ¶‰åŠåˆ°çš„çº¿ç¨‹åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´ä¹Ÿæ˜¯æœ‰ä¸€å®šå¼€é”€çš„ã€‚ç„¶è€Œï¼Œå¯¹äºæ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„ä»£ç å—ï¼ˆä¾‹å¦‚IOä»»åŠ¡ç­‰ï¼‰ï¼Œä½¿ç”¨äº’æ–¥é”é€šå¸¸ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

  é€‚ç”¨åœºæ™¯ï¼š
    
  - è‡ªæ—‹é”é€‚ç”¨äºé”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¾ˆå°ä¸”ç¡®å®šæ—¶é—´çŸ­çš„æƒ…å†µã€‚
  - äº’æ–¥é”æ›´åˆé€‚è€—æ—¶é•¿çš„æ“ä½œåŠ é”ï¼Œå¦‚æœä¸´ç•ŒåŒºåŒ…å«IOã€è€—æ—¶æ“ä½œæˆ–è€…åŒ…å«å…¶ä»–å½¢å¼çš„é”çš„è¯ï¼Œä½¿ç”¨è‡ªæ—‹é”åè€Œä¼šå› ä¸ºâ€œå¿™ç­‰â€æµªè´¹è¿‡å¤šCPUæ—¶é—´ã€‚

:::

  > ç”¨ `C/C++/OC` å®ç°è‡ªæ—‹é”æˆ–äº’æ–¥é”ï¼Ÿ

::: details ğŸ’¡

  å®ç°äº’æ–¥é”ï¼Œå¯ä»¥ä½¿ç”¨åŸå­æ“ä½œæˆ–å†…å­˜å±éšœæ¥è¾¾æˆç›®çš„ã€‚
  ä½¿ç”¨ `C++11` å®ç°çš„è‡ªæ—‹é”çš„ç®€å•ç‰ˆæœ¬ï¼š

  ```cpp
  #include <atomic>
    
  class SpinLock {
    // std::atomic_flag : C++ ä¸­çš„åŸå­å¸ƒå°”å‹æ ‡å¿—
    std::atomic_flag locked = ATOMIC_FLAG_INIT ;
  public:
    // std::memory_order_acquire & std::memory_order_release
    // å†…å­˜åºï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ­£ç¡®æ€§ã€‚
    void lock() {
        while (locked.test_and_set(std::memory_order_acquire)) { ; }
    }
    void unlock() {
        locked.clear(std::memory_order_release);
    }
  };
  ```

:::


### ä¸ºä»€ä¹ˆåªæœ‰ä¸»çº¿ç¨‹çš„ `runloop` æ˜¯å¼€å¯çš„?

### ä¸ºä»€ä¹ˆåªåœ¨ä¸»çº¿ç¨‹åˆ·æ–° `UI`?

------

## GCD

  > `GCD (Grand Central Dispatch)` æ˜¯ Apple å¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒä¸»è¦æ˜¯é€šè¿‡å‘æŒ‡å®šçš„é˜Ÿåˆ—ï¼ˆ`Dispatch Queue`ï¼‰ä¸­æ·»åŠ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä»»åŠ¡ = å·¥ä½œé¡¹ = ä»£ç å—ï¼‰æ¥è¿›è¡Œå·¥ä½œçš„ã€‚`GCD` çš„ç›®æ ‡æ˜¯ä¸ºäº†æœ€å¤§åŒ–åˆ©ç”¨å¤„ç†å™¨çš„å¤šæ ¸ï¼ŒåŒæ—¶æœ€å°åŒ–çº¿ç¨‹åˆ›å»ºå’Œç®¡ç†çš„å¼€é”€ã€‚

### â“`GCD` æ‰§è¡ŒåŸç†ï¼Ÿ

::: details ğŸ’¡

  - ä»»åŠ¡ï¼šæ‰§è¡Œæ“ä½œçš„æœ€å°å•å…ƒï¼Œåªèƒ½æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°ï¼Œä¸èƒ½ç›´æ¥è®¿é—®å±æ€§æˆ–æ–¹æ³•ã€‚
  - é˜Ÿåˆ—ï¼ˆ`Dispatch Queue`ï¼‰ï¼šç”¨äºå­˜æ”¾ä»»åŠ¡çš„å…ˆè¿›å…ˆå‡ºï¼ˆ`FIFO`ï¼‰ç±»å‹çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚

  `GCD` ä¸ºæ¯ä¸ªå¤„ç†å™¨çš„æ ¸å¿ƒåœ¨ç³»ç»Ÿå†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå½“å‘ `DispatchQueue` æ·»åŠ ä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ä»»åŠ¡åˆ†å‘åˆ°è¿™äº›çº¿ç¨‹ä¸­è¿è¡Œï¼Œä»¥å®ç°ä»»åŠ¡çš„å¹¶å‘æ‰§è¡Œã€‚

  `DispatchQueue` å­˜åœ¨ä¸¤ç§ç±»å‹ï¼š`Serial Dispatch Queue`ï¼ˆä¸²è¡Œé˜Ÿåˆ—ï¼‰å’Œ `Concurrent Dispatch Queue`ï¼ˆå¹¶è¡Œé˜Ÿåˆ—ï¼‰ã€‚æ¯ä¸ªä»»åŠ¡æ·»åŠ åˆ°ä¸²è¡Œé˜Ÿåˆ—ä¸­ä¼šæŒ‰ç…§æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œè€Œæ·»åŠ åˆ°å¹¶è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åˆ™ä¼šè¢«è°ƒåº¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å¹¶å‘æ‰§è¡Œã€‚

  `GCD` ä¸»è¦æœ‰å››ä¸ªç‰¹ç‚¹ï¼š

  - å¯ç”¨äºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—
  - è‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„ `CPU` å†…æ ¸
  - è‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆçº¿ç¨‹çš„åˆ›å»ºï¼Œè°ƒåº¦å’Œé”€æ¯ï¼‰
  - å…·æœ‰çº¿ç¨‹åŒæ­¥çš„åŠŸèƒ½

:::

### `GCD` ä¸»çº¿ç¨‹ & ä¸»é˜Ÿåˆ—çš„å…³ç³»?

### å¦‚ä½•ç”¨ `GCD` åŒæ­¥è‹¥å¹²ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Ÿ

### `dispatch_barrier_async` çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

### `GCD` çš„é˜Ÿåˆ—ï¼ˆ`dispatch_queue_t`ï¼‰åˆ†å“ªä¸¤ç§ç±»å‹ï¼Ÿé»˜è®¤æä¾›å“ªäº›é˜Ÿåˆ—?

### è‹¹æœä¸ºä»€ä¹ˆè¦åºŸå¼ƒ `dispatch_get_current_queue`ï¼Ÿ

### `dispatch_once` å®ç°åŸç†ï¼Ÿ

### æœ‰å“ªäº›åœºæ™¯æ˜¯ `NSOperation` æ¯” `GCD` æ›´å®¹æ˜“å®ç°çš„ï¼Ÿ

### `GCD` èƒŒåçš„çº¿ç¨‹æ¨¡å‹æ˜¯ä»€ä¹ˆï¼Ÿ

### ä¸‹é¢ä»£ç æ‰§è¡Œç»“æœï¼Ÿ

```objc
- (void)viewDidLoad
{
    [super viewDidLoad];
    NSLog(@"1");
    dispatch_sync(dispatch_get_main_queue(), ^{
        NSLog(@"2");
    });
    NSLog(@"3");
}
```

## çº¿ç¨‹è®¾è®¡

### `iOS` ä¸­çš„å¸¸ç”¨çº¿ç¨‹ç›¸å…³ç±»å‹æœ‰å“ªäº›ï¼Ÿ

### `NSOperationQueue` ä¸­çš„ `maxConcurrentOperationCount` é»˜è®¤å€¼ï¼Ÿ

### â“`iOS` ä¸­çº¿ç¨‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ

### â“`iOS` ä¸­å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Ÿ

::: details ğŸ’¡

  åˆ›å»ºä¸€ä¸ªå¸¸é©»çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªçº¿ç¨‹å¹¶ä¸ä¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œåå°±ç«‹å³é€€å‡ºï¼Œè€Œæ˜¯èƒ½å¤Ÿç­‰å¾…æ–°çš„ä»»åŠ¡çš„åŠ å…¥å¹¶æ‰§è¡Œã€‚è¿™åœ¨å¤„ç†ä¸€äº›æŒä¹…çš„ã€å‘¨æœŸæ€§çš„æˆ–è€…éœ€è¦åœ¨ç‰¹å®šçº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»»åŠ¡éå¸¸æœ‰ç”¨ã€‚

  æ ¸å¿ƒç‚¹åœ¨äºåˆ›å»ºçº¿ç¨‹æ—¶ï¼Œå¯åŠ¨ `RunLoop`ï¼Œä½†æ˜¯ `RunLoop` å¦‚æœåœ¨æ²¡æœ‰ä»»ä½•äº‹ä»¶æºæ—¶ä¼šé€€å‡ºï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ ä¸€ä¸ª port äº‹ä»¶è®© `RunLoop` ä¸€ç›´è¿è¡Œã€‚

  ä¸‹é¢æ˜¯ä¸€ä¸ª `Swift` ç‰ˆæœ¬çš„å¸¸é©»çº¿ç¨‹

  ```swift
  /// å®ˆæŠ¤çº¿ç¨‹
  class DaemonThread: NSObject {
    // åˆ›å»ºçš„å®ˆæŠ¤çº¿ç¨‹ï¼Œå¹¶å¼€å¯ä¸€ä¸ªRunloop
    private lazy var thread = Thread {
        // æ·»åŠ äº†ä¸€ä¸ª port äº‹ä»¶æºåˆ° RunLoop ä¸­é˜²æ­¢å®ƒå› ä¸ºæ²¡æœ‰äº‹ä»¶æºç«‹å³é€€å‡º
        RunLoop.current.add(Port(), forMode: .default)
        // å¯åŠ¨ RunLoop
        RunLoop.current.run()
    }
    
    override init() {
        super.init()
        // å¯åŠ¨çº¿ç¨‹
        thread.start()
    }
    /// åœ¨å®ˆæŠ¤è¿›ç¨‹æ‰§è¡Œä»»åŠ¡
    func execute(task: @escaping () -> ()) {
        perform(#selector(runTask(_:)), on: thread, with: task, waitUntilDone: false)
    }
    /// åœæ­¢å®ˆæŠ¤çº¿ç¨‹
    func stop() {
        perform(#selector(clear), on: thread, with: nil, waitUntilDone: false)
    }
    
    /// æ¸…ç†èµ„æº : åœæ­¢ RunLoopã€é€€å‡ºçº¿ç¨‹
    @objc private func clear() {
        CFRunLoopStop(CFRunLoopGetCurrent())
        Thread.exit()
    }
    /// æ‰§è¡Œä»»åŠ¡
    @objc private func runTask(_ task: () -> ()) {
        task()
    }
  }
  ```

:::

### `AFNetworking` 2.0 ä¸­å¸¸é©»çº¿ç¨‹è®¾è®¡æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ



### `iOS` ä¸‹å¦‚ä½•å®ç°æŒ‡å®šçº¿ç¨‹æ•°ç›®çš„çº¿ç¨‹æ± ï¼Ÿ

### å¦‚ä½•ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„å·¥ä½œçº¿ç¨‹ï¼Ÿ

------

## å®šæ—¶å™¨

### â“`Timer` å®šæ—¶å™¨å‡†ç¡®å—ï¼Ÿå¦‚æœä¸å‡†ç¡®è¯¥æ€æ ·å®ç°ä¸€ä¸ªç²¾ç¡®çš„ `Timer`? 

::: details ğŸ’¡

  `Timer` çš„å®šæ—¶å¹¶ä¸ä¼šéå¸¸ç²¾ç¡®ï¼Œå› ä¸ºå®ƒä¾èµ–äº `RunLoop` çš„æ‰§è¡Œæƒ…å†µï¼Œå¦‚æœ `RunLoop` å¤„äºé™¤ `Default` æ¨¡å¼ä¹‹å¤–çš„çŠ¶æ€æˆ– `RunLoop` æ˜¯å¿™äºå…¶å®ƒäº‹æƒ…ï¼Œé‚£ä¹ˆ `Timer` æ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„ã€‚å› æ­¤ï¼Œå¦‚æœä½ å¯åŠ¨äº†ä¸€ä¸ªæ¯ç§’è§¦å‘ä¸€æ¬¡çš„ `Timer`ï¼Œå®é™…ä¸Šå®ƒè§¦å‘çš„æ—¶é—´é—´éš”å¯èƒ½ä¼šç¨å¾®å¤§äºä¸€ç§’ã€‚
  
  æ›´ç²¾ç¡®çš„å®šæ—¶å™¨æ–¹æ¡ˆï¼š
  
  - `RunLoop - common` æ¨¡å¼ : å°† `Timer` åŠ å…¥ `RunLoop` ä¸­çš„ `.common` æ¨¡å¼ã€‚
  
    ```swift
    let timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { timer in
     print("\(Date().timestamp)")
    }
    RunLoop.current.add(timer, forMode: .common)
    ```
    
  - åœ¨è‡ªå®šä¹‰çº¿ç¨‹ä¸­ä½¿ç”¨ `Timer`
    
    ```swift
    var thread = Thread(target: self, selector: #selector(newThread), object: nil)
    thread?.start()
    
    @objc func newThread() {
      autoreleasepool {
          timer = Timer.scheduledTimer(timeInterval: 1.0, target: self, selector: #selector(timerAction(_:)), userInfo: nil, repeats: true)
          RunLoop.current.run() // å¯åŠ¨å­çº¿ç¨‹çš„ RunLoop
      }
    } 
    ```

  - `GCD`ï¼šä½¿ç”¨ `dispatch_after` æ¥å®ç°å®šæ—¶å™¨åŠŸèƒ½

    ```swift
    DispatchQueue.main.asyncAfter(deadline: DispatchTime.now() + 1.0) {
      print("\(Date().timestamp)")
    }
    ```

  - `GCD`ï¼šä½¿ç”¨ `DispatchSourceTimer` æ¥å®ç°å®šæ—¶å™¨
  
    ```swift
    let queue = DispatchQueue.global(qos: .default)
    var gcdTimer: DispatchSourceTimer? = DispatchSource.makeTimerSource(flags: [], queue: queue)
    gcdTimer?.schedule(deadline: .now(), repeating: .seconds(1))
    gcdTimer?.setEventHandler(handler: {
      DispatchQueue.global(qos: .default).async {
          print("\(Date().timestamp)")
      }
    })
    gcdTimer?.resume() 
    ```
    
  - `CADisplayLink`: è¿™æ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡åŒæ­¥çš„å®šæ—¶å™¨ï¼Œæ¯ä¸€å¸§åˆ·æ–°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œç²¾åº¦å¾ˆé«˜ï¼Œå¸¸ç”¨äºåšåŠ¨ç”»ã€‚

    ```swift
    // ä¸å±å¹•åˆ·æ–°åŒæ­¥åˆ·æ–°è°ƒç”¨ render å‡½æ•°
    var displayLink: CADisplayLink? = CADisplayLink(target: self, selector: #selector(render))
    displayLink?.add(to: RunLoop.current, forMode: .common)
    ```

:::

### `NSTimer`ã€`CADisplayLink`ã€`dispatch_source_t` çš„ä¼˜åŠ£?

### `NSTimer` çš„å¾ªç¯å¼•ç”¨å¦‚ä½•è§£å†³ï¼Ÿ

