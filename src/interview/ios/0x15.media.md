---
title: éŸ³è§†é¢‘
icon: hashtag

index: true

---

<!-- more -->

### â“`GPUImage` æ¡†æ¶ä»‹ç»

::: details ğŸ’¡

`GPUImage` æ˜¯å¼€æºçš„å›¾åƒå’Œè§†é¢‘å¤„ç†æ¡†æ¶ï¼Œå¯¹è§†é¢‘å¤„ç†ã€äººåƒç¾é¢œã€å›¾åƒå¤„ç†ã€æ»¤é•œå¤„ç†ç­‰é¢†åŸŸæœ‰å¹¿æ³›åº”ç”¨ã€‚å…¶ä¸»è¦ç‰¹ç‚¹æœ‰ï¼š

1. å¼ºå¤§çš„åŠŸèƒ½ï¼š`GPUImage` ä¸­å†…ç½®äº†è®¸å¤šæ»¤é•œï¼Œç”¨æˆ·å¯ä»¥å¯¹è§†é¢‘å’Œå›¾ç‰‡è¿›è¡Œå„ç§å„æ ·çš„åº”ç”¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°è‡ªå®šä¹‰çš„æ»¤é•œã€‚

2. é«˜æ€§èƒ½ï¼š`GPUImage` æ˜¯åŸºäº OpenGL ES æ„å»ºçš„ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨è®¾å¤‡çš„ GPU å¤„ç†å¤§é‡è®¡ç®—ä»»åŠ¡ï¼Œæ¯”ä½¿ç”¨ CPU å¤„ç†æ•ˆç‡æ›´é«˜ï¼Œå¯¹å®æ—¶è§†é¢‘å¤„ç†åœºæ™¯éå¸¸æœ‰åˆ©ã€‚

3. æ˜“ç”¨æ€§ï¼š`GPUImage` çš„ API è®¾è®¡å°è£…å¾—ç›¸å½“å®Œå–„ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼ŒåŒæ—¶æ–‡æ¡£å…¨é¢ï¼Œä¸Šæ‰‹å®¹æ˜“ã€‚

4. å¯Œæœ‰æ‰©å±•æ€§ï¼š`GPUImage` ä¹Ÿå…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ»¤é•œï¼Œç”¨æˆ·å¯ä»¥å®ç°è‡ªå·±çš„è®¾è®¡ï¼Œå…·æœ‰å¾ˆé«˜çš„çµæ´»æ€§ã€‚

5. è·¨å¹³å°ï¼š`GPUImage` æ—¢æœ‰é€‚ç”¨äº iOS çš„ç‰ˆæœ¬ï¼Œä¹Ÿæœ‰é€‚ç”¨äº Android çš„ç‰ˆæœ¬ï¼Œè¿™å¤§å¤§æ–¹ä¾¿äº†åœ¨å¤šå¹³å°å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸€è‡´æ€§ã€‚

æ³¨æ„ï¼Œè™½ç„¶ `GPUImage` å¾ˆå¼ºå¤§ï¼Œä½†ç”±äºä½¿ç”¨äº† OpenGL ESï¼Œæ‰€ä»¥åœ¨ä¸€äº›ä¸æ”¯æŒæˆ–è€… OpenGL ES æ€§èƒ½è¾ƒå¼±çš„è®¾å¤‡ä¸Šå¯èƒ½ä¼šæœ‰ä¸€äº›é—®é¢˜ï¼Œè¿™æ˜¯ä½¿ç”¨ `GPUImage` éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚

:::

### â“`OpenGL` å¤„ç†æµç¨‹

::: details ğŸ’¡

OpenGLï¼ˆOpen Graphics Libraryï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ¸²æŸ“2Då’Œ3Då›¾å½¢çš„è·¨è¯­è¨€ã€è·¨å¹³å°çš„APIã€‚è¿™ç§èƒ½åŠ›ä½¿å¾—OpenGLæˆä¸ºè™šæ‹Ÿç°å®ã€æ¸¸æˆã€ä¸‰ç»´ç»˜å›¾ç­‰é¢†åŸŸçš„æ ‡å‡†è§„èŒƒã€‚

OpenGLçš„å¤„ç†è¿‡ç¨‹é€šå¸¸åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1. **é¡¶ç‚¹å¤„ç†**ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œä½ çš„åŸå§‹é¡¶ç‚¹åæ ‡ä¼šé€šè¿‡ä¸€ç³»åˆ—çš„æ“ä½œå˜æ¢åˆ°å±å¹•åæ ‡ç³»ã€‚è¿™äº›æ“ä½œåŒ…æ‹¬å˜æ¢ï¼ˆæ—‹è½¬ã€ç¼©æ”¾ã€å¹³ç§»ï¼‰ã€è£å‰ªï¼ˆå»é™¤ä¸åœ¨è§†é‡å†…çš„é¡¶ç‚¹ï¼‰ç­‰ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯å¯ä»¥ç”¨è‡ªå®šä¹‰çš„é¡¶ç‚¹ç€è‰²å™¨ï¼ˆVertex Shaderï¼‰ç¨‹åºè¿›è¡Œå¤„ç†çš„ã€‚

2. **å›¾å…ƒè£…é…**ï¼šåœ¨æ‰€æœ‰çš„é¡¶ç‚¹è¢«å¤„ç†åï¼ŒOpenGLå¼€å§‹å°†è¿™äº›é¡¶ç‚¹è£…é…æˆå›¾å½¢åŸºå…ƒï¼ˆå¦‚ç‚¹ã€çº¿ã€é¢ï¼‰ã€‚

3. **å…‰æ …åŒ–**ï¼šå›¾å…ƒåœ¨å±å¹•ä¸Šè¢«åˆ’åˆ†ä¸ºä¸€ç³»åˆ—çš„ç‰‡å…ƒï¼ˆåƒç´ ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åšå…‰æ …åŒ–ã€‚

4. **ç‰‡å…ƒå¤„ç†**ï¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œç‰‡å…ƒç€è‰²å™¨ï¼ˆFragment Shaderï¼‰ä¼šå¤„ç†æ¯ä¸ªç‰‡å…ƒï¼Œæ¯”å¦‚å¯¹ç‰‡å…ƒæ·»åŠ é¢œè‰²ã€çº¹ç†æˆ–æ‰§è¡Œæ›´å¤æ‚çš„æ•ˆæœã€‚

5. **æ·±åº¦æµ‹è¯•å’Œæ··åˆ**ï¼šOpenGLå¯¹è¿™äº›ç‰‡å…ƒè¿›è¡Œæ·±åº¦æµ‹è¯•ï¼Œåˆ¤æ–­å“ªäº›ç‰‡å…ƒæ˜¯çœŸæ­£å¯è§çš„ã€‚ä¸Šé¢çš„æ‰€æœ‰é˜¶æ®µéƒ½åªç”¨æ¥ç”Ÿæˆä¸€å †ç‰‡å…ƒï¼Œä»¥åŠæ¯ä¸ªç‰‡å…ƒå¯¹åº”çš„æ·±åº¦å€¼ã€‚æœ€åå¦‚æœå¼€å¯æ··åˆï¼Œè¿˜ä¼šæ ¹æ®æºä¸ç›®æ ‡çš„alphaå€¼æ¥è®¡ç®—æœ€åçš„é¢œè‰²å€¼ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒOpenGLæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œå®ƒä¼šä¿å­˜ä½ è®¾ç½®çš„æ‰€æœ‰çŠ¶æ€ï¼Œç›´åˆ°ä½ å°†å…¶æ”¹å˜ä¸ºæ­¢ã€‚å› æ­¤ï¼Œåœ¨ç»˜åˆ¶è¿‡ç¨‹ä¸­ï¼Œä½ éœ€è¦å¤„ç†ä½ çš„OpenGLçŠ¶æ€ä»¥é˜²æ­¢ä½ ä»å‰çš„è®¾ç½®å½±å“åˆ°åé¢çš„æ¸²æŸ“ã€‚

ä»¥ä¸Šå°±æ˜¯å¯¹OpenGLå¤„ç†æµç¨‹çš„ç®€è¦ä»‹ç»ï¼Œå…·ä½“å®ç°ä¼šæœ‰æ›´å¤šç»†èŠ‚å¯æ·±å…¥å­¦ä¹ ã€‚

:::

### â“`iOS` ä¸­å¦‚ä½•å®ç°è§†é¢‘ä¸¤å€é€Ÿæ’­æ”¾ï¼Œå¹¶ä¸¤å€é€Ÿå¯¼å‡º

::: details ğŸ’¡

åœ¨iOSä¸­ï¼Œåˆ©ç”¨AVFoundationæ¡†æ¶ï¼Œå¯ä»¥è½»æ¾æ›´æ”¹è§†é¢‘æ’­æ”¾çš„é€Ÿåº¦ã€‚ä¸ºäº†å°†è§†é¢‘å¯¼å‡ºä¸ºäºŒå€é€Ÿï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è§†é¢‘ï¼Œå¹¶åœ¨æ¯ä¸€å¸§æ—¶é’ŸåŠ å€ã€‚ä¸‹é¢æ˜¯è¯¦ç»†çš„æ­¥éª¤ï¼š

1. æ’­æ”¾è§†é¢‘çš„ä¸¤å€é€Ÿï¼š

AVPlayerçš„rateå±æ€§å¯ä»¥ç”¨æ¥æ§åˆ¶è§†é¢‘çš„æ’­æ”¾é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å°†ä¼šè®©è§†é¢‘Playçš„é€Ÿåº¦åŠ å€ï¼š

```swift
let player = AVPlayer(url: url)
player.rate = 2.0 // 2å€é€Ÿåº¦
player.play()
```

2. å¯¼å‡ºä¸¤å€é€Ÿçš„è§†é¢‘ï¼š

è¿™æ–¹é¢éœ€è¦ä½¿ç”¨åˆ°AVAssetExportSessionï¼Œå¦å¤–ä»¥éœ€è¦å¯¹è§†é¢‘çš„æ¯ä¸€å¸§è¿›è¡Œå¤„ç†ï¼Œå°†å…¶æ—¶é’ŸåŠ å€ã€‚è¿™éœ€è¦ä¾èµ–ä¸€äº›ç›¸å¯¹å¤æ‚çš„ä»£ç ï¼Œä½ å¯ä»¥å‚è€ƒä¸€äº›å¼€æºåº“ï¼ˆå¦‚ï¼šSDAVAssetExportSessionï¼‰æ¥å®ç°ã€‚

å¯¼å‡ºå¸¦æœ‰é€Ÿåº¦è°ƒæ•´çš„è§†é¢‘æ—¶ï¼Œä¸ä»…éœ€è¦ä¿®æ”¹è§†é¢‘è½¨é“çš„æ—¶é—´ï¼Œè¿˜å¯èƒ½éœ€è¦è°ƒæ•´éŸ³é¢‘è½¨é“çš„æ’­æ”¾é€Ÿåº¦ä»¥ç¡®ä¿éŸ³è§†é¢‘åŒæ­¥ã€‚

å¦å¤–ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šéå¸¸æ¶ˆè€—æ€§èƒ½ï¼Œæ‰€ä»¥é€šå¸¸éœ€è¦åœ¨åå°çº¿ç¨‹è¿›è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

Ps. AVFoundationä¸­çš„ä¸€äº›ç±»åœ¨ä½¿ç”¨æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„å…¶ç”Ÿå‘½å‘¨æœŸã€‚éœ€æ³¨æ„åœ¨é€‚å½“çš„æ—¶æœºé‡Šæ”¾è¿™äº›å¯¹è±¡ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼æˆ–è€…ç”±äºå¯¹è±¡è¢«è¿‡æ—©é‡Šæ”¾å¯¼è‡´çš„å´©æºƒã€‚

ä»¥ä¸Šå°±æ˜¯åœ¨iOSçš„AVFoundationæ¡†æ¶ä¸­ï¼Œå®ç°è§†é¢‘ä¸¤å€é€Ÿæ’­æ”¾å’Œå¯¼å‡ºçš„å¤§è‡´æ­¥éª¤å’Œéœ€è¦æ³¨æ„çš„ä¸€äº›é—®é¢˜ã€‚å¦‚æœæœ‰æ›´å¤šå…·ä½“çš„é—®é¢˜å¯ä»¥å†è¯¦ç»†è¯¢é—®ã€‚

:::

### â“`PCM` è®¡ç®—æ—¶é—´

::: details ğŸ’¡

PCMï¼ˆPulse Code Modulationï¼‰æ˜¯ä¸€ç§æ•°å­—åŒ–éŸ³é¢‘çš„æ–¹å¼ã€‚è®¡ç®—PCMæ•°æ®çš„æ—¶é•¿å¯ä»¥æ ¹æ®ä»¥ä¸‹å…¬å¼ï¼š

```
æ—¶é—´ï¼ˆç§’ï¼‰= æ•°æ®å¤§å°ï¼ˆå­—èŠ‚ï¼‰ / (é‡‡æ ·ç‡ * ä½æ·±åº¦/8 * é€šé“æ•°)
```

å…¶ä¸­ï¼š

- æ•°æ®å¤§å°å³ä½ çš„PCMæ–‡ä»¶çš„å¤§å°(å­—èŠ‚ï¼‰
- é‡‡æ ·ç‡æ˜¯æŒ‡å½•éŸ³è®¾å¤‡åœ¨ä¸€ç§’é’Ÿå†…å¯¹å£°éŸ³ä¿¡å·çš„é‡‡æ ·æ¬¡æ•°ï¼Œé€šå¸¸æ˜¯44.1kHzï¼Œ48kHzæˆ–96kHzã€‚
- ä½æ·±åº¦æ˜¯æŒ‡å½•éŸ³è®¾å¤‡åœ¨å¯¹æ¯æ¬¡é‡‡æ ·çš„å£°éŸ³ä¿¡å·è¿›è¡Œæ¨¡æ‹Ÿè½¬æ•°å­—çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œèƒ½å¤Ÿè®°å½•çš„å£°éŸ³ä¿¡å·çš„ç²¾åº¦ï¼Œé€šå¸¸æ˜¯16ä½æˆ–24ä½ã€‚
- é€šé“æ•°æ˜¯éŸ³é¢‘çš„å£°é“æ•°ï¼Œå¦‚å•å£°é“ï¼ˆMonoï¼‰ä¸º1ï¼Œç«‹ä½“å£°ï¼ˆStereoï¼‰ä¸º2ã€‚

å‡å¦‚ä½ æœ‰ä¸€ä¸ª5MBçš„PCMæ–‡ä»¶ï¼Œé‡‡æ ·ç‡ä¸º44.1kHzï¼Œé‡‡æ ·ä½æ·±åº¦ä¸º16ä½ï¼Œä¸ºç«‹ä½“å£°éŸ³é¢‘ï¼Œé‚£ä¹ˆè¿™æ®µPCMæ•°æ®çš„æ—¶é•¿å¯ä»¥è®¡ç®—ä¸ºï¼š

```
æ—¶é—´ = 5 * 1024 * 1024 (å­—èŠ‚) / (44.1 * 1024 * 16/8 * 2) â‰ˆ 30ç§’
```
è¿™æ ·ä½ å°±å¾—åˆ°äº†è¿™æ®µéŸ³é¢‘çš„å¤§æ¦‚æ—¶é•¿ã€‚

:::

### â“`iOS` ä¸­éŸ³é¢‘é™ç‡¥å¦‚ä½•å¤„ç†

::: details ğŸ’¡

åœ¨iOSå¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›ç¬¬ä¸‰æ–¹åº“ï¼ˆä¾‹å¦‚ WebRTCã€EZAudioï¼‰æ¥è¿›è¡Œé™å™ªå¤„ç†ã€‚ä½†æ˜¯ï¼Œè‹¹æœè‡ªèº«å¹¶æ²¡æœ‰æä¾›ç›´æ¥çš„éŸ³é¢‘é™å™ªAPIã€‚

1. WebRTCï¼šè¿™æ˜¯ç”±Googleå¼€å‘ï¼Œç”¨äºéŸ³é¢‘å’Œè§†é¢‘çš„å®æ—¶é€šä¿¡ã€‚å®ƒæ‹¥æœ‰å¾ˆå¥½çš„è¯­éŸ³å¤„ç†æ¨¡å—ï¼Œèƒ½å¤Ÿè¿›è¡Œå™ªå£°æŠ‘åˆ¶ã€‚è¿™æ˜¯ä¸€ä¸ªå¼€æºåº“ï¼Œä½ éœ€è¦è‡ªè¡Œç¼–è¯‘å¹¶æ·»åŠ åˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚

2. EZAudioï¼šè¿™æ˜¯ä¸€ä¸ªiOSå’ŒmacOSçš„éŸ³é¢‘æ¡†æ¶ï¼Œæ˜¯å¯¹Core Audio APIçš„ç®€åŒ–å°è£…ï¼Œä½¿å¾—å¼€å‘è€…æ›´åŠ ç®€å•åœ°ä½¿ç”¨ã€‚è™½ç„¶EZAudioæœ¬èº«ä¸æä¾›é™å™ªåŠŸèƒ½ï¼Œä½†æ˜¯å®ƒä¾¿äºä½ å®æ—¶è·å–åˆ°éŸ³é¢‘çš„æ•°æ®ï¼Œæ¥ç€ä½ å°±å¯ä»¥å¯¹éŸ³é¢‘æ•°æ®è¿›è¡Œé™å™ªå¤„ç†ã€‚

3. `Superpowered`

:::

### â“`iOS` ä¸­è§†é¢‘åˆæˆå¦‚ä½•å¤„ç†

::: details ğŸ’¡

> ä½¿ç”¨ `AVFoundation` æ¡†æ¶ä¸­çš„ `AVMutableComposition` ç±»æ¥åˆæˆå¤šä¸ªè§†é¢‘ç‰‡æ®µ

```swift
import AVFoundation

// åˆ›å»ºä¸€ä¸ª AVMutableComposition å¯¹è±¡ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªæ–°çš„å¯å˜ç¼–è¾‘ç¯å¢ƒï¼š
let mixComposition = AVMutableComposition()
// è·å–éœ€è¦åˆæˆçš„è§†é¢‘èµ„æ–™å¹¶åˆ›å»ºå¯¹åº”çš„ AVAsset å¯¹è±¡
let videoAssetA = AVAsset(url: URL(fileURLWithPath: "path/to/video_a.mp4"))
let videoAssetB = AVAsset(url: URL(fileURLWithPath: "path/to/video_b.mp4"))
// åˆ›å»º AVMutableCompositionTrack å¯¹è±¡å¹¶æ·»åŠ è§†é¢‘æ–‡ä»¶ï¼š
if let compositionVideoTrack = mixComposition.addMutableTrack(withMediaType: AVMediaType.video, preferredTrackID: CMPersistentTrackID(kCMPersistentTrackID_Invalid)),
    let sourceTrackA = videoAssetA.tracks(withMediaType: AVMediaType.video).first,
    let sourceTrackB = videoAssetB.tracks(withMediaType: AVMediaType.video).first {
        do {
            try compositionVideoTrack.insertTimeRange(CMTimeRangeMake(start: CMTime.zero, duration: videoAssetA.duration), of: sourceTrackA, at: CMTime.zero)
            try compositionVideoTrack.insertTimeRange(CMTimeRangeMake(start: CMTime.zero, duration: videoAssetB.duration), of: sourceTrackB, at: videoAssetA.duration)
        } catch {
            print(error)
        }
}
// åˆ›å»º AVAssetExportSession å¯¹è±¡ï¼Œè®¾ç½®è¾“å‡ºæ ¼å¼å’Œè·¯å¾„ï¼Œç„¶åå¼€å§‹å¯¼å‡º
let outputFilePath = "path/to/output.mp4"
let outputFileURL = URL(fileURLWithPath: outputFilePath)
if let exporter = AVAssetExportSession(asset: mixComposition, presetName: AVAssetExportPresetHighestQuality) {
    exporter.outputURL = outputFileURL
    exporter.outputFileType = AVFileType.mp4
    exporter.shouldOptimizeForNetworkUse = true
    exporter.exportAsynchronously {
        switch exporter.status {
        case .completed:
            print("Export complete")
        case .failed:
            print("Failed: \(exporter.error?.localizedDescription ?? "unknown error")")
        case .cancelled:
            print("Cancelled")
        default:
            print("Unknown")
        }
    }      
}
```

:::

------

## ç¼–ç 

### â“ç¡¬ç¼–ç  vs è½¯ç¼–ç 

::: details ğŸ’¡

ç¡¬ç¼–ç å’Œè½¯ç¼–ç æ˜¯ç”¨äºå¤„ç†æ•°å­—åª’ä½“ç¼–ç /è§£ç çš„ä¸¤ç§åŸºæœ¬æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯ä»–ä»¬çš„åŸºæœ¬ç‰¹ç‚¹ï¼š

ç¡¬ç¼–ç ï¼ˆç¡¬ä»¶ç¼–ç ï¼‰ï¼š
- ç¡¬ç¼–ç æ˜¯é€šè¿‡ç¡¬ä»¶æ¥è¿›è¡Œåª’ä½“æ•°æ®çš„ç¼–ç å’Œè§£ç ã€‚è¿™äº›ç¡¬ä»¶åŒ…æ‹¬ç”¨äºç¼–ç è§£ç ï¼ˆCodecï¼‰çš„ä¸“é—¨èŠ¯ç‰‡æˆ–è€…GPUç­‰ã€‚
- ç¡¬ç¼–ç é€šå¸¸æ¯”è½¯ç¼–ç å¿«ï¼Œå› ä¸ºç¡¬ä»¶ç¼–ç å™¨æ˜¯ä¸“é—¨è®¾è®¡ç”¨äºç¼–ç /è§£ç çš„ï¼Œå®ƒä»¬çš„ç®—æ³•ä¼˜åŒ–çº§åˆ«æ¯”è½¯ä»¶æ›´é«˜ã€‚
- ç¡¬ç¼–ç æ¶ˆè€—çš„CPUèµ„æºè¾ƒå°‘ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å·¥ä½œéƒ½åœ¨ç‰¹å®šçš„ç¡¬ä»¶ä¸Šæ‰§è¡Œã€‚
- ç¡¬ç¼–ç çš„ç¼ºç‚¹æ˜¯çµæ´»æ€§å·®ï¼Œä¾èµ–äºç¡¬ä»¶çš„èƒ½åŠ›ï¼Œé’ˆå¯¹ä¸ªåˆ«è§†é¢‘ç¼–ç /è§£ç æŠ€æœ¯å¯èƒ½æ²¡æœ‰ç­‰æ•ˆçš„ç¡¬ä»¶æ”¯æŒã€‚

è½¯ç¼–ç ï¼ˆè½¯ä»¶ç¼–ç ï¼‰ï¼š
- è½¯ç¼–ç æ˜¯åœ¨CPUä¸Šè¿›è¡Œç¼–ç å’Œè§£ç çš„è¿‡ç¨‹ã€‚è½¯ç¼–ç ä¸ä¾èµ–äºç‰¹å®šçš„ç¡¬ä»¶ï¼Œè€Œæ˜¯ä¾èµ–CPUå’Œç¼–ç /è§£ç è½¯ä»¶ï¼ˆä¾‹å¦‚FFmpegï¼Œx264ç­‰ï¼‰ã€‚
- è½¯ç¼–ç çš„ä¼˜åŠ¿æ˜¯çµæ´»æ€§é«˜ï¼Œå®ƒå¯ä»¥å¾ˆå®¹æ˜“åœ°ä¼˜åŒ–å’Œå‡çº§ï¼Œä»¥é€‚åº”æ–°çš„ç¼–ç æ ‡å‡†å’Œæ ¼å¼ã€‚è€Œä¸”é€šå¸¸è½¯ç¼–ç åœ¨è§†é¢‘è´¨é‡å’Œå‹ç¼©æ•ˆç‡æ–¹é¢è¡¨ç°æ›´å¥½ã€‚
- è½¯ç¼–ç çš„ç¼ºç‚¹æ˜¯è€—è´¹çš„CPUèµ„æºè¾ƒå¤šï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿååº”æ…¢æˆ–è€…å…¶ä»–ä»»åŠ¡å˜æ…¢ã€‚

æ€»çš„æ¥è¯´ï¼Œåº”é€‰æ‹©ç¡¬ç¼–ç å’Œè½¯ç¼–ç éœ€è¦æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚å†³å®šã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯åœ¨ç”µæ± ä¾›ç”µçš„è®¾å¤‡ä¸Šè¿›è¡Œå®æ—¶è§†é¢‘æµå¤„ç†ï¼Œå¯èƒ½æ›´å€¾å‘äºä½¿ç”¨ç¡¬ç¼–ç ï¼Œå› ä¸ºå®ƒå¯¹ç”µæ± ä½¿ç”¨çš„å½±å“æ›´å°ã€‚ç„¶è€Œï¼Œå¦‚æœéœ€è¦æœ€é«˜çš„è§†é¢‘è´¨é‡å’Œæœ€å°çš„æ–‡ä»¶å¤§å°ï¼Œå¯èƒ½ä¼šé€‰æ‹©è½¯ç¼–ç ã€‚

:::

### â“FBOã€H264

::: details ğŸ’¡



:::

------

## æ»¤é•œ

### â“æ»¤é•œå®ç°åŸç†

::: details ğŸ’¡



:::

### â“å¦‚ä½•å®ç°åˆ†å‰²æ»¤é•œ

::: details ğŸ’¡



:::

## ç›´æ’­

### â“ç›´æ’­æ•´ä½“æµç¨‹?

::: details ğŸ’¡

ç›´æ’­çš„æ•´ä½“æµç¨‹å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦æ­¥éª¤ï¼š

1. **ä¿¡å·é‡‡é›†**ï¼šä½¿ç”¨æ‰‹æœºã€ç”µè„‘æˆ–ä¸“ç”¨è®¾å¤‡é‡‡é›†éŸ³è§†é¢‘ä¿¡æ¯ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸éœ€è¦è°ƒç”¨è®¾å¤‡çš„æ‘„åƒå¤´å’Œéº¦å…‹é£ç­‰ç¡¬ä»¶è®¾å¤‡è¿›è¡Œå®æ—¶éŸ³è§†é¢‘å½•åˆ¶ã€‚

2. **ç¼–ç ä¸å‹ç¼©**ï¼šå°†é‡‡é›†åˆ°çš„éŸ³è§†é¢‘ä¿¡å·è¿›è¡Œç¼–ç å’Œå‹ç¼©ï¼Œè½¬æˆå¯ä»¥ç½‘ç»œä¼ è¾“çš„æµåª’ä½“æ ¼å¼ï¼Œå¦‚H.264, H.265, VP8, VP9ç­‰è§†é¢‘ç¼–ç å’ŒAACã€MP3ç­‰éŸ³é¢‘ç¼–ç ã€‚

3. **ä¸Šä¼ æ¨æµ**ï¼šå°†ç¼–ç åçš„éŸ³è§†é¢‘æ•°æ®é€šè¿‡ç½‘ç»œå‘é€åˆ°ç›´æ’­æœåŠ¡å™¨ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦ç¨³å®šã€è¿ç»­çš„ç½‘ç»œè¿æ¥æ¥ä¿è¯ä¿¡å·çš„å®æ—¶æ€§ã€‚

4. **æœåŠ¡å™¨æ¥æ”¶ä¸è½¬å‘**ï¼šç›´æ’­æœåŠ¡å™¨æ¥æ”¶åˆ°ç›´æ’­æ•°æ®åï¼Œä¼šè¿›è¡Œä¸€äº›å¿…è¦çš„å¤„ç†ï¼Œå¦‚è½¬ç ã€å½•åˆ¶ã€æ’æ’­å¹¿å‘Šç­‰ï¼Œç„¶åè½¬å‘ç»™è§‚çœ‹çš„ç”¨æˆ·ã€‚

5. **è§‚ä¼—æ‹‰æµ&è§£ç **ï¼šè§‚ä¼—ç«¯æ‹‰å–ç›´æ’­æµæ•°æ®ï¼Œç„¶åè§£ç æ’­æ”¾ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿéœ€è¦ç¨³å®šçš„ç½‘ç»œç¯å¢ƒï¼Œå¹¶ä¸”è¦è§£å†³è§†é¢‘æ’­æ”¾çš„åŒæ­¥å’Œæ—¶å»¶é—®é¢˜ã€‚

6. **äº¤äº’åé¦ˆ**ï¼šè§‚ä¼—ä¸ä¸»æ’­è¿›è¡Œäº’åŠ¨ï¼Œå¦‚å‘å¼¹å¹•ã€é€ç¤¼ç‰©ã€è¯„è®ºç­‰ï¼Œè¿™äº›éƒ½éœ€è¦å®æ—¶åé¦ˆåˆ°ç›´æ’­ç•Œé¢ä¸Šã€‚

è¿™ä¸ªè¿‡ç¨‹éœ€è¦éµå¾ªä¸€å®šçš„åè®®å’Œæ ‡å‡†ï¼Œå¦‚RTMP, HLS, WebRTCç­‰æµåª’ä½“ä¼ è¾“åè®®ï¼Œä¸ºäº†æé«˜è§†é¢‘è§‚çœ‹ä½“éªŒï¼Œè¿˜éœ€è¦è§£å†³å»¶è¿Ÿã€ä¸¢åŒ…ã€æŠ–åŠ¨ç­‰ç½‘ç»œé—®é¢˜ã€‚è€Œä¸”åœ¨æ¯ä¸€ä¸ªæ­¥éª¤ä¸­éƒ½å¯èƒ½æ¶‰åŠåˆ°å¤§é‡çš„æŠ€æœ¯ç»†èŠ‚å’ŒæŒ‘æˆ˜ã€‚

:::

### â“è§†é¢‘ä»`é‡‡é›† -> æ˜¾ç¤º -> ä¿å­˜` æ•´ä¸ªæµç¨‹

::: details ğŸ’¡

è§†é¢‘çš„æ•´ä¸ªå·¥ä½œæµç¨‹é€šå¸¸å¯ä»¥åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. **é‡‡é›†**ï¼šè§†é¢‘çš„é‡‡é›†é€šå¸¸ç”±æ‘„åƒå¤´å®Œæˆï¼Œæ‘„åƒå¤´å°†å®æ—¶åœºæ™¯è½¬æ¢ä¸ºæ•°å­—ä¿¡å·ã€‚æ­¤è¿‡ç¨‹æ¶‰åŠåˆ°å›¾åƒé‡‡é›†è®¾å¤‡çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå…‰å­¦å’Œæ„Ÿå…‰åŸç†ç­‰å†…å®¹ã€‚

2. **é¢„å¤„ç†**ï¼šé‡‡é›†åˆ°çš„æ•°å­—ä¿¡å·è¿›è¡Œé¢„å¤„ç†ï¼Œè¿™åŒ…æ‹¬é¢œè‰²ç©ºé—´è½¬æ¢ï¼Œé™å™ªå¤„ç†ï¼Œæ˜æš—å¤„ç†ç­‰æ­¥éª¤ï¼Œç›®çš„æ˜¯æé«˜è§†é¢‘çš„æ„ŸçŸ¥è´¨é‡ã€‚

3. **ç¼–ç **ï¼šç¼–ç é˜¶æ®µå°†é¢„å¤„ç†åçš„è§†é¢‘æ•°æ®è½¬æ¢ä¸ºç‰¹å®šæ ¼å¼ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«å­˜å‚¨æˆ–ä¼ è¾“ã€‚ç¼–ç é€šå¸¸éœ€è¦è€ƒè™‘å‹ç¼©çš„éœ€è¦ï¼Œç”¨æ¥å‡å°‘è§†é¢‘æ•°æ®çš„å¤§å°ï¼ŒåŒ…å«H.264ï¼ŒH.265ï¼ŒVP8ï¼ŒVP9ç­‰ç¼–ç æ ¼å¼ã€‚

4. **å°è£…**ï¼šç¼–ç åçš„è§†é¢‘æ•°æ®éœ€è¦è¿›è¡Œå°è£…ï¼Œå°è£…æ•°æ®åŒ…æ‹¬éŸ³é¢‘æµã€è§†é¢‘æµä»¥åŠå­—å¹•ç­‰ï¼Œå¸¸è§çš„å°è£…æ ¼å¼æœ‰MP4ï¼ŒFLVï¼ŒMKVï¼ŒAVIï¼ŒMOVç­‰ã€‚

5. **ä¼ è¾“**ï¼šè§†é¢‘æ•°æ®é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°æœåŠ¡å™¨æˆ–è€…ä¼ è¾“åˆ°å…¶ä»–è®¾å¤‡ã€‚å¯ä»¥ä½¿ç”¨RTMPï¼ŒHLSï¼ŒHTTP-FLVç­‰ä¼ è¾“åè®®ã€‚

6. **è§£ç **ï¼šæ¥æ”¶ç«¯æ”¶åˆ°è§†é¢‘æ•°æ®åï¼Œå…ˆè§£å°è£…ï¼Œç„¶åå°†éŸ³é¢‘å’Œè§†é¢‘æ•°æ®è§£ç å›åŸå§‹æ ¼å¼ã€‚

7. **åå¤„ç†**ï¼šè§£ç åçš„æ•°æ®å¯ä»¥è¿›è¡Œä¸€å®šçš„åå¤„ç†ï¼Œå¦‚é€šè¿‡ç¡¬ä»¶åŠ é€Ÿæé«˜æ’­æ”¾æ€§èƒ½ï¼Œæˆ–è€…å¯¹å›¾åƒè¿›è¡Œå¢å¼ºå¤„ç†ç­‰ã€‚

8. **æ˜¾ç¤º**ï¼šå°†è§£ç åçš„è§†é¢‘æ•°æ®æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚

9. **ä¿å­˜**ï¼šå¦‚æœéœ€è¦ï¼Œå¯ä»¥å°†è§†é¢‘æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨è®¾å¤‡ä¸­ã€‚æ­¤æ—¶ï¼Œè§†é¢‘æ•°æ®é€šå¸¸ä»¥æŸç§æ–‡ä»¶æ ¼å¼ä¿å­˜ï¼Œå¯ä»¥æ˜¯å·²ç»ç¼–ç å’Œå°è£…çš„æ ¼å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯åŸå§‹çš„æœªç¼–ç æ ¼å¼ã€‚

ä»¥ä¸Šå°±æ˜¯è§†é¢‘ä»é‡‡é›†åˆ°æ˜¾ç¤ºå†åˆ°ä¿å­˜çš„æ•´ä¸ªæµç¨‹ã€‚æ¯ä¸ªæ­¥éª¤ä¸­éƒ½å¯èƒ½æ¶‰åŠåˆ°å¤§é‡çš„æŠ€æœ¯ç»†èŠ‚å’ŒæŒ‘æˆ˜ã€‚

:::

### â“`rtmp`ã€`webrtc`

::: details ğŸ’¡



:::

### â“`ffmpeg`

### â“`OpenCV`

------

## `AVFoundation`

### â“`AVFoundation` & `GPUImage` & `OpenGL ES` & `MetalKit`

::: details ğŸ’¡

:::

### â“`samplebuffer` vs `pixelbuffer`

::: details ğŸ’¡

  - `CMSampleBufferRef` : `Core Media`æ¡†æ¶ä¸­è¢«ç”¨æ¥ç®¡ç†éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ç­‰æ ·æœ¬çš„é›†åˆã€‚ä¸€ä¸ª `samplebuffer` åŒ…å«ä¸€åˆ°å¤šä¸ªæ ·æœ¬ä»¥åŠæè¿°è¿™äº›æ ·æœ¬çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚æ˜¾ç¤ºæ—¶é—´æˆ³ã€è§£ç æ—¶é—´æˆ³ã€æŒç»­æ—¶é—´ã€å¸§é€Ÿç‡ç­‰ã€‚`samplebuffer`åœ¨æ›´é«˜çš„å±‚çº§ç®¡ç†æ•°æ®ï¼ŒåŒ…å«äº†è§£å‹ç¼©å’Œæ’­æ”¾åª’ä½“æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚

  - `CVPixelBufferRef` : `Core Video` æ¡†æ¶ä¸­è¢«ç”¨æ¥ç®¡ç†å›¾åƒæ•°æ®ã€‚ä¸€ä¸ª `pixelbuffer` è¡¨ç¤ºä¸€ä¸ªè§†é¢‘å¸§ï¼Œå®ƒåŒ…å«äº†è§†é¢‘å¸§çš„åŸå§‹åƒç´ æ•°æ®ã€‚`pixelbuffer` æ˜¯åœ¨æ›´ä½çš„å±‚çº§å¤„ç†æ•°æ®ï¼Œä»…ä»…åŒ…å«äº†åƒç´ ä¿¡æ¯ï¼Œæ²¡æœ‰æ—¶é—´æˆ³ã€æŒç»­æ—¶é—´ç­‰å…ƒæ•°æ®ã€‚

  > ä¸¤è€…åŒºåˆ«ï¼š`samplebuffer` æ˜¯å¯¹åŒ…å«éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ç­‰æ ·æœ¬çš„é›†åˆçš„å°è£…ï¼ŒåŒ…å«äº†æ’­æ”¾åª’ä½“æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œ`pixelbuffer` æ˜¯å¯¹è§†é¢‘å¸§çš„åŸå§‹åƒç´ æ•°æ®çš„å°è£…ï¼Œæ›´å…³æ³¨å›¾åƒå±‚é¢çš„ç»†èŠ‚ã€‚

:::

### â“`CMTime` ç»“æ„

::: details ğŸ’¡

:::

### â“å¦‚ä½•ä½¿ç”¨ `AVFoundation` ç»™è§†é¢‘æ·»åŠ æ°´å°

::: details ğŸ’¡

ä½¿ç”¨ `AVFoundation` ç»™è§†é¢‘æ·»åŠ æ°´å°ä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»º `AVMutableComposition` å¯¹è±¡ï¼Œå®ƒç”¨æ¥ç®¡ç†æ‰€æœ‰çš„éŸ³é¢‘ã€è§†é¢‘å’Œæ—¶é—´çº¿èµ„æºï¼Œå¹¶ç»™å®ƒæ·»åŠ è§†é¢‘è½¨é“ï¼ˆ`AVMutableCompositionTrack`

    ```swift
    let mixComposition = AVMutableComposition()
    guard let videoTrack = mixComposition.addMutableTrack(withMediaType: .video, preferredTrackID: Int32(kCMPersistentTrackID_Invalid)) else { return }
    ```

2. ä»åŸå§‹è§†é¢‘èµ„æºè·å–è½¨é“ï¼Œå¹¶æ·»åŠ åˆ° composition ä¸­ã€‚

   ```swift
    guard let assetTrack = asset.tracks(withMediaType: .video).first else { return }
    do {
        try videoTrack.insertTimeRange(CMTimeRangeMake(start: CMTime.zero, duration: asset.duration),
                                       of: assetTrack,
                                       at: CMTime.zero)
    } catch {
        print("Failed to load video track")
        return
    }
    ```

3. åˆ›å»ºä¸€ä¸ª `CALayer` ç”¨äºæ˜¾ç¤ºæ°´å°å¹¶æ·»åŠ åˆ° composition çš„ layer ä¸­ã€‚

    ```swift
    let size = videoTrack.naturalSize
    let watermarkLayer = CATextLayer()
    watermarkLayer.string = "Watermark"
    watermarkLayer.foregroundColor = UIColor.red.cgColor
    watermarkLayer.fontSize = 40
    watermarkLayer.frame = CGRect(x: size.width / 2, y: size.height / 2, width: size.width / 2, height: size.height / 2)
    watermarkLayer.opacity = 0.5

    let parentLayer = CALayer()
    let videoLayer = CALayer()
    parentLayer.frame = CGRect(x: 0, y: 0, width: size.width, height: size.height)
    videoLayer.frame = CGRect(x: 0, y: 0, width: size.width, height: size.height)
    parentLayer.addSublayer(videoLayer)
    parentLayer.addSublayer(watermarkLayer)

    let videoComposition = AVMutableVideoComposition()
    videoComposition.animationTool = AVVideoCompositionCoreAnimationTool(postProcessingAsVideoLayer: videoLayer, in: parentLayer)
    videoComposition.renderSize = size
    videoComposition.frameDuration = CMTime(value: 1, timescale: 30)
    ```

4. åˆ›å»º `AVAssetExportSession` æ¥å¯¼å‡ºå¸¦æœ‰æ°´å°çš„è§†é¢‘ã€‚

    ```swift
    guard let exporter = AVAssetExportSession(asset: mixComposition, presetName: AVAssetExportPresetHighestQuality) else { return }
    exporter.videoComposition = videoComposition
    exporter.outputFileType = .mp4
    let outputURL = // your output url
    exporter.outputURL = outputURL
    exporter.shouldOptimizeForNetworkUse = true

    exporter.exportAsynchronously(completionHandler: {
        switch exporter.status {
        case .completed:
            print("Exported successfully")
        case .failed, .cancelled:
            print("Failed: \(exporter.error)")
        default:
            break
        }
    })
    ```
    
ä»¥ä¸Šè¿™æ®µä»£ç ç»™å‡ºäº†ä¸€ä¸ªåŸºæœ¬çš„åœ¨è§†é¢‘ä¸­æ·»åŠ æ–‡æœ¬æ°´å°çš„ç¤ºä¾‹ã€‚å¦‚æœä½ è¦æ·»åŠ å›¾ç‰‡æ°´å°ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª `CALayer`ï¼Œå‘å…¶ä¸­æ·»åŠ ä¸€å¼  `UIImage`ã€‚å¦å¤–åœ¨çœŸå®åœºæ™¯ä¸‹ï¼Œä½ å¯èƒ½éœ€è¦å¤„ç†æ›´å¤šçš„é”™è¯¯å’Œ edge casesã€‚

:::

------

## AVPlayer

### â“å®ç°åŸç†

::: details ğŸ’¡



:::

### â“ç¼“å­˜æœºåˆ¶

::: details ğŸ’¡



:::

### â“è¾¹æ’­è¾¹ä¸‹

::: details ğŸ’¡



:::

### â“è®¾è®¡ä¸€ä¸ªé€šç”¨è§†é¢‘æ’­æ”¾å™¨

::: details ğŸ’¡



:::
