---
title: RunLoop
icon: hashtag

index: true

---

  > è¿è¡Œå¾ªç¯

<!-- more -->

### â“`RunLoop` æœ‰å‡ ç§äº‹ä»¶æºï¼Ÿæœ‰å‡ ç§æ¨¡å¼ï¼Ÿ

::: details ğŸ’¡

  `RunLoop`æ˜¯ç”¨æ¥ç®¡ç†äº‹ä»¶å’Œå¤„ç† `IO` çš„åŸºæœ¬æ¶æ„
  
  ä¸‰ç§äº‹ä»¶æº

  - `Timer`ï¼šå®šæ—¶å™¨äº‹ä»¶
    > `RunLoop` æŒ‰ç…§è®¾å®šçš„æ—¶é—´åŒºé—´æ¥æ”¶å®šæ—¶å™¨äº‹ä»¶ã€‚
  - `Source`ï¼šè¾“å…¥æºäº‹ä»¶
    > åŒ…æ‹¬ä¸¤ç§ç±»å‹ï¼šsource0 & source1
    * source0 : è‡ªå®šä¹‰çš„è¾“å…¥æºï¼Œéœ€è¦ç¨‹åºå‘˜è‡ªå·±ç”Ÿæˆå’Œç®¡ç†ã€‚
    * source1 ï¼š åŸºäº `Port` çš„è¾“å…¥æºï¼Œæ¥æ”¶æ¥è‡ªå…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨å½“å‰çº¿ç¨‹ä¸Šè°ƒç”¨æŒ‡å®šçš„å¤„ç†æ–¹æ³•ã€‚
  - `Observer`ï¼šè§‚å¯Ÿè€…äº‹ä»¶
    > å¯ä»¥è®¾ç½®åœ¨ `RunLoop` å„ä¸ªè¿è¡Œé˜¶æ®µæ¥æ”¶çš„äº‹ä»¶ã€‚

  è¿è¡Œæ¨¡å¼

  - `NSDefaultRunLoopMode`ï¼ˆkCFRunLoopDefaultModeï¼‰ï¼šé»˜è®¤æ¨¡å¼
    > å¦‚æœä¸æ‰‹åŠ¨æŒ‡å®šæ¨¡å¼ï¼Œ`RunLoop` å°±åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹è¿è¡Œã€‚
  - `UITrackingRunLoopMode`ï¼šç•Œé¢è·Ÿè¸ªæ¨¡å¼
    > ç”¨äº `ScrollView` æ»šåŠ¨æ—¶ã€‚
  - `UIInitializationRunLoopMode`ï¼šå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„æ¨¡å¼
    > å¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚
  - `NSRunLoopCommonModes`ï¼ˆkCFRunLoopCommonModesï¼‰ï¼šè¿™æ˜¯ä¸€ä¸ªå ä½æ¨¡å¼ï¼Œä¸æ˜¯ä¸€ç§çœŸæ­£çš„ Modeã€‚
    > å¯ä»¥å°†äº‹ä»¶æºï¼ˆ`Timer/Observer/Source`ï¼‰æ·»åŠ åˆ° `CommonModes` ä¸­ï¼Œ`RunLoop` è¿è¡Œåœ¨å“ªç§ Mode æ—¶ï¼Œåªè¦è¿™ç§ Mode è¢«æ ‡è®°ä¸º Common çš„å±æ€§ï¼Œåˆ™ `RunLoop` å°±ä¼šå¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚

:::

### â“`Runloop` å†…éƒ¨å®ç°é€»è¾‘ï¼Ÿ

::: details ğŸ’¡

  `RunLoop` çš„å†…éƒ¨å®ç°å¯ä»¥ç®€å•åœ°æ¦‚æ‹¬ä¸ºä¸€ä¸ª `while` å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­å¤„ç†å„ç§è¾“å…¥æºçš„äº‹ä»¶ã€‚`RunLoop` åœ¨å¼€å¯åä¼šä¸€ç›´åœ¨è¿™ä¸ªå¾ªç¯ä¸­æ‰§è¡Œï¼Œç›´åˆ°æ¥æ”¶åˆ°åœæ­¢ `RunLoop` çš„æ¶ˆæ¯ã€‚

  - `RunLoop` åœ¨å¯åŠ¨æ—¶ä¼šä»é¢„è®¾çš„ `Mode` ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œç„¶åè¿›å…¥ `RunLoop` çš„å¾ªç¯ã€‚
  
  - è¿›å…¥å¾ªç¯å‘¨æœŸ
    * é¦–å…ˆï¼Œå¤„ç†æ‰€æœ‰åˆ°æœŸçš„å®šæ—¶å™¨äº‹ä»¶ã€‚
    * ç„¶åï¼Œå¤„ç†æ‰€æœ‰çš„è¾“å…¥æºäº‹ä»¶ã€‚è¾“å…¥æºçš„äº‹ä»¶åŒ…æ‹¬æ¥è‡ª `Port` çš„æ¶ˆæ¯ï¼Œä»¥åŠç”¨æˆ·å®šä¹‰çš„å…¶ä»–äº‹ä»¶ã€‚
    * ç„¶åï¼Œå¦‚æœæœ‰è§‚å¯Ÿè€…çš„è¯ï¼Œ`RunLoop` ä¼šé€šçŸ¥è§‚å¯Ÿè€…å½“å‰ `RunLoop` çš„çŠ¶æ€ã€‚
    * æœ€åï¼Œå¦‚æœåœ¨å¤„ç†äº‹ä»¶çš„è¿‡ç¨‹ä¸­æ²¡æœ‰ä»»ä½•æºéœ€è¦å¤„ç†ï¼Œé‚£ä¹ˆ `RunLoop` ä¼šè¿›å…¥ä¼‘çœ ç­‰å¾…è¢«å”¤é†’ã€‚

  - ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œç›´åˆ°æ¥æ”¶åˆ°ç»“æŸ `RunLoop` çš„æ¶ˆæ¯ã€‚

:::

### `runloop` ä¸ `performSelector` çš„å…³ç³»ï¼Ÿ

### `performSelector` vs `NSInvocation`

### â“ä»¥ä¸‹ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ

  ```objc
  NSLog(@"1");
  dispatch_async(dispatch_get_global_queue(0, 0), ^{
    NSLog(@"2");
    [self performSelector:@selector(test) withObject:nil afterDelay:10];
    NSLog(@"3");
  });
  NSLog(@"4");
  - (void)test {
    NSLog(@"5");
  }
  ```

::: details ğŸ’¡

  > æ‰“å°é¡ºåº : 1, 4, 2, 3

  "1"å’Œ"4"æ˜¯æ™®é€šçš„ç›´æ¥æ‰§è¡Œä»£ç ï¼Œå› æ­¤ä¼šæŒ‰ç…§é¡ºåºè¾“å‡ºã€‚
  
  "2"å’Œ"3"ä½äºå¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œä¼šåœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šåœ¨"1"å’Œ"4"ä¹‹åå¼€å§‹æ‰§è¡Œã€‚

  "5"ä¸ä¼šè¾“å‡ºã€‚åŸå› æ˜¯`[self performSelector:@selector(test) withObject:nil afterDelay:10];`è¿™ä¸€è¡Œä»£ç è¢«æ”¾åœ¨å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†æ˜¯è¿™ç§æ‰§è¡Œæ–¹å¼æ˜¯ä¾èµ– `RunLoop` çš„ï¼Œè€Œæ–°åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨ `RunLoop` çš„ï¼Œæ‰€ä»¥`performSelector:afterDelay:`æ–¹æ³•ä¼šå¤±æ•ˆã€‚


  > å¦‚æœæƒ³è¦ä½¿ "5" èƒ½å¤Ÿæ‰“å°ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ
    
  ```objc
  // æ–¹æ¡ˆä¸€ : æ”¾å…¥ä¸»çº¿ç¨‹ RunLoop
  [self performSelectorOnMainThread:@selector(test) withObject:nil waitUntilDone:NO];
    
  // æ–¹æ¡ˆäºŒ : åœ¨å­çº¿ç¨‹ä¸­æ‰‹åŠ¨å¯åŠ¨ RunLoop
  NSRunLoop *runLoop = [NSRunLoop currentRunLoop];
  [self performSelector:@selector(test) withObject:nil afterDelay:5.0];
  [runLoop run];
  ```

:::