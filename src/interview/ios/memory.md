---
title: å†…å­˜ç®¡ç†
icon: hashtag

index: true
order: 8

---

<!-- more -->

## å†…å­˜åˆ†é…

### â“`OC` ä¸­ä¸€ä¸ª `NSObject` å¯¹è±¡ï¼Œå å‡ ä¸ªå­—èŠ‚ï¼Ÿ

::: details ğŸ’¡

  ä¸€ä¸ª `NSObject` å¯¹è±¡åº”è¯¥å°±æ˜¯å­˜æ”¾è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ã€‚ä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°åº”è¯¥æ˜¯å ç”¨ 16 ä¸ªç›´æ¥ã€‚

  ```objc
  @interface Todo: NSObject 
  {
     int: _no;
     String: _title;
     String: _detail;
  }
  @end
  ```

:::

### â“å¦‚ä½•ä½¿ç”¨ `UIImageView` æ˜¾ç¤ºä¸€ä¸ªè¶…å¤§å›¾ç‰‡ï¼Œå¹¶ä¸”æ”¯æŒç¼©æ”¾åŠŸèƒ½ï¼Ÿ

::: details ğŸ’¡

  ç”±äº `UIImageView` é€šè¿‡ `UIImage` åŠ è½½å›¾ç‰‡ï¼Œæ˜¯ä¸€æ¬¡æ€§å°†å›¾ç‰‡åŠ è½½åˆ°å†…å­˜ï¼Œè¶…å¤§å›¾ç‰‡ä¼šå¼•å‘å†…å­˜ä¸è¶³çš„çš„é—®é¢˜ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¸èƒ½ä¸€æ¬¡å…¨éƒ¨åŠ è½½ï¼Œéœ€è¦ä½¿ç”¨åˆ†æ²»æ€æƒ³ï¼Œå°†å›¾ç‰‡åƒç´ ç‚¹åˆ†å—åŠ è½½ï¼ŒåªåŠ è½½å¯è§†åŒºåŸŸåƒç´ ç‚¹ã€‚ä½¿ç”¨ `Tile Rendering` çš„è§£å†³æ–¹æ¡ˆï¼Œç±»ä¼¼å®¶åº­è£…ä¿®è´´åœ°ç –çš„æ–¹å¼ï¼Œå…ˆå°†å›¾ç‰‡åƒç´ æŒ‰ç…§ä¸€å®šçš„å¤§å°åˆ†å‰²æˆ `Tile`ï¼Œç„¶åæ ¹æ®å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸæ¸²æŸ“ã€‚`CATiledLayer` æ˜¯ä¸€ç§é€‚ç”¨äºå¤„ç†å¤§é‡æ•°æ®çš„æ¸²æŸ“çš„ layerï¼Œé€‚åˆå¤„ç†è¿™ç§æƒ…å†µã€‚
  ç¼©æ”¾åŠŸèƒ½å¯ä»¥é€šè¿‡å°† `UIImageView` åµŒå¥—åœ¨ `UIScrollView` é‡Œé¢ï¼Œæ ¹æ®ç¼©æ”¾çš„ä»£ç†å›è°ƒï¼Œè¿›è¡Œ `Tile` çš„é‡æ–°ç»˜åˆ¶ã€‚
  
:::
  
### â“`C++` ä¸­ `placement new` ç‰¹æ€§ï¼Œåœ¨ `OC` ä¸­å¯ä»¥ä½¿ç”¨å—ï¼Ÿ

::: details ğŸ’¡

  `placement new` : æ˜¯ä¸€ç§å¯ä»¥å·²åˆ†é…å†…å­˜çš„ä½ç½®ç›´æ¥æ„é€ å¯¹è±¡çš„ç‰¹æ€§ï¼Œè€Œè¿™ä¸ªå·²åˆ†é…å†…å­˜å¯ä»¥æ ˆåŒºä¹Ÿå¯ä»¥æ˜¯å †åŒºã€‚
  
  ```cpp
  // æ ˆå†…å­˜
  char buffer[sizeof(Foo)]; 
  Foo* foo = new(buffer) Foo(args);
  // å †å†…å­˜
  char* buffer = new char[sizeof(Foo)]; 
  Foo* foo = new(buffer) Foo(args);
  ```
  
  `OC` æ˜¯ä¸å…·å¤‡è¿™ä¸ªç‰¹æ€§ï¼Œä½†æ˜¯å¯ä»¥å€ŸåŠ© `C` è¯­è¨€åˆ†é…å†…å­˜ã€‚
  
  ```objc
  // OC å¸¸è§„æ–¹æ¡ˆ
  Foo* foo = [[Foo alloc] init];
  // ä½¿ç”¨ C åˆ†é…å†…å­˜
  Foo* foo = (Foo*) malloc(sizeof(Foo));
  if (foo != NULL) {
      [foo init];
  }
  ```
  
:::
  
## `autoreleasepool` - â€œè‡ªåŠ¨é‡Šæ”¾æ± â€
  
### ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨åˆ›å»º `autoreleasepool` ï¼Ÿ
  
::: details ğŸ’¡

  - å¤§é‡çš„å¯¹è±¡åœ¨çŸ­æ—¶é—´å†…è¢«åˆ›å»ºå’Œé”€æ¯ï¼Œä¸”ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŠæ—¶åœ°å›æ”¶å†…å­˜éå¸¸é‡è¦ã€‚ç”±äº `ARC`ï¼ˆè‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼‰æœºåˆ¶åœ¨ä¸€æ¬¡ `RunLoop` å¾ªç¯ç»“æŸåæ‰è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥å¦‚æœä¸ä½¿ç”¨ `autoreleasepool`ï¼Œé‚£ä¹ˆåœ¨ä¸€æ¬¡ `RunLoop` å¾ªç¯æœŸé—´åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡éƒ½ä¸ä¼šè¢«ç«‹åˆ»é‡Šæ”¾ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å³°å€¼çš„æ˜¾è‘—å¢åŠ ã€‚ä½¿ç”¨ `autoreleasepool` å¯ä»¥åœ¨ä»£ç å—ç»“æŸæ—¶ç«‹å³é‡Šæ”¾è¿™äº›å¯¹è±¡ï¼Œä»è€Œæœ‰æ•ˆåœ°é™ä½å†…å­˜å³°å€¼ã€‚

  - åœ¨å­çº¿ç¨‹æˆ–è€…è‡ªå®šä¹‰çš„çº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸»çº¿ç¨‹çš„ `RunLoop` ä¼šè‡ªåŠ¨åˆ›å»º `autoreleasepool`ï¼Œå…¶ä»–çš„çº¿ç¨‹éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚

  ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `autoreleasepool` çš„ä¾‹å­ï¼š

  ```swift
  for _ in 1...1000000 {
    autoreleasepool {
        // è¿™é‡Œé¢çš„ä»£ç åœ¨æ¯æ¬¡ loop ç»“æŸæ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾æ‰ä½¿ç”¨äº† autorelease çš„æ‰€æœ‰å¯¹è±¡
        let image = UIImage(named: "huge_image.png")
        print(image?.size ?? "No image found")
    }
  }
  ```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¯ä¸€æ¬¡å¾ªç¯ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„autoreleaseå¯¹è±¡Imageã€‚è¿™å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ã€‚ä½¿ç”¨`autoreleasepool`åˆ™å¯ä»¥ä¿è¯åœ¨æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶ï¼ŒImageå¯¹è±¡éƒ½èƒ½å¤Ÿè¢«ç«‹å³å›æ”¶ï¼Œä»è€Œæœ‰æ•ˆæ§åˆ¶å†…å­˜ä½¿ç”¨ã€‚
  
:::
  
### â€œæ‰¾ bugâ€ 

  > â“ä»¥ä¸‹ä»£ç å­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ

  ```objc
  @autoreleasepool {
    for (int i = 0; i < INT_MAX; i++) {
        Test *test = [[Test alloc] init];
    }
  }
  ```
  
::: details ğŸ’¡
  
  ç”³è¯·å¯¹è±¡æ—¶ï¼Œåœ¨ `ARC` ç¼–è¯‘æœŸé—´ï¼Œä¼šæ·»åŠ  `autorelease`ï¼Œå°†ç”³è¯·çš„å¯¹è±¡åŠ å…¥åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ã€‚å¦‚æœåœ¨ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ç”³è¯·å¤§é‡å¯¹è±¡ï¼Œé‚£ä¹ˆå¯¹è±¡çš„é‡Šæ”¾éƒ½éœ€è¦ç­‰åˆ°è¿™ä¸ªè¿™ä¸ªè‡ªåŠ¨é‡Šæ”¾æ‰€åœ¨çš„ `RunLoop` ä¼‘çœ æˆ–ç»“æŸæ—¶æ‰èƒ½é‡Šæ”¾ï¼Œç”³è¯·å¤§é‡å¯¹è±¡æ—¶ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦å°† `@autoreleasepool` åŠ å…¥åˆ° `for` å¾ªç¯é‡Œé¢ã€‚

  ```objc
  for (int i = 0; i < INT_MAX; i++) {
    @autoreleasepool {
        Test *test = [[Test alloc] init];
    }
  }
  ```

:::

  > â“^ å¦‚æœå°† `for` å¾ªç¯æ”¹ä¸º `enumerateObjectsUsingBlock` ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿ

::: details ğŸ’¡

  ä¸ä¼šæœ‰é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºæšä¸¾å™¨æ–¹æ³•å®ç°æ—¶ï¼Œå·²ç»å°† `block` åµŒå¥—åœ¨ `@autoreleasepool` ä¸­ã€‚
  
:::
  
## å¼•ç”¨è®¡æ•°

### å¦‚æœè®©ä½ å®ç°å±æ€§çš„ `weak`ï¼Œå¦‚ä½•å®ç°çš„ï¼Ÿ

## å†…å­˜åˆ†æ

### app å†…å­˜æ˜¯å¦‚ä½•åˆ†æçš„ï¼Ÿ

### å†…å­˜æ³„æ¼å¯èƒ½ä¼šå‡ºç°çš„å‡ ç§åŸå› ï¼Ÿ
    
  > é `OC` å¯¹è±¡å¦‚ä½•å¤„ç†ï¼Ÿ

  > å¦‚æœå¸¸ç”¨æ¡†æ¶å‡ºç°å†…å­˜æ³„æ¼å¦‚ä½•å¤„ç†ï¼Ÿ