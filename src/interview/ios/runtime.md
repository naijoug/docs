---
title: Runtime
icon: hashtag

index: true

---

  > è¿è¡Œæ—¶

<!-- more -->

### â“`OC` çš„å¯¹è±¡æ¨¡å‹

::: details ğŸ’¡


> Objective-C ç±»å›¾

![objc-class-diagram](media/objc-class-diagram.jpg)


:::

### â“`isa` æ˜¯ä»€ä¹ˆï¼Ÿ

::: details ğŸ’¡

  > `isa`ï¼š `OC` å¯¹è±¡çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæ˜¯æ¯ä¸ª `OC` å¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œç”¨äºæŒ‡å‘è¯¥å¯¹è±¡çš„ç±»å¯¹è±¡ã€‚
    
  `Objective-C` çš„å¯¹è±¡æ¨¡å‹ä¸­ï¼Œå¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ã€ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡ï¼Œè¿™ä¸‰ç§å¯¹è±¡éƒ½å«æœ‰ `isa` æŒ‡é’ˆã€‚

  - å®ä¾‹å¯¹è±¡: å®ä¾‹å¯¹è±¡çš„`isa`æŒ‡å‘å®ƒçš„ç±»å¯¹è±¡ï¼›å®ä¾‹å¯¹è±¡ä¸»è¦å­˜å‚¨å®ä¾‹å˜é‡çš„å€¼ã€‚

  - ç±»å¯¹è±¡: ç±»å¯¹è±¡çš„`isa`æŒ‡å‘å…ƒç±»å¯¹è±¡ï¼›ç±»å¯¹è±¡ä¸»è¦å­˜å‚¨å®ä¾‹æ–¹æ³•ã€å±æ€§ã€ä»¥åŠéµå®ˆçš„åè®®ç­‰ä¿¡æ¯ã€‚

  - å…ƒç±»å¯¹è±¡: å…ƒç±»å¯¹è±¡çš„`isa`æŒ‡å‘è‡ªèº«ï¼›å…ƒç±»å¯¹è±¡ä¸»è¦å­˜å‚¨ç±»æ–¹æ³•ç­‰ä¿¡æ¯ã€‚

  å½“å‘é€æ¶ˆæ¯ç»™ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œ`runtime` é€šè¿‡è¿™ä¸ªå¯¹è±¡çš„ `isa` æŒ‡é’ˆæ‰¾åˆ°å®ƒçš„ç±»å¯¹è±¡ï¼Œç„¶ååœ¨ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚

:::

### è®²ä¸€ä¸‹å¯¹è±¡ï¼Œç±»å¯¹è±¡ï¼Œå…ƒç±»ï¼Œè·Ÿå…ƒç±»ç»“æ„ä½“çš„ç»„æˆä»¥åŠä»–ä»¬æ˜¯å¦‚ä½•ç›¸å…³è”çš„ï¼Ÿ

### ä¸ºä»€ä¹ˆè¦è®¾è®¡ `metaclass`ï¼Ÿ

### ä¸ºä»€ä¹ˆå¯¹è±¡æ–¹æ³•æ²¡æœ‰ä¿å­˜çš„å¯¹è±¡ç»“æ„ä½“é‡Œï¼Œè€Œæ˜¯ä¿å­˜åœ¨ç±»å¯¹è±¡çš„ç»“æ„ä½“é‡Œï¼Ÿ

### `class_copyIvarList` vs `class_copyPropertyList`

### `class_ro_t` vs `class_rw_t`

### èƒ½å¦å‘ç¼–è¯‘åå¾—åˆ°çš„ç±»ä¸­å¢åŠ å®ä¾‹å˜é‡ï¼Ÿèƒ½å¦å‘è¿è¡Œæ—¶åˆ›å»ºçš„ç±»ä¸­æ·»åŠ å®ä¾‹å˜é‡ï¼Ÿ

### å¯¹è±¡æ–¹æ³• ä¸ ç±»æ–¹æ³•å­˜æ”¾åœ¨å“ªï¼Ÿ

### `class`ã€`objc_getClass`ã€`object_getclass` ä¸‰ä¸ªæ–¹æ³•çš„åŒºåˆ«ï¼Ÿ

### åœ¨è¿è¡Œæ—¶åˆ›å»ºç±»çš„æ–¹æ³• `objc_allocateClassPair` çš„æ–¹æ³•åå°¾éƒ¨ä¸ºä»€ä¹ˆæ˜¯pairï¼ˆæˆå¯¹çš„æ„æ€ï¼‰ï¼Ÿ

### â“`super` æ˜¯ä»€ä¹ˆï¼Ÿ

::: details ğŸ’¡

  `super` å¹¶ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œåœ¨ `OC` è¿›è¡Œæ¶ˆæ¯è°ƒç”¨æ—¶ï¼Œå…¶å®æ˜¯æœ‰ä¸¤ä¸ªéšè—å‚æ•°çš„ï¼Œä¸€ä¸ªæ˜¯æ¥æ”¶è€…(receiver)ï¼Œä¸€ä¸ªæ˜¯æ–¹æ³•é€‰æ‹©å™¨(selector)ã€‚
  
  å¸¸è§çš„ `self` è¡¨ç¤ºçš„æ˜¯æ¥æ”¶è€…ã€‚è€Œ `super` å…¶å®æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ ‡ç¤ºç¬¦ï¼Œå½“å‘é€ç»™ `super` ä¸€ä¸ªæ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨è€…ä»ç„¶æ˜¯ `self` ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¼šä»å½“å‰ç±»çš„çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾æ–¹æ³•ã€‚
  
> ä»¥ä¸‹ä»£ç è¾“å‡ºï¼Ÿ

  ```objc
  @interface Animal
  @end
  @interface Dog : Animal
  @end
  @implementation Dog
  - (instancetype)init {
    self = [super init];
    if (self) {
        NSLog(@"%@", NSStringFromClass([self class]));
        NSLog(@"%@", NSStringFromClass([super class]));
    }
    return self;
  }
  @end
  ```
  
  ä¹Ÿå°±æ˜¯è¯´ `super` å¹¶ä¸ä¼šæ”¹å˜æ¶ˆæ¯çš„æ¥æ”¶è€…ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨ `[super class]` æ—¶ï¼Œè™½ç„¶æ˜¯ä»çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾ `class` æ–¹æ³•ï¼Œä½†æ˜¯æ–¹æ³•çš„æ¥æ”¶è€…ä¾ç„¶æ˜¯ `self` æœ¬èº«ï¼Œå…¶ç±»åˆ«è‡ªç„¶æ˜¯å½“å‰ç±»æœ¬èº«ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å†è°ƒç”¨ `[super class]` æ—¶è¿˜ä¼šè¿”å› `Dog` ç±»çš„åŸå› ã€‚

:::

  > `super` çš„åº•å±‚å®ç°ï¼Ÿ

::: details ğŸ’¡

  `OC` ä¸­ `super` çš„å®ç°æ˜¯é€šè¿‡ `runtime` çš„ `objc_msgSendSuper` å’Œ `objc_msgSendSuper_stret` ä¸¤ä¸ªå‡½æ•°æ¥å®Œæˆçš„ã€‚å…·ä½“æ¥è¯´ï¼Œå½“ç¼–è¯‘å™¨é‡åˆ° `[super method]` è¿™ç§å½¢å¼çš„è°ƒç”¨æ—¶ï¼Œä¼šè½¬åŒ–ä¸º `objc_msgSendSuper(super_cls, sel)` çš„å½¢å¼ã€‚

  ```c
  // super ç»“æ„ä½“
  struct objc_super {
    __unsafe_unretained id receiver;        // æ¶ˆæ¯çš„æ¥æ”¶è€…
    __unsafe_unretained Class super_class;  // çˆ¶ç±»(å¼€å§‹æŸ¥æ‰¾çš„ç±»)
  };
  // objc_msgSendSuper
  void objc_msgSendSuper(struct objc_super *super, SEL op, ...)
  ```

:::

### â“`weak` çš„åº•å±‚å®ç°ï¼Ÿ

### â“`OC` è¿è¡Œæ—¶åœ¨å·¥ç¨‹ä¸­çš„æœ‰è¿‡å®è·µè¿ç”¨å—ï¼Ÿ