---
title: Thread - â€œå¤šçº¿ç¨‹â€
icon: hashtag

index: true

---

<!-- more -->

### â“`Dart` æ˜¯ä¸æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œæ˜¯å¦‚ä½•è¿è¡Œçš„

::: details ğŸ’¡ 

> `Dart` æ˜¯å•çº¿ç¨‹æ‰§è¡Œæ¨¡å‹ï¼Œå®ƒçš„å¹¶å‘æ¨¡å‹åŸºäºâ€œäº‹ä»¶å¾ªç¯â€ã€‚

`Dart` ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼Œæ‰€æœ‰çš„ `Dart` ä»£ç åœ¨ä¸€ä¸ªç§°ä¸º `Isolate` çš„å•çº¿ç¨‹æ‰§è¡Œç¯å¢ƒä¸­è¿è¡Œã€‚æ¯ä¸ª `Isolate` æœ‰è‡ªå·±çš„å†…å­˜å †ï¼Œä¸åŒçš„ `Isolate` ä¹‹é—´ä¸èƒ½å…±äº«å†…å­˜ï¼Œåªèƒ½é€šè¿‡æ¶ˆæ¯ä¼ é€’æ¥äº¤äº’ã€‚

  äº‹ä»¶å¾ªç¯å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œ`Dart` è¯­è¨€ä¼šä¸æ–­å»æ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰äº‹ä»¶ï¼ˆå¦‚ç”¨æˆ·äº¤äº’ã€`I/O`ã€è®¡æ—¶å™¨ç­‰ï¼‰å°±å¤„ç†äº‹ä»¶ï¼Œäº‹ä»¶å¤„ç†å®Œåå†å»æ£€æŸ¥ä¸‹ä¸€ä¸ªäº‹ä»¶ï¼Œå¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…äº‹ä»¶çš„å‘ç”Ÿã€‚

  ç”±äº `Dart` æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œæ‰€ä»¥é’ˆå¯¹æŸä¸ªç‰¹å®šçš„ä»»åŠ¡ï¼Œå‡å¦‚è¿™ä¸ªä»»åŠ¡ç‰¹åˆ«è€—æ—¶ï¼Œä¼šå æ®çº¿ç¨‹å¤§é‡æ—¶é—´ï¼Œå…¶ä»–ä»»åŠ¡å°±æ— æ³•å¾—åˆ°åŠæ—¶çš„å¤„ç†ï¼Œå› æ­¤ `Dart` ä¸­æœ‰ `Microtask` å’Œ `Event` ä¸¤ç§ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`Microtask` é˜Ÿåˆ—ä¼˜å…ˆçº§é«˜äº `Event` é˜Ÿåˆ—ã€‚æ‰§è¡Œé¡ºåºä¸ºï¼šå…ˆæ‰§è¡Œæ‰€æœ‰ `Microtask` ä»»åŠ¡ï¼Œç„¶åå†å¤„ç†ä¸€ä¸ª `Event` ä»»åŠ¡ï¼Œå†æ‰§è¡Œæ­¤ `Event` äº§ç”Ÿçš„æ‰€æœ‰ `Microtask`ï¼Œä¾æ­¤ç±»æ¨ã€‚

:::

### â“`Dart` å¤šä»»åŠ¡å¦‚ä½•å¹¶è¡Œçš„

::: details ğŸ’¡ 

  `Dart` æœ¬èº«æ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒä¾èµ–äºäº‹ä»¶å¾ªç¯å’Œå¼‚æ­¥ç¼–ç¨‹ä»¥ä¾¿åœ¨å•ä¸€çº¿ç¨‹ä¸­å®Œæˆå°½å¯èƒ½å¤šçš„ä»»åŠ¡ã€‚å¯¹äºéœ€è¦å¹¶è¡Œè®¡ç®—æˆ–è€…è¯¸å¦‚æ–‡ä»¶è¯»å†™ç­‰é˜»å¡æ€§æ“ä½œï¼Œ`Dart` æä¾›äº† `Isolate` çš„æ¦‚å¿µã€‚

  `Isolate` å¯ä»¥è¢«çœ‹ä½œæ˜¯ `Dart` çš„è½»é‡çº§çº¿ç¨‹ã€‚æ¯ä¸ª `Isolate` æœ‰å…¶è‡ªå·±çš„å†…å­˜å †å¹¶ä¸”ä¸ä¸å…¶ä»– `Isolate` å…±äº«å†…å­˜ã€‚è¿™é¿å…äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„å¸¸è§é—®é¢˜ï¼Œå¦‚çº¿ç¨‹é”å®šå’Œæ•°æ®ç´Šä¹±ç­‰ï¼Œå¹¶å¢å¼ºäº†å®‰å…¨æ€§ã€‚ä½†æ˜¯ï¼Œå› ä¸ºå†…å­˜ä¸å…±äº«ï¼Œæ‰€ä»¥ `Isolates` ä¹‹é—´åªèƒ½é€šé€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œé€šä¿¡ã€‚

  `Dart` çš„å¹¶å‘å®ç°ï¼šåœ¨å•çº¿ç¨‹ä¸­å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚æœéœ€è¦ä»»åŠ¡å¹¶è¡Œè®¡ç®—åˆ™å¯ä»¥åˆ›å»ºå¤šä¸ª `Isolates` æ¥æ‰§è¡Œä»»åŠ¡ã€‚

æ³¨æ„ï¼šè™½ç„¶æ¯ä¸ª `Isolate` æœ‰è‡ªå·±çš„äº‹ä»¶é˜Ÿåˆ—ï¼Œä½†æ˜¯åˆ›å»ºã€å¯åŠ¨å’Œç®¡ç† `Isolate` éœ€è¦ç›¸å¯¹è¾ƒé‡çš„èµ„æºï¼ˆæ¯”å¦‚å†…å­˜å’Œè®¡ç®—æ—¶é—´ï¼‰ï¼Œå¹¶ä¸”æ¶ˆæ¯ä¼ é€’å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿæœ‰ä¸€äº›å¼€é”€ã€‚æ‰€ä»¥åœ¨ç¡®å®éœ€è¦çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ `Isolate` è¿›è¡Œå¹¶å‘æ“ä½œï¼Œä¾‹å¦‚å¤„ç† `CPU` å¯†é›†å‹ä»»åŠ¡æˆ–è€…è¿›è¡Œå¤§é‡çš„ `I/O` æ“ä½œã€‚

:::

### â“`Future` ä¸ `microtask` ä¸¤è€…çš„æ‰§è¡Œé¡ºåº

::: details ğŸ’¡ 

`Dart` ä¸­çš„äº‹ä»¶é˜Ÿåˆ—ï¼š

  - äº‹ä»¶é˜Ÿåˆ— `Event Queue`
  - å¾®ä»»åŠ¡é˜Ÿåˆ— `Microtask Queue`

åŒºåˆ«ï¼š

  - `Future` æ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ° `Event Queue` ä¸­ï¼Œç„¶åæŒ‰ç…§äº‹ä»¶é¡ºåºæ¥å¤„ç†ã€‚

  - `Microtask` æ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ° `Microtask Queue` ä¸­ã€‚
  
è¿è¡Œæœºåˆ¶ï¼š
  > `Microtask Queue` çš„ä¼˜å…ˆçº§é«˜äº `Event Queue`ï¼Œæ‰§è¡Œé¡ºåºä¸€èˆ¬æ¥è¯´ï¼Œ`Microtask` ä¼šåœ¨ `Future` ä¹‹å‰æ‰§è¡Œã€‚

  - äº‹ä»¶å¾ªç¯ä» `Microtask Queue` ä¸­è·å–ä»»åŠ¡ï¼Œå¦‚æœ `Microtask Queue` ä¸­æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆä¸€ç›´æ‰§è¡Œåˆ° `Microtask Queue` ä¸ºç©ºã€‚

  - å½“ `Microtask Queue` ä¸ºç©ºæ—¶ï¼Œäº‹ä»¶å¾ªç¯ä¼šæ£€æŸ¥ `Event Queue`ï¼Œå¦‚æœæœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆå–å‡ºä¸€ä¸ªæ‰§è¡Œï¼Œç„¶åå†å»æ‰§è¡Œ `Microtask Queue` ä¸­çš„ä»»åŠ¡ã€‚

:::

### â“`Future.microtask` vs `scheduleMicrotask`

::: details ğŸ’¡

  - `scheduleMicrotask`: `dart:async` åŒ…ä¸­çš„ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç”¨äºåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸæ—¶ï¼Œä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¼€å§‹å‰æ‰§è¡Œã€‚

    ```dart
    scheduleMicrotask(() {
       print('This is a micro task');
    });
    ```

  - `Future.microtask`: `Future` ç±»ä¸­çš„ä¸€ä¸ªå·¥å‚æ„é€ å‡½æ•°ï¼Œå®ƒä¹Ÿæ˜¯ç”¨äºåœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œä½†å®ƒä¼šè¿”å›ä¸€ä¸ª `Future`ï¼Œæ­¤ `Future` åœ¨ä»»åŠ¡æ‰§è¡Œå®Œåå®Œæˆã€‚
    > `Future.microtask` å†…éƒ¨å®ç°æ—¶åŸºäº `scheduleMicrotask`ï¼Œå”¯ä¸€åŒºåˆ«åœ¨äºè¿”å›äº†ä¸€ä¸ª `Feture`ã€‚

    ```dart
    var future = Future.microtask(() {
       print('This is a micro task');
    });
    future.then({
      // ....
    });
    future.catchError({
      // ...
    });
    ```
    
:::


### â“`Isolate` `compute` æ˜¯å¦‚ä½•è¿è¡Œçš„

::: details ğŸ’¡ 

- `Isolate`: å†…éƒ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç‹¬ç«‹è¿è¡Œçš„æ‰§è¡Œçº¿ç¨‹ï¼Œå®ƒæœ‰è‡ªå·±çš„å†…å­˜ï¼ˆå †å’Œæ ˆï¼‰ï¼Œå¹¶è¿è¡Œä¸€ä¸ªäº‹ä»¶å¾ªç¯ã€‚`Isolate` å¯ä»¥è¿è¡Œé‡å¤æˆ–è€…æŒç»­çš„ä»»åŠ¡ã€‚
    > ä¾‹å¦‚è®¡æ—¶å™¨æˆ–è€…ç›‘å¬æŸä¸ªç‰¹å®šèµ„æºçš„å˜åŒ–ï¼Œå®ƒæœ‰è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸”å¯ä»¥ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°æ˜¾å¼åœ°è¢«åœæ­¢ã€‚

    ```dart
    import 'dart:isolate';
    
    void printMessage(String message) {
      print(message);
    }
    
    void main() {
      Isolate.spawn(printMessage, 'Hello, Isolate!');
    }
    ```
    
- `compute`ï¼šè¿™ä¸ªå‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ `Isolate`ï¼Œæ‰§è¡Œç»™å®šçš„å‡½æ•°ï¼Œå¹¶è¿”å›ç»“æœã€‚å½“è®¡ç®—å®Œæˆåï¼Œè¿™ä¸ª `Isolate` ä¼šè¢«è‡ªåŠ¨é”€æ¯ã€‚

- `compute`: `Flutter` æä¾›çš„ä¾¿æ·å‡½æ•°ï¼Œå®ƒåœ¨å†…éƒ¨ä½¿ç”¨ `Isolate`ï¼Œå¹¶è¿”å› `Future`ï¼Œæ‰§è¡Œç»“æŸï¼Œåˆ›å»ºçš„ `Isolate` å°±ä¼šè¢«é”€æ¯ã€‚æ›´é€‚ç”¨äºå¤„ç†å•æ¬¡è€—æ—¶è®¡ç®—ä»»åŠ¡ã€‚
    > ä¾‹å¦‚ä¸€ä¸ªå¤æ‚çš„æ’åºã€è¿‡æ»¤æ“ä½œã€‚
    
    ```dart
    import 'dart:isolate';
    
    int longRunningCalculation(int value) {
      // This could be a CPU-intensive operation that lasts a long time.
      return value * 2;
    }
    
    void main() async {
      int result = await compute(longRunningCalculation, 10);
      print(result);  // Will print: 20
    }
    ```

:::

### â“`Dart` è¿è¡Œæ—¶æ˜¯å¦‚ä½•è¿›è¡Œä»»åŠ¡è°ƒåº¦

::: details ğŸ’¡



:::

### â“`Zone` æ˜¯ä»€ä¹ˆ

::: details ğŸ’¡

> `Zone` æ˜¯ä¸€ä¸ªç”¨äºé”™è¯¯å¤„ç†å’Œä»»åŠ¡è°ƒåº¦çš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥æŠŠ `Zone` ç†è§£ä¸ºä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ç¯å¢ƒã€‚æ¯ä¸ª `Dart` çº¿ç¨‹éƒ½æœ‰ä¸ä¹‹å…³è”çš„ `Zone`ï¼Œå¯ä»¥ä½¿ç”¨ `Zone.current` æ¥è·å–å½“å‰çš„ `Zone`ã€‚
> åœ¨ `Flutter` ä¸­ï¼Œæ–°å»ºçš„æ¯ä¸ª `Isolate` éƒ½ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„ `root Zone`ï¼Œä½†ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„ `Zone`ã€‚`Flutter` æ¡†æ¶çš„ `runApp` æ–¹æ³•å°±æ˜¯åœ¨ `Zone` ä¸­è¿è¡Œçš„ã€‚

`Zone` çš„ä¸»è¦åŠŸèƒ½ï¼š

  - é”™è¯¯å¤„ç†ï¼š`Zone` å¯ä»¥æä¾›ä¸€ä¸ªç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚
    > æ¯”å¦‚ï¼Œå¯ä»¥åœ¨åˆ›å»º `Zone` æ—¶æŒ‡å®šä¸€ä¸ªé”™è¯¯å›è°ƒï¼Œé‚£ä¹ˆåœ¨ `Zone` å†…éƒ¨è¿è¡Œçš„ä»£ç å¦‚æœæœ‰æœªæ•è·çš„å¼‚å¸¸ï¼Œå°±ä¼šè¢«è¿™ä¸ªå›è°ƒæ•è·ã€‚

  - ä»»åŠ¡è°ƒåº¦ï¼š`Zone` è¿˜å¯ä»¥å¯¹ä»»åŠ¡çš„è°ƒåº¦è¿›è¡Œè‡ªå®šä¹‰ã€‚
    > `Dart` ä¸­æœ‰ä¸¤ç§ä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å’Œäº‹ä»¶é˜Ÿåˆ—ã€‚ä½† `Dart` è¿è¡Œæ—¶å¦‚ä½•è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯é€šè¿‡ `Zone`ã€‚`Zone` ä¸ºå¾®ä»»åŠ¡å’Œäº‹ä»¶ä»»åŠ¡çš„è°ƒåº¦æä¾›äº† `hook`ï¼Œå¯ä»¥åœ¨åˆ›å»º `Zone` æ—¶é‡å†™è¿™ä¸¤ä¸ª `hook` æ¥æ”¹å˜ä»»åŠ¡è°ƒåº¦çš„è¡Œä¸ºã€‚

```dart
void main() {
  runZonedGuarded(() {
    // è¿™é‡Œçš„ä»£ç è¿è¡Œåœ¨æ–°çš„ Zone ä¸­
    Future(() {
      throw Exception("æˆ‘æ˜¯ä¸€ä¸ªå¼‚å¸¸");
    });
  }, (Object error, StackTrace stackTrace) {
    // åŒºåŸŸå†…çš„æœªæ•è·å¼‚å¸¸å°†è¢«å¤„ç†åœ¨æ­¤
    print('æ•è·åˆ°å¼‚å¸¸: $error');
  });
}
```

:::

### â“`runZoned` ä¸ `runZonedGuarded` çš„åŒºåˆ«

::: details ğŸ’¡

  - `runZoned`ï¼šå‡½æ•°æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯è¿è¡Œåœ¨æ–°çš„ `Zone` ä¸­çš„å›è°ƒï¼Œå¦ä¸€ä¸ªæ˜¯é”™è¯¯å¤„ç†çš„å›è°ƒã€‚è¿™ä¸ªé”™è¯¯å¤„ç†å›è°ƒå¯ä»¥ç”¨æ¥æ•è·å’Œå¤„ç†åœ¨æ–°çš„ `Zone` ä¸­æŠ›å‡ºçš„æœªæ•è·çš„å¼‚å¸¸ã€‚
    > å¦‚æœæ²¡æœ‰æä¾›é”™è¯¯å¤„ç†å›è°ƒï¼Œæˆ–è€…é”™è¯¯å¤„ç†å›è°ƒæŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸å°†ä¼šè¢«é‡æ–°æŠ›å‡ºï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å´©æºƒã€‚

    ```dart
    runZoned(() {
      throw 'Details';
    }, onError: (error, stackTrace) {
      print('Caught error: $error');
    });
    ```
   
  - `runZonedGuarded`: å‡½æ•°æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä¸€ä¸ªè¿è¡Œåœ¨æ–° `Zone` ä¸­çš„å›è°ƒï¼Œå¦ä¸€ä¸ªé”™è¯¯å¤„ç†å›è°ƒã€‚
    > è¦æ±‚å¿…é¡»æä¾›é”™è¯¯å¤„ç†å›è°ƒï¼Œå¹¶ä¸”è¿™ä¸ªé”™è¯¯å¤„ç†å›è°ƒå¿…é¡»ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ã€‚
    
    ```dart
    runZonedGuarded(() {
      throw 'Details';
    }, (error, stackTrace) {
      print('Caught error: $error');
    });
    ```

  æ€»ç»“ï¼š`runZonedGuarded` æä¾›äº†æ›´å¼ºçš„ä¿æŠ¤æœºåˆ¶ï¼Œä»¥é˜²æ­¢é”™è¯¯å¤„ç†å™¨æŠ›å‡ºå¼‚å¸¸å¯¼è‡´åº”ç”¨å´©æºƒã€‚

:::