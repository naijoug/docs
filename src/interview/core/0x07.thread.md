
---
title: thread - â€œå¤šçº¿ç¨‹â€
icon: hashtag

index: true

---

<!-- more -->

------

## æ¦‚å¿µçŸ¥è¯†

### è¯´è¯´ä½ ç†è§£çš„å¤šçº¿ç¨‹ï¼Ÿ

### è¿›ç¨‹ä¸çº¿ç¨‹

::: details ğŸ’¡

  è¿›ç¨‹ : ç¨‹åºçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨ï¼Œå„ä¸ªè¿›ç¨‹ä¹‹é—´ç›¸äº’èµ„æºç‹¬ç«‹ã€‚æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œå…·æœ‰å”¯ä¸€çš„ PID å’Œ port å·ã€‚
  
  çº¿ç¨‹ : çº¿ç¨‹æ˜¯è¿›ç¨‹çš„æœ€å°æ‰§è¡Œå•ä½ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹å†…çš„èµ„æºã€‚

:::

### åç¨‹ä¸çº¿ç¨‹

::: details ğŸ’¡

  åç¨‹(Coroutine) : ä¹Ÿè¢«ç§°ä¸ºâ€œå¾®çº¿ç¨‹â€ã€‚è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œç›¸æ¯”äºçº¿ç¨‹å…·æœ‰æé«˜çš„æ‰§è¡Œæ•ˆç‡å’Œæä½çš„åˆ‡æ¢æˆæœ¬ã€‚

:::

### å¹¶è¡Œ vs ä¸²è¡Œ

  å¹¶è¡Œ (Concurrency) : å¤šä¸ªä»»åŠ¡ä¼šåŒæ—¶æ‰§è¡Œã€‚å¦‚æœæ˜¯å¤šæ ¸ CPU ä¼šæ˜¯çœŸæ­£æ„ä¹‰ä¸Šå¹¶è¡Œï¼Œå¤šä¸ªä»»åŠ¡ä¼šåœ¨ä¸åŒ CPU ä¸ŠåŒæ—¶è¿è¡Œï¼›å¦‚æœæ˜¯å•æ ¸ CPU æ˜¯ä¸€ç§ä¼ªå¹¶è¡Œï¼Œæ˜¯åŒä¸€æ—¶é—´é—´éš”ä¸Šè¿è¡Œå¤šä¸ªä»»åŠ¡ï¼ŒCPU åœ¨å¤šä¸ªä»»åŠ¡ä¸Šåˆ‡æ¢è¿è¡Œï¼Œå…¶å®æŸä¸€æ—¶åˆ»ä¸Šå…¶å®åªæœ‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œç”±äº CPU è¿è¡Œé€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œç”¨æˆ·è§’åº¦è§‚å¯Ÿå‘ˆç°å¹¶å‘çŠ¶æ€ã€‚

------

## è¿›ç¨‹

### è¿›ç¨‹çš„é€šä¿¡æœºåˆ¶ï¼Ÿ

### è¿›ç¨‹ A å’Œè¿›ç¨‹ B é€šè¿‡ç®¡é“é€šä¿¡çš„è¯æ˜¯åœ¨åŒä¸€ä¸ªç®¡é“ä¹ˆï¼Ÿ

------

## çº¿ç¨‹å®‰å…¨

### ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ 

### çº¿ç¨‹æ­»é”çš„å››ä¸ªæ¡ä»¶ï¼Ÿ

### ä¸»çº¿ç¨‹æ˜¯ç›¸å¯¹äºä»€ä¹ˆè€Œè¨€çš„ï¼Ÿ

### å¸¸è§çš„çº¿ç¨‹åŒæ­¥ç­–ç•¥ï¼Ÿ

- `CAS`

    `CAS`(Compare And Swap) : æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œæ˜¯ä¸€ç§å®ç°åŸå­çš„æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯ä¸€ä¸ªå˜é‡åœ¨è¯»ã€å†™æ—¶çš„åŸå­æ€§ã€‚
    
    åŸºæœ¬åŸç†ï¼šæ¯”è¾ƒä¸‰ä¸ªæ“ä½œæ•°ï¼ŒV (å†…å­˜ä½ç½®å€¼)ã€A (åŸå€¼)ã€B (æ–°å€¼)ï¼Œæ¯”è¾ƒ V ä¸ Aï¼Œå¦‚æœç›¸ç­‰åˆ™å°†æ›´æ–°å†…å­˜ä½ç½®å€¼äº¤æ¢ä¸º Bï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™ä¸åšäº¤æ¢æ“ä½œã€‚æœ€åæ— è®ºæ˜¯å¦è¿›è¡Œäº¤æ¢æ“ä½œï¼Œéƒ½è¿”å›è¯¥ä½ç½®çš„å€¼ã€‚çº¿ç¨‹1 è¯»å–å€¼åï¼Œåœ¨è¿›è¡Œå†™æ—¶ï¼Œå°†è¯»å–çš„å€¼ä¸è¦å†™å…¥å†…å­˜ä½ç½®çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·å¦‚æœçº¿ç¨‹2 åœ¨çº¿ç¨‹1 å†™ä¹‹å‰ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆæ¯”è¾ƒçš„æ—¶å€™å°±ä¼šä¸ç›¸ç­‰ï¼Œä¹Ÿå°±ä¸èƒ½å†™å…¥ä¿è¯äº†åŸå­æ€§ã€‚
  
    `CAS` ä¼šå­˜åœ¨ `ABA` é—®é¢˜ã€‚ä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹2 å…ˆå°† A ä¿®æ”¹ä¸ºäº† Bï¼Œåˆå°† B ä¿®æ”¹ä¸ºäº† Aï¼Œè¿™æ ·çº¿ç¨‹1 å†è¿›è¡Œæ¯”è¾ƒæ—¶è¿˜æ˜¯ç›¸ç­‰ï¼Œä½†æ˜¯å…¶å®æ•°æ®å·²ç»æ˜¯ä¿®æ”¹è¿‡äº†çš„ã€‚è€Œè§£å†³ `ABA` é—®é¢˜æœ€å¸¸è§çš„æ–¹æ¡ˆå°±æ˜¯ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œéƒ½ä¼šåŠ ä¸Šä¸€ä¸ªç‰ˆæœ¬å·ã€‚åŸå§‹ç‰ˆæœ¬å·ä¸º 1ï¼Œè€Œçº¿ç¨‹1 è¯»å–æ•°æ®æ—¶ç‰ˆæœ¬å·ä¸º 1ï¼Œå½“çº¿ç¨‹2 è¿›è¡Œ `ABA` æ•°æ®ä¿®æ”¹åï¼Œç‰ˆæœ¬å·å¢é•¿ä¸ºäº† 3ï¼Œåˆ™çº¿ç¨‹1 å†è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œå°±ä¼šçŸ¥é“ A æ˜¯ä¿®æ”¹åçš„äº†ï¼Œä¹Ÿå°±ä¸èƒ½å†™å…¥ã€‚

### `sqlite` ä¸­çš„è¯»å†™æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ

::: details ğŸ’¡

`SQLite` æœ¬èº«æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯çº¿ç¨‹å®‰å…¨æ€§å–å†³äºåœ¨ç¼–è¯‘ `SQLite` åº“æ—¶çš„è®¾ç½®ã€‚

`SQLite` åœ¨å‡ ä¸ªä¸åŒçš„çº¿ç¨‹å®‰å…¨çº§åˆ«ä¸‹è¿è¡Œï¼Œè¿™å–å†³äºç¼–è¯‘æ—¶çš„é…ç½®é€‰é¡¹ï¼š

- å½“ `SQLite` è¢«ç¼–è¯‘åˆ°éçº¿ç¨‹å®‰å…¨ï¼ˆ`SQLITE_THREADSAFE=0`ï¼‰æ¨¡å¼æ—¶ï¼Œå®ƒä¸å…è®¸å¤šçº¿ç¨‹è®¿é—®ï¼ŒæŸäº›çº¿ç¨‹å®‰å…¨çš„å‡è®¾å°±æ— æ³•ä¿è¯äº†ã€‚

- åœ¨å¤šçº¿ç¨‹æ¨¡å¼ï¼ˆ`SQLITE_THREADSAFE=1`ï¼‰ä¸‹ï¼Œæ ¸å¿ƒ `SQLite` åº“å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶å®‰å…¨è®¿é—®ï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ªä¸åŒçš„æ•°æ®åº“è¿æ¥ã€‚

- å½“ `SQLite` åœ¨åºåˆ—åŒ–æ¨¡å¼ï¼ˆ`SQLITE_THREADSAFE=2`ï¼‰ä¸‹ç¼–è¯‘æ—¶ï¼Œæ ¸å¿ƒ `SQLite` åº“å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¹Ÿèƒ½åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ã€‚

:::

------

## çº¿ç¨‹é”

### â“çº¿ç¨‹é”æœ‰å“ªäº›ï¼Ÿé‚£ä¸ªæ€§èƒ½æœ€å·®ï¼Ÿ

::: details ğŸ’¡

- è¯»å†™é”(read/write-lock)
- äº’æ–¥é”(mutex-lock)
- è‡ªæ—‹é”(spin-lock)
- é€’å½’é”(recursive-lock)

- æ‚²è§‚é”
- ä¹è§‚é”

:::

### å„ç§çš„çº¿ç¨‹é”çš„å¸¸è§ä½¿ç”¨åœºæ™¯ï¼Ÿ

### çº¿ç¨‹é”çš„åº•å±‚å®ç°?

### é”å’Œä¿¡å·é‡çš„å…³ç³»ï¼Ÿ

### ä¿¡å·é‡æœ‰ä»€ä¹ˆåŠŸèƒ½æ˜¯é”åšä¸åˆ°çš„ï¼Ÿ

### å¦‚æœè®©ä½ è®¾è®¡è¯»å†™é”ï¼Œä½ æ€ä¹ˆè®¾è®¡ï¼Ÿ

------

## ç°ä»£åŒ–

### `async/await`

------
  
## çº¿ç¨‹è®¾è®¡
  
### è¿›ç¨‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ

### çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼ï¼Ÿ

### æœ€å¤šèƒ½å¼€è¾Ÿå¤šå°‘ä¸ªè¿›ç¨‹å’Œçº¿ç¨‹ï¼Ÿ
  
### ä¸€ä¸ªçº¿ç¨‹æ‰“å°å¥‡æ•°ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰“å°å¶æ•°ï¼Œæ‰“å° 1~100ï¼Ÿ

### ä¸‰ä¸ªçº¿ç¨‹æŒ‰ç…§é¡ºåºæ‰“å° 0~100ï¼Ÿ

### éœ€è¦è¯·æ±‚200ä¸ªurlï¼Œä¸€æ¬¡æ€§åªèƒ½å‘é€10ä¸ªï¼Œè¯¥æ€ä¹ˆåœ¨æœ€çŸ­çš„æ—¶é—´å†…è¯·æ±‚å®Œï¼Ÿ

> æŒç»­ç»´æŠ¤10ä¸ªå¹¶å‘è¯·æ±‚é˜Ÿåˆ—