---
title: ç±»
icon: hashtag

index: true

---

<!-- more -->

[objc-private.h#L75]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-private.h#L75
[objc-private.h#L76]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-private.h#L76
[objc-private.h#L83]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-private.h#L83
[objc-private.h#L121]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-private.h#L121

[objc-runtime-new.h#L1505]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L1505
[objc-runtime-new.h#L1873]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L1873
[objc-runtime-new.h#L1883]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L1883
[objc-runtime-new.h#L2005]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L2005
[objc-runtime-new.h#L2254]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L2254
[objc-runtime-new.h#L2787]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime-new.h#L2787

[objc-runtime.mm#L204]: https://github.com/apple-oss-distributions/objc4/blob/objc4-876/runtime/objc-runtime.mm#L204

## çœ‹æºç 

### isa
  > [ğŸ‘‰ğŸ»][objc-private.h#L83]

```objc
// objc-private.h#L83
union isa_t {
    isa_t() { }
    isa_t(uintptr_t value) : bits(value) { }

    uintptr_t bits;
private: 
    // Accessing the class requires custom ptrauth operations, so force clients to go through setClass/getClass by making this private.
    Class cls; // è®¿é—®ç±»éœ€è¦è‡ªå®šä¹‰ ptrauth æ“ä½œï¼Œå°†å®ƒè®¾ä¸ºç§æœ‰ï¼Œè¿™æ ·å°±å¯ä»¥å¼ºåˆ¶å®¢æˆ·ç«¯é€šè¿‡ setClass/getClass æ¥è®¿é—®
}
```

### Class
  > [ğŸ‘‰ğŸ»][objc-private.h#L75]

```objc 
// objc-private.h#L75
// ç±»å¯¹è±¡æŒ‡é’ˆ
typedef struct objc_class *Class;   
```

### id
  > [ğŸ‘‰ğŸ»][objc-private.h#L76]

```objc 
// objc-private.h#L76
// å®ä¾‹å¯¹è±¡æŒ‡é’ˆ
typedef struct objc_object *id; 
```

### objc_object
  > [ğŸ‘‰ğŸ»][objc-private.h#L121]

```objc
// objc-private.h#121
// ç±»å®ä¾‹ç»“æ„ä½“å®šä¹‰
struct objc_object { 
private:
    char isa_storage[sizeof(isa_t)];
    // reinterpret_cast : C++ä¸­çš„ä¸€ç§å¼ºåˆ¶ç±»å‹è½¬æ¢è¿ç®—ç¬¦ï¼Œå…è®¸è®²ä»»æ„æŒ‡é’ˆç±»å‹è½¬åŒ–ä¸ºå…¶å®ƒç±»å‹æŒ‡é’ˆ 
    isa_t &isa() { return *reinterpret_cast<isa_t *>(isa_storage); }
    const isa_t &isa() const { return *reinterpret_cast<const isa_t *>(isa_storage); }
}
```

### objc_class
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L2254]

```objc
// objc-runtime-new.h#L2254
// ç±»ç»“æ„ä½“å®šä¹‰
struct objc_class : objc_object {
    // `= delete` : c++ 11 è¯­æ³•ï¼Œç¦æ­¢ç¼–è¯‘å™¨ç”Ÿæˆæ„é€ å‡½æ•°ã€èµ‹å€¼è¿ç®—ç¬¦ï¼Œä¿è¯ objc_class æ“ä½œå®‰å…¨æ€§
    objc_class(const objc_class&) = delete;
    objc_class(objc_class&&) = delete;
    void operator=(const objc_class&) = delete;
    void operator=(objc_class&&) = delete;
    // Class ISA;
    Class superclass;
    cache_t cache;             // formerly cache pointer and vtable         ç¼“å­˜æŒ‡é’ˆå’Œè™šå‡½æ•°è¡¨(ä¼˜åŒ–æ€§èƒ½)
    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags   å­˜æ”¾ç±»æ•°æ®
    
    class_rw_t *data() const { // è·å–ç±»æ•°æ®(å¯è¯»å¯å†™)
        return bits.data();
    }
    const class_ro_t *safe_ro() const { // è·å–çš„å®‰å…¨çš„åªè¯»æ•°æ®
        return bits.safe_ro();
    }
}
```

### objc_getMetaClass
  > [ğŸ‘‰ğŸ»][objc-runtime.mm#L204]

```objc
// objc-runtime.mm#L204
// é€šè¿‡ç±»åè·å– metaClass
/***********************************************************************
* objc_getMetaClass.  Return the id of the meta class the named class.
* Warning: doesn't work if aClassName is the name of a posed-for class's isa!
**********************************************************************/
Class objc_getMetaClass(const char *aClassName)
{
    Class cls;

    if (!aClassName) return Nil;

    cls = objc_getClass (aClassName); // é€šè¿‡ç±»åè·å–ç±»å¯¹è±¡
    if (!cls)
    {
        _objc_inform ("class `%s' not linked into application", aClassName);
        return Nil;
    }

    return cls->ISA(); // è¿”å›æŒ‡å‘ metaClass çš„ isa æŒ‡é’ˆ
}
```

### class_data_bits_t
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L2005]

```objc
// objc-runtime-new.h#L2005
// ç±»æ•°æ®å­˜æ”¾ç»“æ„ä½“
struct class_data_bits_t { 
    friend objc_class;
}
```

### class_ro_t
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L1505]

```objc
// objc-runtime-new.h#L1505
// ç±»åªè¯»ç»“æ„ä½“å®šä¹‰
struct class_ro_t { 
    uint32_t flags;
    uint32_t instanceStart; // å®ä¾‹å†…å­˜å¼€å§‹ä½ç½®
    uint32_t instanceSize;  // å®ä¾‹å†…å­˜å¤§å°
#ifdef __LP64__
    uint32_t reserved;
#endif

    union {
        const uint8_t * ivarLayout;
        Class nonMetaclass;
    };
    // ç±»å
    explicit_atomic<const char *> name;
    // åŸºç¡€çš„æ–¹æ³•åˆ—è¡¨
    objc::PointerUnion<method_list_t, relative_list_list_t<method_list_t>, method_list_t::Ptrauth, method_list_t::Ptrauth> baseMethods;
    // åŸºç¡€çš„åè®®åˆ—è¡¨
    objc::PointerUnion<protocol_list_t, relative_list_list_t<protocol_list_t>, PtrauthRaw, PtrauthRaw> baseProtocols;
    // å®ä¾‹å˜é‡åˆ—è¡¨
    const ivar_list_t * ivars;
    // å¼±å¼•ç”¨å®ä¾‹å˜é‡
    const uint8_t * weakIvarLayout;
    // åŸºç¡€çš„å±æ€§åˆ—è¡¨
    objc::PointerUnion<property_list_t, relative_list_list_t<property_list_t>, PtrauthRaw, PtrauthRaw> baseProperties;
}
```
  
### class_rw_ext_t
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L1873]

```objc
// objc-runtime-new.h#L1873 
// ç±»å¯è¯»å¯å†™æ‰©å±•ç»“æ„ä½“å®šä¹‰
struct class_rw_ext_t { 
    DECLARE_AUTHED_PTR_TEMPLATE(class_ro_t)
    class_ro_t_authed_ptr<const class_ro_t> ro; // æŒ‡å‘åªè¯»ç±»çš„æŒ‡é’ˆ
    method_array_t methods;         // æ–¹æ³•åˆ—è¡¨
    property_array_t properties;    // å±æ€§åˆ—è¡¨ 
    protocol_array_t protocols;     // åè®®åˆ—è¡¨
    const char *demangledName;
    uint32_t version;
};
```
  
### class_rw_t
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L1883]

```objc
// objc-runtime-new.h#L1883
// ç±»å¯è¯»å¯å†™ç»“æ„ä½“å®šä¹‰
struct class_rw_t { 
    // Be warned that Symbolication knows the layout of this structure.
    uint32_t flags;
    uint16_t witness;
#if SUPPORT_INDEXED_ISA
    uint16_t index;
#endif

    explicit_atomic<uintptr_t> ro_or_rw_ext; // åŸå­æ“ä½œæŒ‡é’ˆï¼Œç”¨äºæŒ‡å‘åªè¯»ç±»æˆ–è€…ç±»æ‰©å±•

    Class firstSubclass;    // ç¬¬ä¸€ä¸ªå­ç±»      
    Class nextSiblingClass; // ä¸‹ä¸€ä¸ªå…„å¼Ÿç±»
    
private: // è”åˆæŒ‡é’ˆï¼ŒæŒ‡å‘ class_ro_t æˆ–è€… class_rw_ext_t
    using ro_or_rw_ext_t = objc::PointerUnion<const class_ro_t, class_rw_ext_t, PTRAUTH_STR("class_ro_t"), PTRAUTH_STR("class_rw_ext_t")>;
}
```

### swift_class_t
  > [ğŸ‘‰ğŸ»][objc-runtime-new.h#L2787]

```objc
// objc-runtime-new.h#L2787
struct swift_class_t : objc_class {
    uint32_t flags;
    uint32_t instanceAddressOffset;
    uint32_t instanceSize;
    uint16_t instanceAlignMask;
    uint16_t reserved;

    uint32_t classSize;
    uint32_t classAddressOffset;
    void *description;
    // ...

    void *baseAddress() {
        return (void *)((uint8_t *)this - classAddressOffset);
    }
};
```

## å†™æ€»ç»“

